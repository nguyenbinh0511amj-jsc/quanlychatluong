<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sổ Giao Nhận</title>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://code.jquery.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" as="style">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin-top: 20px;
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .table-responsive {
            margin-top: 20px;
        }
        th.ui-sortable-handle {
            cursor: grab;
        }
        #columnSelection {
            margin-bottom: 15px;
        }
        #messageArea {
            margin-top: 15px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }
        .loading-overlay p {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        .pagination {
            margin-top: 20px;
        }
        .page-size-selection {
            max-width: 150px;
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-container">
        <h2 class="text-center mb-4">Đăng nhập</h2>
        <div id="loginMessage" class="alert d-none" role="alert"></div>
        <form id="loginForm">
            <div class="mb-3">
                <label for="username" class="form-label">Tên đăng nhập:</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Mật khẩu:</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="rememberMe">
                <label class="form-check-label" for="rememberMe">Ghi nhớ đăng nhập</label>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="loginButton">Đăng nhập</button>
        </form>
    </div>

    <div id="mainApp" class="container d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-0">Quản lý Sổ Giao Nhận</h1>
                <p class="mb-0">Chào mừng, <span id="loggedInUserName" class="fw-bold"></span>!</p>
            </div>
            <div>
                <p class="mb-0">Ngày: <span id="currentDate"></span></p>
                <p class="mb-0">Giờ: <span id="currentTime"></span></p>
                <button id="logoutButton" class="btn btn-warning btn-sm mt-2">Đăng xuất</button>
            </div>
        </div>

        <div id="messageArea" class="alert d-none" role="alert"></div>

        <div class="mb-3 d-flex gap-3">
            <div class="flex-grow-1">
                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo Order KD, Tên chi tiết, Code, Họ và tên...">
            </div>
            <div class="page-size-selection">
                <label for="pageSizeSelect" class="form-label">Số dòng mỗi trang:</label>
                <select id="pageSizeSelect" class="form-select">
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                </select>
            </div>
        </div>

        <div id="columnSelection">
            <label class="form-label">Hiển thị cột:</label>
            <div id="columnCheckboxes" class="d-flex flex-wrap gap-3">
            </div>
        </div>

        <div class="d-flex justify-content-between mb-3">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">
                <i class="bi bi-plus-circle"></i> Thêm mới
            </button>
            <button class="btn btn-info" id="exportExcelButton">
                <i class="bi bi-file-earmark-excel"></i> Xuất Excel
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped" id="dataTable">
                <thead>
                    <tr id="tableHeaders">
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <nav class="pagination">
            <ul class="pagination justify-content-center">
                <li class="page-item"><a class="page-link" href="#" id="prevPage">Trước</a></li>
                <li class="page-item"><span class="page-link" id="pageInfo"></span></li>
                <li class="page-item"><a class="page-link" href="#" id="nextPage">Sau</a></li>
            </ul>
        </nav>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addModalLabel">Thêm mới Sổ Giao Nhận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="addFormMessage" class="alert d-none" role="alert"></div>
                    <form id="addForm">
                        <div class="mb-3">
                            <label for="add_order_kd" class="form-label">Order KD <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="add_order_kd" required>
                        </div>
                        <div class="mb-3">
                            <label for="add_ten_chi_tiet" class="form-label">Tên chi tiết <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="add_ten_chi_tiet" required>
                        </div>
                        <div class="mb-3">
                            <label for="add_so_file" class="form-label">Số file</label>
                            <input type="text" class="form-control" id="add_so_file">
                        </div>
                        <div class="mb-3">
                            <label for="add_sll" class="form-label">SLL</label>
                            <input type="number" class="form-control" id="add_sll">
                        </div>
                        <div class="mb-3">
                            <label for="add_tinh_chat" class="form-label">Tính chất</label>
                            <input type="text" class="form-control" id="add_tinh_chat">
                        </div>
                        <div class="mb-3">
                            <label for="add_ghi_chu" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="add_ghi_chu" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="add_noi_gia_cong" class="form-label">Nơi gia công</label>
                            <input type="text" class="form-control" id="add_noi_gia_cong">
                        </div>
                        <div class="mb-3">
                            <label for="add_thoi_han" class="form-label">Thời hạn</label>
                            <input type="date" class="form-control" id="add_thoi_han">
                        </div>
                        <div class="mb-3">
                            <label for="add_ngay_nhan" class="form-label">Ngày nhận</label>
                            <input type="date" class="form-control" id="add_ngay_nhan" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="add_gio_nhan" class="form-label">Giờ nhận</label>
                            <input type="time" class="form-control" id="add_gio_nhan" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="add_tap_tho" class="form-label">Tập thợ</label>
                            <input type="text" class="form-control" id="add_tap_tho">
                        </div>
                        <div class="mb-3">
                            <label for="add_sl_nhan" class="form-label">SL nhận</label>
                            <input type="number" class="form-control" id="add_sl_nhan">
                        </div>
                        <div class="mb-3">
                            <label for="add_code" class="form-label">Code</label>
                            <input type="text" class="form-control" id="add_code">
                        </div>
                        <div class="mb-3">
                            <label for="add_ho_va_ten" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="add_ho_va_ten" readonly>
                        </div>
                        <button type="submit" class="btn btn-primary" id="saveNewRecordButton">Lưu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Sửa Sổ Giao Nhận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="editFormMessage" class="alert d-none" role="alert"></div>
                    <form id="editForm">
                        <input type="hidden" id="edit_row_number">
                        <div class="mb-3">
                            <label for="edit_order_kd" class="form-label">Order KD <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_order_kd" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_ten_chi_tiet" class="form-label">Tên chi tiết <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_ten_chi_tiet" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_so_file" class="form-label">Số file</label>
                            <input type="text" class="form-control" id="edit_so_file">
                        </div>
                        <div class="mb-3">
                            <label for="edit_sll" class="form-label">SLL</label>
                            <input type="number" class="form-control" id="edit_sll">
                        </div>
                        <div class="mb-3">
                            <label for="edit_tinh_chat" class="form-label">Tính chất</label>
                            <input type="text" class="form-control" id="edit_tinh_chat">
                        </div>
                        <div class="mb-3">
                            <label for="edit_ghi_chu" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="edit_ghi_chu" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit_noi_gia_cong" class="form-label">Nơi gia công</label>
                            <input type="text" class="form-control" id="edit_noi_gia_cong">
                        </div>
                        <div class="mb-3">
                            <label for="edit_thoi_han" class="form-label">Thời hạn</label>
                            <input type="date" class="form-control" id="edit_thoi_han">
                        </div>
                        <div class="mb-3">
                            <label for="edit_ngay_nhan" class="form-label">Ngày nhận</label>
                            <input type="date" class="form-control" id="edit_ngay_nhan">
                        </div>
                        <div class="mb-3">
                            <label for="edit_gio_nhan" class="form-label">Giờ nhận</label>
                            <input type="time" class="form-control" id="edit_gio_nhan">
                        </div>
                        <div class="mb-3">
                            <label for="edit_tap_tho" class="form-label">Tập thợ</label>
                            <input type="text" class="form-control" id="edit_tap_tho">
                        </div>
                        <div class="mb-3">
                            <label for="edit_sl_nhan" class="form-label">SL nhận</label>
                            <input type="number" class="form-control" id="edit_sl_nhan">
                        </div>
                        <div class="mb-3">
                            <label for="edit_code" class="form-label">Code</label>
                            <input type="text" class="form-control" id="edit_code">
                        </div>
                        <div class="mb-3">
                            <label for="edit_ho_va_ten" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="edit_ho_va_ten">
                        </div>
                        <button type="submit" class="btn btn-primary" id="saveEditRecordButton">Lưu thay đổi</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Xác nhận xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn xóa bản ghi này không?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <p id="loadingMessage">Đang tải...</p>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script>
        // CONFIGURATION
        const CONFIG = {
            appId: 'e1339939-5987-4d7a-8c73-436348abf6b7',
            accessKey: 'V2-WTcys-x7QFl-Z5SzF-zSe7D-qciuV-yaUHk-CDGEe-oSexL',
            tableName: 'so_giao_nhan',
            employeeTableName: 'nhan_vien',
            maxRetries: 3,
            retryDelay: 1000,
            pageSizeOptions: [50, 100, 200, 500],
            defaultPageSize: 50
        };

        const BASE_URL = `https://api.appsheet.com/api/v2/apps/${CONFIG.appId}/tables/`;

        let originalData = [];
        let currentData = [];
        let columnOrder = ['order_kd', 'ten_chi_tiet', 'so_file', 'sll', 'tinh_chat', 'ghi_chu', 'noi_gia_cong', 'thoi_han', 'ngay_nhan', 'gio_nhan', 'tap_tho', 'sl_nhan', 'code', 'ho_va_ten', 'Actions'];
        let columnVisibility = {
            'order_kd': true,
            'ten_chi_tiet': true,
            'so_file': true,
            'sll': true,
            'tinh_chat': true,
            'ghi_chu': true,
            'noi_gia_cong': true,
            'thoi_han': true,
            'ngay_nhan': true,
            'gio_nhan': true,
            'tap_tho': true,
            'sl_nhan': true,
            'code': false,
            'ho_va_ten': true,
            'Actions': true
        };
        let loggedInUser = null;
        let currentPage = 1;
        let pageSize = parseInt(localStorage.getItem('pageSize')) || CONFIG.defaultPageSize;

        // --- Utility Functions ---
        function showLoading(message = 'Đang tải...') {
            $('#loadingMessage').text(message);
            $('#loadingOverlay').removeClass('d-none');
        }

        function hideLoading() {
            $('#loadingOverlay').addClass('d-none');
        }

        function showAlert(message, type = 'danger', target = '#messageArea') {
            const alertDiv = $(target);
            alertDiv.text(message).removeClass('d-none alert-success alert-danger alert-info').addClass(`alert-${type}`);
            if (target === '#messageArea') {
                setTimeout(() => alertDiv.addClass('d-none'), 5000);
            }
        }

        function clearAlert(target = '#messageArea') {
            $(target).addClass('d-none').text('');
        }

        async function makeAppSheetRequest(url, method, data, retries = 0) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': CONFIG.accessKey
                    },
                    body: data ? JSON.stringify(data) : null
                };

                console.log(`Sending request to ${url}:`, options);

                const response = await fetch(url, options);
                let responseData;
                try {
                    responseData = await response.json();
                } catch (jsonError) {
                    const rawText = await response.text();
                    console.error('Lỗi phân tích JSON:', jsonError);
                    console.error('Phản hồi API thô:', rawText);
                    throw new Error(`Định dạng phản hồi API không hợp lệ. Raw: "${rawText.substring(0, 100)}..."`);
                }

                console.log('API response:', responseData);

                if (!response.ok) {
                    if (retries < CONFIG.maxRetries) {
                        console.warn(`Yêu cầu thất bại. Thử lại... (${retries + 1}/${CONFIG.maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, CONFIG.retryDelay));
                        return makeAppSheetRequest(url, method, data, retries + 1);
                    }
                    console.error('Lỗi API AppSheet:', responseData);
                    let errorMessage = 'Lỗi không xác định khi giao tiếp với AppSheet.';
                    if (responseData && responseData.Message) {
                        errorMessage = responseData.Message;
                    } else if (response.status === 401) {
                        errorMessage = 'Lỗi xác thực: Khóa truy cập không hợp lệ hoặc thiếu.';
                    } else if (response.status === 404) {
                        errorMessage = 'Không tìm thấy bảng hoặc ứng dụng. Vui lòng kiểm tra App ID và tên bảng.';
                    } else if (responseData && responseData.Code === 'BadData') {
                        errorMessage = `Lỗi dữ liệu: ${responseData.Message || 'Dữ liệu không hợp lệ.'}`;
                    } else {
                        errorMessage = `Lỗi API AppSheet (${response.status}): ${JSON.stringify(responseData)}`;
                    }
                    throw new Error(errorMessage);
                }
                return responseData;
            } catch (error) {
                console.error('Lỗi Fetch:', error);
                throw error;
            }
        }

        // --- Authentication ---
        async function authenticateUser(username, password) {
            showLoading('Đang xác thực...');
            clearAlert('#loginMessage');

            if (!username || !password) {
                showAlert('Vui lòng nhập đầy đủ tên đăng nhập và mật khẩu.', 'danger', '#loginMessage');
                hideLoading();
                return;
            }

            try {
                const requestBody = {
                    "Action": "Find",
                    "Properties": {
                        "Locale": "en-US",
                        "Location": "47.620921, -122.347276",
                        "Timezone": "Pacific Standard Time"
                    },
                    "Rows": [
                        { "ho_va_ten": username, "code": password }
                    ]
                };

                console.log('Sending authentication request to AppSheet:', requestBody);

                const employees = await makeAppSheetRequest(`${BASE_URL}${CONFIG.employeeTableName}/Action`, 'POST', requestBody);

                console.log('Authentication response:', employees);

                if (employees && Array.isArray(employees) && employees.length > 0) {
                    loggedInUser = employees[0];
                    $('#loggedInUserName').text(loggedInUser.ho_va_ten || 'Người dùng');
                    $('#loginScreen').addClass('d-none');
                    $('#mainApp').removeClass('d-none');
                    if ($('#rememberMe').is(':checked')) {
                        localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                    } else {
                        localStorage.removeItem('loggedInUser');
                    }
                    startClock();
                    await fetchData();
                } else {
                    showAlert('Sai tên đăng nhập hoặc mật khẩu. Vui lòng kiểm tra lại thông tin.', 'danger', '#loginMessage');
                    loggedInUser = null;
                }
            } catch (error) {
                console.error('Authentication error details:', error);
                let errorMessage = `Lỗi đăng nhập: ${error.message}`;
                if (error.message.includes('404')) {
                    errorMessage = 'Không tìm thấy bảng "nhan_vien". Vui lòng kiểm tra tên bảng trong AppSheet.';
                } else if (error.message.includes('401')) {
                    errorMessage = 'Lỗi xác thực: App ID hoặc Access Key không hợp lệ. Vui lòng kiểm tra cấu hình.';
                } else if (error.message.includes('BadData')) {
                    errorMessage = 'Dữ liệu không hợp lệ. Vui lòng kiểm tra cột "ho_va_ten" và "code" trong bảng nhan_vien.';
                }
                showAlert(errorMessage, 'danger', '#loginMessage');
            } finally {
                hideLoading();
            }
        }

        function logout() {
            loggedInUser = null;
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('so_giao_nhan_cache');
            localStorage.removeItem('pageSize');
            $('#mainApp').addClass('d-none');
            $('#loginScreen').removeClass('d-none');
            $('#password').val('');
            clearAlert();
            clearAlert('#loginMessage');
            clearInterval(clockInterval);
        }

        // --- Data Fetching ---
        async function fetchData() {
            showLoading('Đang tải dữ liệu...');
            clearAlert();

            // Check localStorage for cached data
            const cachedData = localStorage.getItem('so_giao_nhan_cache');
            if (cachedData) {
                try {
                    const parsedData = JSON.parse(cachedData);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        originalData = parsedData;
                        currentData = originalData;
                        currentPage = 1;
                        initializeColumns();
                        renderTableWithPagination(currentData);
                        showAlert('Tải dữ liệu từ bộ nhớ đệm.', 'info');
                        // Fetch fresh data in background
                        fetchFreshData();
                        return;
                    } else {
                        console.warn('Dữ liệu bộ nhớ đệm không hợp lệ, xóa và tải mới.');
                        localStorage.removeItem('so_giao_nhan_cache');
                    }
                } catch (e) {
                    console.error('Lỗi phân tích dữ liệu bộ nhớ đệm:', e);
                    localStorage.removeItem('so_giao_nhan_cache');
                }
            }

            await fetchFreshData();
        }

        async function fetchFreshData() {
            try {
                const actionRequestBody = {
                    "Action": "Find",
                    "Properties": {
                        "Locale": "en-US",
                        "Location": "47.620921, -122.347276",
                        "Timezone": "Pacific Standard Time"
                    }
                };
                console.log('Fetching data from so_giao_nhan:', actionRequestBody);
                const data = await makeAppSheetRequest(`${BASE_URL}${CONFIG.tableName}/Action`, 'POST', actionRequestBody);

                if (data && Array.isArray(data)) {
                    if (data.length > 0) {
                        originalData = data;
                        currentData = data;
                        currentPage = 1;
                        localStorage.setItem('so_giao_nhan_cache', JSON.stringify(data));
                        initializeColumns();
                        renderTableWithPagination(currentData);
                        showAlert('Tải dữ liệu thành công!', 'success');
                    } else {
                        originalData = [];
                        currentData = [];
                        renderTableWithPagination([]);
                        initializeColumns();
                        showAlert('Bảng so_giao_nhan không có dữ liệu.', 'info');
                    }
                } else {
                    throw new Error('Phản hồi API không phải là mảng dữ liệu.');
                }
            } catch (error) {
                console.error('Lỗi tải dữ liệu:', error);
                let errorMessage = `Lỗi khi tải dữ liệu: ${error.message}`;
                if (error.message.includes('404')) {
                    errorMessage = 'Không tìm thấy bảng "so_giao_nhan". Vui lòng kiểm tra tên bảng trong AppSheet.';
                } else if (error.message.includes('401')) {
                    errorMessage = 'Lỗi xác thực: App ID hoặc Access Key không hợp lệ. Vui lòng kiểm tra cấu hình.';
                } else if (error.message.includes('BadData')) {
                    errorMessage = 'Dữ liệu không hợp lệ. Vui lòng kiểm tra cấu trúc bảng so_giao_nhan.';
                }
                showAlert(errorMessage, 'danger');
                localStorage.removeItem('so_giao_nhan_cache');
                originalData = [];
                currentData = [];
                renderTableWithPagination([]);
            } finally {
                hideLoading();
            }
        }

        // --- Column Management ---
        function initializeColumns() {
            // Set default page size from localStorage or CONFIG
            $('#pageSizeSelect').val(pageSize);
            renderColumnCheckboxes();
            renderTableHeaders();
        }

        function renderColumnCheckboxes() {
            const $checkboxes = $('#columnCheckboxes');
            $checkboxes.empty();
            columnOrder.forEach(col => {
                const displayName = getColumnDisplayName(col);
                const isChecked = columnVisibility[col] ? 'checked' : '';
                $checkboxes.append(`
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle_${col}" data Automotive-column="${col}" ${isChecked}>
                        <label class="form-check-label" for="toggle_${col}">${displayName}</label>
                    </div>
                `);
            });

            $('.column-toggle').off('change').on('change', function() {
                const column = $(this).data('column');
                columnVisibility[column] = $(this).is(':checked');
                renderTableHeaders();
                renderTableWithPagination(currentData);
            });
        }

        function renderTableHeaders() {
            const $headers = $('#tableHeaders');
            $headers.empty();
            const visibleColumns = columnOrder.filter(col => columnVisibility[col]);
            visibleColumns.forEach(col => {
                const displayName = getColumnDisplayName(col);
                $headers.append(`<th data-column="${col}">${displayName}</th>`);
            });

            $headers.sortable({
                items: 'th:not(:last-child)',
                axis: 'x',
                update: function(event, ui) {
                    const newOrder = [];
                    $('#tableHeaders th').each(function() {
                        newOrder.push($(this).data('column'));
                    });
                    columnOrder = newOrder;
                    renderColumnCheckboxes();
                    renderTableWithPagination(currentData);
                }
            });
            $headers.disableSelection();
        }

        function getColumnDisplayName(columnName) {
            const displayNames = {
                'order_kd': 'Order KD',
                'ten_chi_tiet': 'Tên chi tiết',
                'so_file': 'Số file',
                'sll': 'SLL',
                'tinh_chat': 'Tính chất',
                'ghi_chu': 'Ghi chú',
                'noi_gia_cong': 'Nơi gia công',
                'thoi_han': 'Thời hạn',
                'ngay_nhan': 'Ngày nhận',
                'gio_nhan': 'Giờ nhận',
                'tap_tho': 'Tập thợ',
                'sl_nhan': 'SL nhận',
                'code': 'Code',
                'ho_va_ten': 'Họ và tên',
                'Actions': 'Thao tác'
            };
            return displayNames[columnName] || columnName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        // --- Table Rendering with Pagination ---
        function renderTableWithPagination(data) {
            const $tbody = $('#tableBody');
            $tbody.empty();

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedData = data.slice(start, end);

            if (paginatedData.length === 0) {
                $tbody.append(`<tr><td colspan="${columnOrder.filter(col => columnVisibility[col]).length}" class="text-center">Không tìm thấy dữ liệu phù hợp.</td></tr>`);
            } else {
                const fragment = document.createDocumentFragment();
                paginatedData.forEach(row => {
                    const tr = document.createElement('tr');
                    columnOrder.forEach(col => {
                        if (columnVisibility[col]) {
                            const td = document.createElement('td');
                            if (col === 'Actions') {
                                td.innerHTML = `
                                    <button class="btn btn-primary btn-sm edit-btn" data-id="${row._RowNumber}">Sửa</button>
                                    <button class="btn btn-danger btn-sm delete-btn" data-id="${row._RowNumber}">Xóa</button>
                                `;
                            } else {
                                let cellValue = row[col] !== undefined && row[col] !== null ? row[col] : '';
                                if (col === 'ngay_nhan' || col === 'thoi_han') {
                                    try {
                                        const date = new Date(cellValue);
                                        if (!isNaN(date)) {
                                            cellValue = date.toLocaleDateString('vi-VN');
                                        }
                                    } catch (e) {
                                        // Keep original value if date parsing fails
                                    }
                                }
                                td.textContent = cellValue;
                            }
                            tr.appendChild(td);
                        }
                    });
                    fragment.appendChild(tr);
                });
                $tbody[0].appendChild(fragment);
            }

            // Update pagination controls
            const totalPages = Math.ceil(data.length / pageSize);
            $('#pageInfo').text(`Trang ${currentPage} / ${totalPages}`);
            $('#prevPage').parent().toggleClass('disabled', currentPage === 1);
            $('#nextPage').parent().toggleClass('disabled', currentPage === totalPages);

            $('.edit-btn').off('click').on('click', function() {
                const rowId = $(this).data('id');
                populateEditModal(rowId);
            });

            $('.delete-btn').off('click').on('click', function() {
                const rowId = $(this).data('id');
                $('#confirmDeleteButton').data('id', rowId);
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                deleteModal.show();
            });
        }

        // --- Pagination Controls ---
        $('#prevPage').on('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                renderTableWithPagination(currentData);
            }
        });

        $('#nextPage').on('click', function(e) {
            e.preventDefault();
            if (currentPage < Math.ceil(currentData.length / pageSize)) {
                currentPage++;
                renderTableWithPagination(currentData);
            }
        });

        // --- Page Size Selection ---
        $('#pageSizeSelect').on('change', function() {
            pageSize = parseInt($(this).val());
            localStorage.setItem('pageSize', pageSize);
            currentPage = 1;
            renderTableWithPagination(currentData);
        });

        // --- Search Functionality ---
        $('#searchInput').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            if (searchTerm === '') {
                currentData = originalData;
            } else {
                currentData = originalData.filter(row =>
                    (row['order_kd'] && row['order_kd'].toLowerCase().includes(searchTerm)) ||
                    (row.ten_chi_tiet && row.ten_chi_tiet.toLowerCase().includes(searchTerm)) ||
                    (row.code && row.code.toLowerCase().includes(searchTerm)) ||
                    (row.ho_va_ten && row.ho_va_ten.toLowerCase().includes(searchTerm))
                );
            }
            currentPage = 1;
            renderTableWithPagination(currentData);
        });

        // --- Add Record ---
        $('#addModal').on('show.bs.modal', function() {
            clearAlert('#addFormMessage');
            $('#addForm')[0].reset();
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);

            $('#add_ngay_nhan').val(today);
            $('#add_gio_nhan').val(currentTime);
            if (loggedInUser) {
                $('#add_ho_va_ten').val(loggedInUser.ho_va_ten || '');
            }
        });

        $('#addForm').on('submit', async function(e) {
            e.preventDefault();
            showLoading('Đang thêm dữ liệu...');
            clearAlert('#addFormMessage');

            const newRecord = {
                "order_kd": $('#add_order_kd').val(),
                "ten_chi_tiet": $('#add_ten_chi_tiet').val(),
                "so_file": $('#add_so_file').val(),
                "sll": parseInt($('#add_sll').val()) || null,
                "tinh_chat": $('#add_tinh_chat').val(),
                "ghi_chu": $('#add_ghi_chu').val(),
                "noi_gia_cong": $('#add_noi_gia_cong').val(),
                "thoi_han": $('#add_thoi_han').val(),
                "ngay_nhan": $('#add_ngay_nhan').val(),
                "gio_nhan": $('#add_gio_nhan').val(),
                "tap_tho": $('#add_tap_tho').val(),
                "sl_nhan": parseInt($('#add_sl_nhan').val()) || null,
                "code": $('#add_code').val(),
                "ho_va_ten": $('#add_ho_va_ten').val()
            };

            if (!newRecord["order_kd"] || !newRecord.ten_chi_tiet) {
                showAlert('Vui lòng điền đầy đủ các trường bắt buộc (Order KD, Tên chi tiết).', 'danger', '#addFormMessage');
                hideLoading();
                return;
            }

            if (originalData.some(record => record['order_kd'] === newRecord['order_kd'])) {
                showAlert('Order KD này đã tồn tại. Vui lòng nhập Order KD khác.', 'danger', '#addFormMessage');
                hideLoading();
                return;
            }

            try {
                await makeAppSheetRequest(`${BASE_URL}${CONFIG.tableName}/Action`, 'POST', {
                    "Action": "Add",
                    "Properties": {
                        "Locale": "en-US",
                        "Location": "47.620921, -122.347276",
                        "Timezone": "Pacific Standard Time"
                    },
                    "Rows": [newRecord]
                });
                showAlert('Thêm mới bản ghi thành công!', 'success');
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
                if (addModal) addModal.hide();
                localStorage.removeItem('so_giao_nhan_cache');
                await fetchData();
            } catch (error) {
                showAlert(`Lỗi khi thêm mới: ${error.message}`, 'danger', '#addFormMessage');
            } finally {
                hideLoading();
            }
        });

        // --- Edit Record ---
        function populateEditModal(rowNumber) {
            clearAlert('#editFormMessage');
            const recordToEdit = originalData.find(record => record._RowNumber === rowNumber);
            if (recordToEdit) {
                $('#edit_row_number').val(recordToEdit._RowNumber);
                $('#edit_order_kd').val(recordToEdit['order_kd'] || '');
                $('#edit_ten_chi_tiet').val(recordToEdit.ten_chi_tiet || '');
                $('#edit_so_file').val(recordToEdit.so_file || '');
                $('#edit_sll').val(recordToEdit.sll || '');
                $('#edit_tinh_chat').val(recordToEdit.tinh_chat || '');
                $('#edit_ghi_chu').val(recordToEdit.ghi_chu || '');
                $('#edit_noi_gia_cong').val(recordToEdit.noi_gia_cong || '');
                $('#edit_thoi_han').val(recordToEdit.thoi_han ? new Date(recordToEdit.thoi_han).toISOString().split('T')[0] : '');
                $('#edit_ngay_nhan').val(recordToEdit.ngay_nhan ? new Date(recordToEdit.ngay_nhan).toISOString().split('T')[0] : '');
                $('#edit_gio_nhan').val(recordToEdit.gio_nhan || '');
                $('#edit_tap_tho').val(recordToEdit.tap_tho || '');
                $('#edit_sl_nhan').val(recordToEdit.sl_nhan || '');
                $('#edit_code').val(recordToEdit.code || '');
                $('#edit_ho_va_ten').val(recordToEdit.ho_va_ten || '');

                const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                editModal.show();
            } else {
                showAlert('Không tìm thấy bản ghi để sửa.', 'danger');
            }
        }

        $('#editForm').on('submit', async function(e) {
            e.preventDefault();
            showLoading('Đang lưu thay đổi...');
            clearAlert('#editFormMessage');

            const rowNumber = $('#edit_row_number').val();
            const originalRecord = originalData.find(r => r._RowNumber == rowNumber);
            const originalOrderKd = originalRecord ? originalRecord['order_kd'] : null;

            const updatedRecord = {
                "_RowNumber": parseInt(rowNumber),
                "order_kd": $('#edit_order_kd').val(),
                "ten_chi_tiet": $('#edit_ten_chi_tiet').val(),
                "so_file": $('#edit_so_file').val(),
                "sll": parseInt($('#edit_sll').val()) || null,
                "tinh_chat": $('#edit_tinh_chat').val(),
                "ghi_chu": $('#edit_ghi_chu').val(),
                "noi_gia_cong": $('#edit_noi_gia_cong').val(),
                "thoi_han": $('#edit_thoi_han').val(),
                "ngay_nhan": $('#edit_ngay_nhan').val(),
                "gio_nhan": $('#edit_gio_nhan').val(),
                "tap_tho": $('#edit_tap_tho').val(),
                "sl_nhan": parseInt($('#edit_sl_nhan').val()) || null,
                "code": $('#edit_code').val(),
                "ho_va_ten": $('#edit_ho_va_ten').val()
            };

            if (!updatedRecord["order_kd"] || !updatedRecord.ten_chi_tiet) {
                showAlert('Vui lòng điền đầy đủ các trường bắt buộc (Order KD, Tên chi tiết).', 'danger', '#editFormMessage');
                hideLoading();
                return;
            }

            if (updatedRecord['order_kd'] !== originalOrderKd &&
                originalData.some(record => record['order_kd'] === updatedRecord['order_kd'])) {
                showAlert('Order KD này đã tồn tại cho một bản ghi khác. Vui lòng nhập Order KD khác.', 'danger', '#editFormMessage');
                hideLoading();
                return;
            }

            try {
                await makeAppSheetRequest(`${BASE_URL}${CONFIG.tableName}/Action`, 'POST', {
                    "Action": "Edit",
                    "Properties": {
                        "Locale": "en-US",
                        "Location": "47.620921, -122.347276",
                        "Timezone": "Pacific Standard Time"
                    },
                    "Rows": [updatedRecord]
                });
                showAlert('Cập nhật bản ghi thành công!', 'success');
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                if (editModal) editModal.hide();
                localStorage.removeItem('so_giao_nhan_cache');
                await fetchData();
            } catch (error) {
                showAlert(`Lỗi khi cập nhật: ${error.message}`, 'danger', '#editFormMessage');
            } finally {
                hideLoading();
            }
        });

        // --- Delete Record ---
        $('#confirmDeleteButton').on('click', async function() {
            showLoading('Đang xóa dữ liệu...');
            clearAlert();
            const rowId = $(this).data('id');
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            if (deleteModal) deleteModal.hide();

            try {
                await makeAppSheetRequest(`${BASE_URL}${CONFIG.tableName}/Action`, 'POST', {
                    "Action": "Delete",
                    "Properties": {
                        "Locale": "en-US",
                        "Location": "47.620921, -122.347276",
                        "Timezone": "Pacific Standard Time"
                    },
                    "Rows": [{ "_RowNumber": rowId }]
                });
                showAlert('Xóa bản ghi thành công!', 'success');
                localStorage.removeItem('so_giao_nhan_cache');
                await fetchData();
            } catch (error) {
                showAlert(`Lỗi khi xóa: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        });

        // --- Excel Export ---
        $('#exportExcelButton').on('click', function() {
            showLoading('Đang xuất Excel...');
            try {
                if (currentData.length === 0) {
                    showAlert('Không có dữ liệu để xuất.', 'info');
                    hideLoading();
                    return;
                }

                const visibleColumns = columnOrder.filter(col => columnVisibility[col] && col !== 'Actions');
                const exportData = currentData.map(row => {
                    const obj = {};
                    visibleColumns.forEach(col => {
                        let cellValue = row[col] !== undefined && row[col] !== null ? row[col] : '';
                        if (col === 'ngay_nhan' || col === 'thoi_han') {
                            try {
                                const date = new Date(cellValue);
                                if (!isNaN(date)) {
                                    cellValue = date.toLocaleDateString('vi-VN');
                                }
                            } catch (e) {
                                // Keep original value if date parsing fails
                            }
                        }
                        obj[getColumnDisplayName(col)] = cellValue;
                    });
                    return obj;
                });

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sổ Giao Nhận");

                const now = new Date();
                const exportDateTime = now.toLocaleString('vi-VN');
                const exporter = loggedInUser ? loggedInUser.ho_va_ten : 'Unknown';

                const footerData = [
                    [''],
                    ['Thông tin xuất:'],
                    ['Ngày xuất:', exportDateTime],
                    ['Người xuất:', exporter]
                ];

                const currentRow = ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']).e.r + 2 : 0;
                XLSX.utils.sheet_add_aoa(ws, footerData, { origin: currentRow });

                XLSX.writeFile(wb, "So_Giao_Nhan_Export.xlsx");
                showAlert('Xuất Excel thành công!', 'success');
            } catch (error) {
                showAlert(`Lỗi khi xuất Excel: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        });

        // --- Clock and Date ---
        let clockInterval;
        function updateClock() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            $('#currentDate').text(now.toLocaleDateString('vi-VN', dateOptions));
            $('#currentTime').text(now.toLocaleTimeString('vi-VN', timeOptions));
        }

        function startClock() {
            updateClock();
            clockInterval = setInterval(updateClock, 1000);
        }

        // --- Event Listeners and Initial Load ---
        $(document).ready(function() {
            const rememberedUser = localStorage.getItem('loggedInUser');
            if (rememberedUser) {
                loggedInUser = JSON.parse(rememberedUser);
                $('#username').val(loggedInUser.ho_va_ten || '');
            }

            $('#loginForm').on('submit', function(e) {
                e.preventDefault();
                authenticateUser($('#username').val(), $('#password').val());
            });

            $('#logoutButton').on('click', logout);

            if (!loggedInUser) {
                $('#loginScreen').removeClass('d-none');
                $('#mainApp').addClass('d-none');
            } else {
                $('#loginScreen').removeClass('d-none');
                $('#mainApp').addClass('d-none');
                $('#password').focus();
            }
        });
    </script>
</body>
</html>
