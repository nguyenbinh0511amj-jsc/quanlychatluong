<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XÁC NHẬN KẾ HOẠCH</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        * {
            font-family: 'Times New Roman', Times, serif;
            box-sizing: border-box;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        }

        .input-field {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .select-field {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .select-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .date-range-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-range-group .input-field {
            flex: 1;
            min-width: 0;
        }

        .date-range-separator {
            color: #6b7280;
            font-weight: 500;
            white-space: nowrap;
            font-size: 12px;
        }

        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .stats-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .stats-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stats-value {
            font-size: 24px;
            font-weight: bold;
            color: #111827;
        }

        .table-container {
            overflow: auto;
            max-height: 80vh;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            min-width: 1800px;
            border-collapse: collapse;
            font-size: 10px;
        }

        th,
        td {
            border: 1px solid #d1d5db;
            padding: 8px 4px;
            text-align: center;
            vertical-align: middle;
        }

        th {
            background: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 11px;
            font-weight: 600;
        }

        tbody tr:hover {
            background-color: #f9fafb;
        }

        tbody tr.selected {
            background-color: #dbeafe;
        }

        .checkbox-custom {
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .pagination button:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .pagination button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr !important;
            }

            .header-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .header-actions .btn {
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .date-range-group {
                flex-direction: column;
                align-items: stretch;
            }

            .date-range-separator {
                text-align: center;
                padding: 4px 0;
            }
        }

        /* Màu cho các cột đặc biệt */
        .xac-nhan-cu-col {
            background-color: #ffeb3b !important;
        }

        .xac-nhan-moi-col {
            background-color: #ffa726 !important;
        }

        /* .ok-status {
            color: #16a34a;
            font-weight: bold;
        } */

        .hbv-status {
            color: #dc2626;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="mx-auto px-6 py-6">
            <!-- Title Section -->
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                <div class="flex items-center space-x-4">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-3 rounded-xl text-white shadow-lg">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">XÁC NHẬN KẾ HOẠCH</h1>
                        <p class="text-sm text-gray-500 mt-1" id="currentDate"></p>
                    </div>
                </div>

                <div class="header-actions">
                    <button id="selectAllBtn" class="btn btn-secondary">
                        <i class="fas fa-check-square"></i>
                        Chọn tất cả trang
                    </button>
                    <button id="selectAllFilteredBtn" class="btn btn-secondary">
                        <i class="fas fa-check-double"></i>
                        Chọn tất cả lọc (<span id="filteredCount">0</span>)
                    </button>
                    <button id="clearSelectionBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Bỏ chọn
                    </button>
                    <button id="exportExcelBtn" class="btn btn-primary">
                        <i class="fas fa-file-excel"></i>
                        Xuất Excel (<span id="selectedCountExcel">0</span>)
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="bg-gray-50 rounded-xl p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6 filters-grid">
                    <!-- Search -->
                    <div class="filter-group lg:col-span-2">
                        <label class="filter-label">Tìm kiếm</label>
                        <input type="text" placeholder="Order KD, tên chi tiết..." class="input-field" id="searchInput">
                    </div>

                    <!-- PKY filter -->
                    <div class="filter-group">
                        <label class="filter-label">PKY</label>
                        <select id="pkyFilter" class="select-field">
                            <option value="all">Tất cả PKY</option>
                        </select>
                    </div>

                    <!-- Date range filter -->
                    <div class="filter-group lg:col-span-2">
                        <label class="filter-label">Ngày GC KT</label>
                        <div class="date-range-group">
                            <input type="date" id="dateFromFilter" class="input-field" placeholder="Từ ngày">
                            <span class="date-range-separator">đến</span>
                            <input type="date" id="dateToFilter" class="input-field" placeholder="Đến ngày">
                        </div>
                    </div>

                    <!-- Page size selector -->
                    <div class="filter-group">
                        <label class="filter-label">Hiển thị</label>
                        <select id="pageSizeSelect" class="select-field">
                            <option value="25">25 dòng</option>
                            <option value="50" selected>50 dòng</option>
                            <option value="100">100 dòng</option>
                            <option value="200">200 dòng</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Statistics -->
    <div class="mx-auto px-6 py-6">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 stats-grid">
            <div class="stats-card">
                <div class="stats-label">Tổng Order</div>
                <div class="stats-value" id="totalOrdersCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Tổng SLL</div>
                <div class="stats-value" id="totalSLLCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">OK</div>
                <div class="stats-value text-green-600" id="okCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">HBV</div>
                <div class="stats-value text-red-600" id="hbvCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Hiển thị</div>
                <div class="stats-value text-blue-600" id="displayedCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Đã chọn</div>
                <div class="stats-value text-green-600" id="selectedCountStat">0</div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="mx-auto px-6 pb-6">
        <div class="bg-white rounded-xl shadow-sm">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" class="checkbox-custom"></th>
                            <th>STT</th>
                            <th>Order KD</th>
                            <th>Order lệnh phôi</th>
                            <th>Order vật liệu</th>
                            <th>Tên chi tiết</th>
                            <th>File GC</th>
                            <th>PKY</th>
                            <th>Số lượng</th>
                            <th>Ngày GC KT</th>
                            <th>Thời hạn mới của KH</th>
                            <th>Tính chất</th>
                            <th>TT ưu tiên</th>
                            <th class="xac-nhan-cu-col">Xác nhận cũ</th>
                            <th class="xac-nhan-moi-col">Xác nhận mới</th>
                            <th>Trạng thái</th>
                            <th>SX</th>
                            <th>XL</th>
                            <th>TAP</th>
                            <th>VIA</th>
                            <th>Rửa</th>
                            <th>Ktra</th>
                            <th>Gói</th>
                            <th>Đã gói</th>
                            <th>Thông tin</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="28" class="text-center p-8">
                                <div class="loading"></div>
                                <div class="mt-2">Đang tải...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="p-6 border-t bg-gray-50 rounded-b-xl">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-sm text-gray-600" id="paginationInfo">
                        Hiển thị 0 - 0 của 0 kết quả
                    </div>
                    <div class="pagination" id="pagination">
                        <!-- Pagination buttons will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let selectedRows = new Map();
        let currentPage = 0;
        let pageSize = 50;
        let isLoading = false;

        const appId = 'e1339939-5987-4d7a-8c73-436348abf6b7';
        const accessKey = 'V2-WTcys-x7QFl-Z5SzF-zSe7D-qciuV-yaUHk-CDGEe-oSexL';
        const region = 'www';

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const d = new Date(dateString);
                if (isNaN(d.getTime())) return '';
                return `${d.getDate().toString().padStart(2, '0')}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getFullYear()}`;
            } catch (error) {
                return '';
            }
        }

        function generateRowId(item, index) {
            return `${item.order_kd || ''}_${index}`;
        }

        // Set current date
        function setCurrentDate() {
            const today = new Date();
            const dateStr = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;
            document.getElementById('currentDate').textContent = dateStr;
        }

        // Data fetching
        async function fetchData() {
            if (isLoading) return;

            isLoading = true;
            updateLoadingState(true);

            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/xac_nhan_ke_hoach/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: "Filter(xac_nhan_ke_hoach, true)"
                    })
                });

                if (!response.ok) throw new Error('Failed to fetch');
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error('Invalid data');

                allData = data.map((item, index) => ({
                    ...item,
                    _id: generateRowId(item, index),
                    _index: index
                }));

                filteredData = [...allData];
                populateFilters();
                updateStats();
                renderCurrentPage();

            } catch (error) {
                console.error('Error:', error);
                showError('Lỗi tải dữ liệu. Vui lòng thử lại.');
            } finally {
                isLoading = false;
                updateLoadingState(false);
            }
        }

        function updateLoadingState(loading) {
            const tbody = document.getElementById('table-body');
            if (loading) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="28" class="text-center p-8">
                        <div class="loading"></div>
                        <div class="mt-2">Đang tải...</div>
                    </td>
                </tr>
            `;
            }
        }

        function showError(message) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = `
           <tr>
               <td colspan="28" class="text-center p-8 text-red-500">
                   <i class="fas fa-exclamation-triangle mr-2"></i>${message}
               </td>
           </tr>
       `;
        }

        // Filtering
        const applyFilters = debounce(function () {
            const search = document.getElementById('searchInput').value.toLowerCase().trim();
            const pky = document.getElementById('pkyFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            filteredData = allData.filter(item => {
                // Search filter
                if (search) {
                    const searchableText = [
                        item.order_kd, item.ten_chi_tiet, item.file_gc, item.tinh_chat
                    ].join(' ').toLowerCase();

                    if (!searchableText.includes(search)) return false;
                }

                // PKY filter
                if (pky !== 'all' && item.pky !== pky) {
                    return false;
                }

                // Date range filter
                if (dateFrom || dateTo) {
                    if (!item.ngay_gckt) return false;

                    try {
                        const itemDate = new Date(item.ngay_gckt);

                        if (dateFrom) {
                            const fromDate = new Date(dateFrom);
                            if (itemDate < fromDate) return false;
                        }

                        if (dateTo) {
                            const toDate = new Date(dateTo);
                            toDate.setHours(23, 59, 59, 999);
                            if (itemDate > toDate) return false;
                        }
                    } catch (error) {
                        return false;
                    }
                }

                return true;
            });

            currentPage = 0;
            updateStats();
            renderCurrentPage();
            updatePagination();
        }, 500);

        // Stats
        function updateStats() {
            const totalOrders = allData.length;
            const totalSLL = allData.reduce((sum, item) => sum + (parseInt(item.sll) || 0), 0);
            const okCount = allData.filter(item => item.pky === 'OK').length;
            const hbvCount = allData.filter(item => item.pky === 'HBV').length;
            const displayed = filteredData.length;
            const selected = selectedRows.size;

            document.getElementById('totalOrdersCount').textContent = totalOrders;
            document.getElementById('totalSLLCount').textContent = totalSLL;
            document.getElementById('okCount').textContent = okCount;
            document.getElementById('hbvCount').textContent = hbvCount;
            document.getElementById('displayedCount').textContent = displayed;
            document.getElementById('selectedCountStat').textContent = selected;
            document.getElementById('selectedCountExcel').textContent = selected;
            document.getElementById('filteredCount').textContent = displayed;
        }

        // Populate filters
        function populateFilters() {
            const pkySet = new Set();
            allData.forEach(item => {
                if (item.pky && item.pky.trim()) {
                    pkySet.add(item.pky.trim());
                }
            });

            const pkySelect = document.getElementById('pkyFilter');
            pkySelect.innerHTML = '<option value="all">Tất cả PKY</option>';
            Array.from(pkySet).sort().forEach(pky => {
                const option = document.createElement('option');
                option.value = pky;
                option.textContent = pky;
                pkySelect.appendChild(option);
            });
        }

        // Table rendering
        function renderCurrentPage() {
            const tbody = document.getElementById('table-body');
            const startIndex = currentPage * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="28" class="text-center p-8">Không có dữ liệu</td></tr>';
                updatePaginationInfo(0, 0, 0);
                return;
            }

            const fragment = document.createDocumentFragment();

            pageData.forEach((item, index) => {
                const row = createTableRow(item, startIndex + index + 1);
                fragment.appendChild(row);
            });

            tbody.innerHTML = '';
            tbody.appendChild(fragment);

            updatePaginationInfo(startIndex + 1, endIndex, filteredData.length);
            updateSelectAllCheckbox();
        }

        function createTableRow(item, stt) {
            const row = document.createElement('tr');
            row.setAttribute('data-row-id', item._id);

            const isSelected = selectedRows.has(item._id);
            if (isSelected) {
                row.classList.add('selected');
            }

            const pkyClass = item.pky === 'OK' ? 'ok-status' : (item.pky === 'HBV' ? 'hbv-status' : '');

            row.innerHTML = `
                <td><input type="checkbox" class="checkbox-custom row-checkbox" ${isSelected ? 'checked' : ''}></td>
                <td>${item.stt || stt}</td>
                <td>${item.order_kd || ''}</td>
                <td>${item.order_phoi || ''}</td>
                <td>${item.order_vat_lieu || ''}</td>
                <td title="${item.ten_chi_tiet || ''}">${item.ten_chi_tiet || ''}</td>
                <td>${item.file_gc || ''}</td>
                <td class="${pkyClass}">${item.pky || ''}</td>
                <td>${item.sll || ''}</td>
                <td>${item.ngay_gckt}</td>
                <td>${formatDate(item.thoi_han)}</td>
                <td>${item.tinh_chat || ''}</td>
                <td>${item.tt || ''}</td>
                <td class="xac-nhan-cu-col">${item.xac_nhan_cu || ''}</td>
                <td class="xac-nhan-moi-col">${item.amj_xn || ''}</td>
                <td>${item.trang_thai || ''}</td>
                <td>${item.loi_ton || ''}</td>
                <td>${item.loi_ton1 || ''}</td>
                <td>${item.ton_tap || ''}</td>
                <td>${item.ton_via || ''}</td>
                <td>${item.ton_rua || ''}</td>
                <td>${item.ton_kiem_tra || ''}</td>
                <td>${item.ton_goi || ''}</td>
                <td>${item.da_goi || ''}</td>
                <td title="${item['Thông tin'] || ''}">${item['Thông tin'] || ''}</td>
            `;

            return row;
        }

        // Pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            html += `<button ${currentPage === 0 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
           <i class="fas fa-chevron-left"></i>
       </button>`;

            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages - 1, currentPage + 2);

            if (startPage > 0) {
                html += `<button onclick="goToPage(0)">1</button>`;
                if (startPage > 1) {
                    html += '<span>...</span>';
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
               ${i + 1}
           </button>`;
            }

            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    html += '<span>...</span>';
                }
                html += `<button onclick="goToPage(${totalPages - 1})">${totalPages}</button>`;
            }

            html += `<button ${currentPage >= totalPages - 1 ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
           <i class="fas fa-chevron-right"></i>
       </button>`;

            pagination.innerHTML = html;
        }

        function updatePaginationInfo(start, end, total) {
            document.getElementById('paginationInfo').textContent =
                `Hiển thị ${start} - ${end} của ${total} kết quả`;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (page < 0 || page >= totalPages) return;
            currentPage = page;
            renderCurrentPage();
            updatePagination();
        }

        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            currentPage = 0;
            renderCurrentPage();
            updatePagination();
        }

        // Selection handling
        function handleRowSelection(checkbox, rowId) {
            const row = checkbox.closest('tr');

            if (checkbox.checked) {
                selectedRows.set(rowId, true);
                row.classList.add('selected');
            } else {
                selectedRows.delete(rowId);
                row.classList.remove('selected');
            }

            updateStats();
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const currentPageIds = getCurrentPageRowIds();
            const selectedInCurrentPage = currentPageIds.filter(id => selectedRows.has(id)).length;

            if (selectedInCurrentPage === 0) {
                checkbox.indeterminate = false;
                checkbox.checked = false;
            } else if (selectedInCurrentPage === currentPageIds.length) {
                checkbox.indeterminate = false;
                checkbox.checked = true;
            } else {
                checkbox.indeterminate = true;
            }
        }

        function getCurrentPageRowIds() {
            return Array.from(document.querySelectorAll('#table-body tr[data-row-id]'))
                .map(row => row.getAttribute('data-row-id'));
        }

        function selectAllCurrentPage() {
            const currentPageIds = getCurrentPageRowIds();
            currentPageIds.forEach(id => selectedRows.set(id, true));

            document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('tr').classList.add('selected');
            });

            updateStats();
            updateSelectAllCheckbox();
        }

        function selectAllFiltered() {
            filteredData.forEach(item => selectedRows.set(item._id, true));

            document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('tr').classList.add('selected');
            });

            updateStats();
            updateSelectAllCheckbox();
        }

        function clearAllSelection() {
            selectedRows.clear();

            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('tr.selected').forEach(row => {
                row.classList.remove('selected');
            });

            updateStats();
            updateSelectAllCheckbox();
        }

        // Excel Export functionality - cập nhật để tạo 2 sheets
        async function generateExcelExport() {
            const selectedItems = filteredData.filter(item => selectedRows.has(item._id));

            if (selectedItems.length === 0) {
                alert('Vui lòng chọn ít nhất một dòng để xuất Excel');
                return;
            }

            try {
                // Hiển thị loading
                const exportBtn = document.getElementById('exportExcelBtn');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<div class="loading"></div> Đang xuất...';
                exportBtn.disabled = true;

                const workbook = new ExcelJS.Workbook();

                // Tạo Sheet 1: XN AMJ (dữ liệu thực)
                const worksheet1 = workbook.addWorksheet('XN AMJ');
                await createExcelWorksheetWithFormat(worksheet1, selectedItems);

                // Tạo Sheet 2: XN AMJ (2) (chỉ có tiêu đề)
                const worksheet2 = workbook.addWorksheet('XN AMJ (2)');
                await createExcelWorksheet2EmptyWithFormat(worksheet2);

                // Tạo tên file với ngày hiện tại
                const today = new Date();
                const dateStr = `${today.getDate()}_${today.getMonth() + 1}_${today.getFullYear()}`;
                const filename = `Xac_nhan_ke_hoach_${dateStr}.xlsx`;

                // Xuất file
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                // Tạo link download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);

                // Khôi phục nút
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;

            } catch (error) {
                console.error('Lỗi xuất Excel:', error);
                alert('Có lỗi xảy ra khi xuất Excel. Vui lòng thử lại.');

                // Khôi phục nút
                const exportBtn = document.getElementById('exportExcelBtn');
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }
        }

        // Tạo worksheet 2 chỉ có tiêu đề (không có dữ liệu)
        async function createExcelWorksheet2EmptyWithFormat(worksheet) {
            // Thiết lập trang in A4 ngang
            worksheet.pageSetup = {
                paperSize: 9, // A4
                orientation: 'landscape', // Ngang
                fitToPage: true,
                fitToWidth: 1,
                fitToHeight: 0,
                margins: {
                    left: 0.25,
                    right: 0.25,
                    top: 0.75,
                    bottom: 0.75,
                    header: 0.3,
                    footer: 0.3
                },
                printArea: 'A1:X1000',
                scale: 100
            };

            // Thiết lập độ rộng cột giống sheet 1
            worksheet.columns = [
                { width: 5 },    // A - STT
                { width: 11 },   // B - Order KD
                { width: 10 },   // C - Order lệnh phôi
                { width: 15 },   // D - Order vật liệu
                { width: 18 },   // E - Tên chi tiết
                { width: 8 },    // F - File GC
                { width: 10 },   // G - PKY
                { width: 8 },    // H - Số lượng
                { width: 12 },   // I - Ngày GC KT
                { width: 12 },   // J - Thời hạn mới của KH
                { width: 15 },   // K - Tính chất
                { width: 8 },    // L - TT ưu tiên
                { width: 12 },   // M - Xác nhận cũ
                { width: 12 },   // N - AMJ xác nhận
                { width: 12 },   // O - Trạng thái
                { width: 8 },    // P - SX
                { width: 8 },    // Q - XL
                { width: 8 },    // R - TAP
                { width: 8 },    // S - VIA
                { width: 8 },    // T - Rửa
                { width: 8 },    // U - Ktra
                { width: 8 },    // V - Gói
                { width: 8 },    // W - Đã gói
                { width: 15 }    // X - Thông tin
            ];

            // Header (dòng 1) - giống sheet 1
            const headerRow = worksheet.addRow([
                'STT', 'Order KD', 'Order lệnh phôi', 'Order vật liệu', 'Tên chi tiết',
                'File GC', 'PKY', 'Số lượng', 'Ngày GC KT', 'Thời hạn mới của KH',
                'Tính chất', 'TT ưu tiên', 'Xác nhận cũ', 'AMJ xác nhận', 'Trạng thái', 'SX',
                'XL', 'TAP', 'VIA', 'Rửa', 'Ktra', 'Gói', 'Đã gói', 'Thông tin'
            ]);

            // Định dạng cho header giống sheet 1
            const headerBorderStyle = {
                top: { style: 'thin', color: { argb: '000000' } },
                bottom: { style: 'thin', color: { argb: '000000' } },
                left: { style: 'thin', color: { argb: '000000' } },
                right: { style: 'thin', color: { argb: '000000' } }
            };

            const headerStyle = {
                font: { name: 'Times New Roman', size: 10, bold: true },
                alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                border: headerBorderStyle,
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'b4c6e7' } }
            };

            // Áp dụng style cho header
            headerRow.eachCell((cell, colNumber) => {
                cell.style = { ...headerStyle };

                // Màu nền đặc biệt cho cột "Xác nhận cũ" và "Xác nhận mới"
                if (colNumber === 13) { // Xác nhận cũ
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEB3B' } };
                } else if (colNumber === 14) { // Xác nhận mới
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFA726' } };
                }
            });
            headerRow.height = 38;

            // Thêm một số dòng trống có border để người dùng có thể nhập dữ liệu
            for (let i = 0; i < 50; i++) {
                const emptyRow = worksheet.addRow([
                    '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''
                ]);

                emptyRow.eachCell((cell) => {
                    cell.style = {
                        border: {
                            top: { style: 'thin', color: { argb: '000000' } },
                            bottom: { style: 'thin', color: { argb: '000000' } },
                            left: { style: 'thin', color: { argb: '000000' } },
                            right: { style: 'thin', color: { argb: '000000' } }
                        }
                    };
                });
                emptyRow.height = 18;
            }

            // Freeze panes để cố định header khi scroll
            worksheet.views = [
                { state: 'frozen', ySplit: 1 }
            ];
        }
        // Tạo worksheet với định dạng chi tiết theo mẫu
        async function createExcelWorksheetWithFormat(worksheet, selectedItems) {
            // Thiết lập trang in A4 ngang
            worksheet.pageSetup = {
                paperSize: 9, // A4
                orientation: 'landscape', // Ngang
                fitToPage: true,
                fitToWidth: 1,
                fitToHeight: 0,
                margins: {
                    left: 0.25,
                    right: 0.25,
                    top: 0.75,
                    bottom: 0.75,
                    header: 0.3,
                    footer: 0.3
                },
                printArea: 'A1:AB1000',
                scale: 100
            };

            // Thiết lập độ rộng cột theo mẫu
            worksheet.columns = [
                { width: 5 },    // A - STT
                { width: 11 },   // B - Order KD
                { width: 10 },   // C - Order lệnh phôi
                { width: 15 },   // D - Order vật liệu
                { width: 18 },   // E - Tên chi tiết
                { width: 8 },    // F - File GC
                { width: 10 },   // G - PKY
                { width: 8 },    // H - Số lượng
                { width: 12 },   // I - Ngày GC KT
                { width: 12 },   // J - Thời hạn mới của KH
                { width: 15 },   // K - Tính chất
                { width: 8 },    // L - TT ưu tiên
                { width: 12 },   // M - Xác nhận cũ
                { width: 12 },   // N - AMJ xác nhận
                { width: 12 },   // O - Trạng thái
                { width: 8 },    // P - SX
                { width: 8 },    // Q - XL
                { width: 8 },    // R - TAP
                { width: 8 },    // S - VIA
                { width: 8 },    // T - Rửa
                { width: 8 },    // U - Ktra
                { width: 8 },    // V - Gói
                { width: 8 },    // W - Đã gói
                { width: 15 }    // X - Thông tin
            ];

            // Header (dòng 1)
            const headerRow = worksheet.addRow([
                'STT', 'Order KD', 'Order lệnh phôi', 'Order vật liệu', 'Tên chi tiết',
                'File GC', 'PKY', 'Số lượng', 'Ngày GC KT', 'Thời hạn mới của KH',
                'Tính chất', 'TT ưu tiên', 'Xác nhận cũ', 'AMJ xác nhận', 'Trạng thái', 'SX',
                'XL', 'TAP', 'VIA', 'Rửa', 'Ktra', 'Gói', 'Đã gói', 'Thông tin'
            ]);

            // Định dạng cho header
            const headerBorderStyle = {
                top: { style: 'thin', color: { argb: '000000' } },
                bottom: { style: 'thin', color: { argb: '000000' } },
                left: { style: 'thin', color: { argb: '000000' } },
                right: { style: 'thin', color: { argb: '000000' } }
            };

            const headerStyle = {
                font: { name: 'Times New Roman', size: 10, bold: true },
                alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                border: headerBorderStyle,
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'b4c6e7' } }
            };

            // Áp dụng style cho header
            headerRow.eachCell((cell, colNumber) => {
                cell.style = { ...headerStyle };

                // Màu nền đặc biệt cho cột "Xác nhận cũ" và "Xác nhận mới"
                if (colNumber === 13) { // Xác nhận cũ
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEB3B' } };
                } else if (colNumber === 14) { // Xác nhận mới
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFA726' } };
                }
            });
            headerRow.height = 38;

            // Thêm dữ liệu
            selectedItems.forEach((item, index) => {
                const rowData = [
                    index + 1, // STT
                    item.order_kd || '',
                    item.order_phoi || '',
                    item.order_vat_lieu || '',
                    item.ten_chi_tiet || '',
                    item.file_gc || '',
                    item.pky || '',
                    item.sll || '',
                    item.ngay_gckt,
                    formatDate(item.thoi_han),
                    item.tinh_chat || '',
                    item.tt || '',
                    item.xac_nhan_cu || '',
                    item.amj_xn || '',
                    item.trang_thai || '',
                    item.loi_ton || '',
                    item.loi_ton1 || '',
                    item.ton_tap || '',
                    item.ton_via || '',
                    item.ton_rua || '',
                    item.ton_kiem_tra || '',
                    item.ton_goi || '',
                    item.da_goi || '',
                    item['Thông tin'] || ''
                ];

                const dataRow = worksheet.addRow(rowData);

                // Định dạng cho dòng dữ liệu
                dataRow.eachCell((cell, colNumber) => {
                    let cellBorder = {
                        top: { style: 'thin', color: { argb: '000000' } },
                        left: { style: 'thin', color: { argb: '000000' } },
                        right: { style: 'thin', color: { argb: '000000' } },
                        bottom: { style: 'thin', color: { argb: '000000' } }
                    };

                    let numFmt = undefined;
                    let cellValue = cell.value;

                    // Định dạng số cho các cột cụ thể: Order KD, Số lượng, SX, XL, TAP, VIA, Rửa, Ktra, Gói, Đã gói
                    const columnsToFormat = [2, 8, 16, 17, 18, 19, 20, 21, 22, 23];

                    if (columnsToFormat.includes(colNumber)) {
                        if (cellValue && !isNaN(cellValue) && cellValue !== '') {
                            // Chuyển về số
                            cell.value = parseInt(cellValue, 10);

                            // Định dạng đặc biệt cho Order KD (cột 2) - giữ số 0 đầu
                            if (colNumber === 2) {
                                numFmt = '0000000000'; // 10 chữ số với số 0 đầu
                            } else {
                                numFmt = '0'; // Định dạng số thông thường
                            }
                        } else if (cellValue === '' || cellValue === null || cellValue === undefined) {
                            // Để trống cho các giá trị rỗng
                            cell.value = '';
                            numFmt = '@'; // Text format
                        } else {
                            // Giữ nguyên giá trị text
                            numFmt = '@'; // Text format
                        }
                    }

                    cell.style = {
                        font: {
                            name: 'Times New Roman',
                            size: 9,
                            bold: false,
                            color: { argb: '000000' }
                        },
                        alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                        border: cellBorder
                    };

                    // Màu nền cho cột "Xác nhận cũ" và "Xác nhận mới"
                    if (colNumber === 13) { // Xác nhận cũ
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEB3B' } };
                    } else if (colNumber === 14) { // Xác nhận mới
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFA726' } };
                    }

                    // Áp dụng định dạng số
                    if (numFmt) {
                        cell.numFmt = numFmt;
                    }
                });

                dataRow.height = 18;
            });

            // Freeze panes để cố định header khi scroll
            worksheet.views = [
                { state: 'frozen', ySplit: 1 }
            ];
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Search and filters
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('pkyFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFromFilter').addEventListener('change', applyFilters);
            document.getElementById('dateToFilter').addEventListener('change', applyFilters);

            // Page size
            document.getElementById('pageSizeSelect').addEventListener('change', function () {
                changePageSize(this.value);
            });

            // Header controls
            document.getElementById('selectAllCheckbox').addEventListener('change', function () {
                if (this.checked) {
                    selectAllCurrentPage();
                } else {
                    const currentPageIds = getCurrentPageRowIds();
                    currentPageIds.forEach(id => selectedRows.delete(id));

                    document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                        checkbox.closest('tr').classList.remove('selected');
                    });

                    updateStats();
                    updateSelectAllCheckbox();
                }
            });

            document.getElementById('selectAllBtn').addEventListener('click', selectAllCurrentPage);
            document.getElementById('selectAllFilteredBtn').addEventListener('click', selectAllFiltered);
            document.getElementById('clearSelectionBtn').addEventListener('click', clearAllSelection);
            document.getElementById('exportExcelBtn').addEventListener('click', generateExcelExport);
        });

        // Table events with delegation
        document.getElementById('table-body').addEventListener('click', function (e) {
            const row = e.target.closest('tr');
            if (!row || !row.hasAttribute('data-row-id')) return;

            const rowId = row.getAttribute('data-row-id');

            if (e.target.type !== 'checkbox') {
                const checkbox = row.querySelector('.row-checkbox');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    handleRowSelection(checkbox, rowId);
                }
            }
        });

        document.getElementById('table-body').addEventListener('change', function (e) {
            if (e.target.classList.contains('row-checkbox')) {
                const row = e.target.closest('tr');
                const rowId = row.getAttribute('data-row-id');
                handleRowSelection(e.target, rowId);
            }
        });

        // Initialize
        setCurrentDate();
        fetchData();

        // Disable right-click and dev tools
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</body>

</html>
