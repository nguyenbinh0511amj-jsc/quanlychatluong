<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TỔNG HỢP LỖI CÒN TỒN ĐỌNG TRONG NGÀY</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        * {
            font-family: 'Times New Roman', Times, serif;
            box-sizing: border-box;
        }

        @media print {
            body>*:not(#printArea) {
                display: none !important;
            }

            #printArea {
                display: block !important;
            }
        }

        #printArea {
            display: none;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        }

        .input-field {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-field::placeholder {
            color: #9ca3af;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .select-field {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .select-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .date-range-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-range-group .input-field {
            flex: 1;
            min-width: 0;
        }

        .date-range-separator {
            color: #6b7280;
            font-weight: 500;
            white-space: nowrap;
            font-size: 12px;
        }

        .multi-select-container {
            position: relative;
        }

        .multi-select-button {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            justify-content: between;
            align-items: center;
            width: 100%;
            text-align: left;
        }

        .multi-select-button:focus,
        .multi-select-button:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .multi-select-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .multi-select-icon {
            color: #6b7280;
            transition: transform 0.2s ease;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 20;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
        }

        .multi-select-search {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .multi-select-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
        }

        .multi-select-option {
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-option:hover {
            background-color: #f9fafb;
        }

        .multi-select-option label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            font-size: 13px;
        }

        .multi-select-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }

        .badge {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .stats-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .stats-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stats-value {
            font-size: 24px;
            font-weight: bold;
            color: #111827;
        }

        .table-container {
            overflow: auto;
            max-height: 80vh;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            min-width: 2400px;
            border-collapse: collapse;
            font-size: 8px;
        }

        th,
        td {
            border: 0.5px solid #000;
            padding: 1px 2px;
            text-align: center;
            vertical-align: middle;
            height: 20px;
        }

        th {
            background: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 10px;
            font-weight: 600;
        }

        .error-header {
            background: #fde9d9 !important;
        }

        .return-header {
            background: #ebf1de !important;
        }

        .confirm-header {
            color: #4c73c0 !important;
        }

        tbody tr:hover {
            background-color: #f9fafb;
        }

        tbody tr.selected {
            background-color: #dbeafe;
        }

        tbody td {
            border-right: 1px solid black;
            border-bottom: 0.5px dashed #d3d3d3;
            font-size: 8px;
        }

        .error-cell {
            background: #fde9d9;
        }

        .return-cell {
            background: #ebf1de;
        }

        .checkbox-custom {
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }

        .hidden {
            display: none;
        }

        .error-red {
            color: #dc2626;
            font-weight: bold;
        }

        .percentage-green {
            color: #16a34a;
            font-weight: bold;
        }

        .percentage-yellow {
            color: #ca8a04;
            font-weight: bold;
        }

        .percentage-red {
            color: #dc2626;
            font-weight: bold;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .pagination button:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .pagination button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr !important;
            }

            .header-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .header-actions .btn {
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .date-range-group {
                flex-direction: column;
                align-items: stretch;
            }

            .date-range-separator {
                text-align: center;
                padding: 4px 0;
            }
        }

        /* Column widths theo form in - điều chỉnh cho 41 cột */
        th:nth-child(1),
        td:nth-child(1) {
            width: 20px;
            /* Checkbox */
        }

        th:nth-child(2),
        td:nth-child(2) {
            width: 13px;
            /* Số tt */
        }

        th:nth-child(3),
        td:nth-child(3) {
            width: 52px;
            /* Order KD */
        }

        th:nth-child(4),
        td:nth-child(4) {
            width: 65px;
            /* Tên chi tiết */
        }

        th:nth-child(5),
        td:nth-child(5) {
            width: 20px;
            /* Slg lệnh */
        }

        th:nth-child(6),
        td:nth-child(6) {
            width: 25px;
            /* AMJ XN - MỚI */
        }

        th:nth-child(7),
        td:nth-child(7) {
            width: 50px;
            /* Tinh chất đơn hàng - MỚI */
        }

        th:nth-child(8),
        td:nth-child(8) {
            width: 42px;
            /* Thời hạn khách hàng */
        }

        th:nth-child(9),
        td:nth-child(9) {
            width: 25px;
            /* Tổng SL tồn lỗi */
        }

        /* Báo lỗi lần 1 */
        th:nth-child(10),
        td:nth-child(10) {
            width: 37px;
            /* Ngày BL 1 */
        }

        th:nth-child(11),
        td:nth-child(11) {
            width: 60px;
            /* Nội dung lỗi 1 */
        }

        th:nth-child(12),
        td:nth-child(12) {
            width: 15px;
            /* SL BL 1 */
        }

        /* Báo lỗi lần 2 */
        th:nth-child(13),
        td:nth-child(13) {
            width: 37px;
            /* Ngày BL 2 */
        }

        th:nth-child(14),
        td:nth-child(14) {
            width: 60px;
            /* Nội dung lỗi 2 */
        }

        th:nth-child(15),
        td:nth-child(15) {
            width: 15px;
            /* SL BL 2 */
        }

        /* Báo lỗi lần 3 */
        th:nth-child(16),
        td:nth-child(16) {
            width: 37px;
            /* Ngày BL 3 */
        }

        th:nth-child(17),
        td:nth-child(17) {
            width: 60px;
            /* Nội dung lỗi 3 */
        }

        th:nth-child(18),
        td:nth-child(18) {
            width: 15px;
            /* SL BL 3 */
        }

        /* Báo lỗi lần 4 */
        th:nth-child(19),
        td:nth-child(19) {
            width: 37px;
            /* Ngày BL 4 */
        }

        th:nth-child(20),
        td:nth-child(20) {
            width: 60px;
            /* Nội dung lỗi 4 */
        }

        th:nth-child(21),
        td:nth-child(21) {
            width: 15px;
            /* SL BL 4 */
        }

        /* Báo lỗi lần 5 */
        th:nth-child(22),
        td:nth-child(22) {
            width: 37px;
            /* Ngày BL 5 */
        }

        th:nth-child(23),
        td:nth-child(23) {
            width: 60px;
            /* Nội dung lỗi 5 */
        }

        th:nth-child(24),
        td:nth-child(24) {
            width: 15px;
            /* SL BL 5 */
        }

        /* Trả lần 1 */
        th:nth-child(25),
        td:nth-child(25) {
            width: 37px;
            /* Ngày trả 1 */
        }

        th:nth-child(26),
        td:nth-child(26) {
            width: 15px;
            /* SL trả 1 */
        }

        /* Trả lần 2 */
        th:nth-child(27),
        td:nth-child(27) {
            width: 37px;
            /* Ngày trả 2 */
        }

        th:nth-child(28),
        td:nth-child(28) {
            width: 15px;
            /* SL trả 2 */
        }

        /* Trả lần 3 */
        th:nth-child(29),
        td:nth-child(29) {
            width: 37px;
            /* Ngày trả 3 */
        }

        th:nth-child(30),
        td:nth-child(30) {
            width: 15px;
            /* SL trả 3 */
        }

        /* Trả lần 4 */
        th:nth-child(31),
        td:nth-child(31) {
            width: 37px;
            /* Ngày trả 4 */
        }

        th:nth-child(32),
        td:nth-child(32) {
            width: 15px;
            /* SL trả 4 */
        }

        /* Trả lần 5 */
        th:nth-child(33),
        td:nth-child(33) {
            width: 37px;
            /* Ngày trả 5 */
        }

        th:nth-child(34),
        td:nth-child(34) {
            width: 15px;
            /* SL trả 5 */
        }

        /* Các cột cuối */
        th:nth-child(35),
        td:nth-child(35) {
            width: 30px;
            /* Số lần báo lỗi */
        }

        th:nth-child(36),
        td:nth-child(36) {
            width: 25px;
            /* Tỷ lệ lỗi */
        }

        th:nth-child(37),
        td:nth-child(37) {
            width: 80px;
            /* Bộ phận phát sinh lỗi */
        }

        th:nth-child(38),
        td:nth-child(38) {
            width: 45px;
            /* Máy sửa */
        }

        th:nth-child(39),
        td:nth-child(39) {
            width: 75px;
            /* Hẹn sửa xong */
        }

        th:nth-child(40),
        td:nth-child(40) {
            width: 73px;
            /* Kiểm tra xác nhận lại */
        }

        th:nth-child(41),
        td:nth-child(41) {
            width: 100px;
            /* Ghi chú */
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="printArea"></div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="mx-auto px-6 py-6">
            <!-- Title Section -->
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                <div class="flex items-center space-x-4">
                    <div class="bg-gradient-to-r from-red-500 to-red-600 p-3 rounded-xl text-white shadow-lg">
                        <i class="fas fa-exclamation-triangle text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">TỔNG HỢP LỖI CÒN TỒN ĐỌNG TRONG NGÀY</h1>
                        <p class="text-sm text-gray-500 mt-1" id="currentDate"></p>
                    </div>
                </div>

                <div class="header-actions">
                    <button id="selectAllBtn" class="btn btn-secondary">
                        <i class="fas fa-check-square"></i>
                        Chọn tất cả trang
                    </button>
                    <button id="selectAllFilteredBtn" class="btn btn-secondary">
                        <i class="fas fa-check-double"></i>
                        Chọn tất cả lọc (<span id="filteredCount">0</span>)
                    </button>
                    <button id="clearSelectionBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Bỏ chọn
                    </button>
                    <button id="exportBtn" class="btn btn-primary">
                        <i class="fas fa-print"></i>
                        In (<span id="selectedCount">0</span>)
                    </button>
                    <button id="exportExcelBtn" class="btn btn-primary">
                        <i class="fas fa-file-excel"></i>
                        Xuất Excel (<span id="selectedCountExcel">0</span>)
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="bg-gray-50 rounded-xl p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-8 gap-2 filters-grid">
                    <!-- Search -->
                    <div class="filter-group lg:col-span-2">
                        <label class="filter-label">Tìm kiếm</label>
                        <input type="text" placeholder="Order KD, tên chi tiết..." class="input-field" id="searchInput">
                    </div>

                    <!-- Bộ phận filter -->
                    <div class="filter-group">
                        <label class="filter-label">Bộ phận</label>
                        <select id="boPhanFilter" class="select-field">
                            <option value="all">Tất cả bộ phận</option>
                        </select>
                    </div>

                    <!-- Date range filter -->
                    <div class="filter-group lg:col-span-2">
                        <label class="filter-label">Khoảng thời gian</label>
                        <div class="date-range-group">
                            <input type="date" id="dateFromFilter" class="input-field" placeholder="Từ ngày">
                            <span class="date-range-separator">đến</span>
                            <input type="date" id="dateToFilter" class="input-field" placeholder="Đến ngày">
                        </div>
                    </div>

                    <!-- Lỗi tồn filter -->
                    <div class="filter-group">
                        <label class="filter-label">Lỗi tồn</label>
                        <div class="multi-select-container">
                            <button type="button" id="loiTonFilterBtn" class="multi-select-button">
                                <span id="loiTonFilterText" class="multi-select-text">Tất cả lỗi tồn</span>
                                <i class="fas fa-chevron-down multi-select-icon"></i>
                            </button>
                            <div id="loiTonFilterDropdown" class="multi-select-dropdown hidden">
                                <div class="multi-select-search">
                                    <label class="multi-select-option">
                                        <input type="checkbox" id="selectAllLoiTon">
                                        <span class="font-semibold">Chọn tất cả</span>
                                    </label>
                                </div>
                                <div id="loiTonOptions">
                                    <!-- Options will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ma lỗi filter -->
                    <div class="filter-group">
                        <label class="filter-label">Mã lỗi</label>
                        <div class="multi-select-container">
                            <button type="button" id="maLoiFilterBtn" class="multi-select-button">
                                <span id="maLoiFilterText" class="multi-select-text">Tất cả mã lỗi</span>
                                <i class="fas fa-chevron-down multi-select-icon"></i>
                            </button>
                            <div id="maLoiFilterDropdown" class="multi-select-dropdown hidden">
                                <div class="multi-select-search">
                                    <input type="text" id="maLoiSearch" class="w-full p-2 border rounded"
                                        placeholder="Tìm kiếm mã lỗi...">
                                </div>
                                <div class="multi-select-search">
                                    <label class="multi-select-option">
                                        <input type="checkbox" id="selectAllMaLoi">
                                        <span class="font-semibold">Chọn tất cả</span>
                                    </label>
                                </div>
                                <div id="maLoiOptions">
                                    <!-- Options will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nội dung lỗi filter -->
                    <div class="filter-group">
                        <label class="filter-label">Nội dung lỗi</label>
                        <div class="multi-select-container">
                            <button type="button" id="noiDungLoiFilterBtn" class="multi-select-button">
                                <span id="noiDungLoiFilterText" class="multi-select-text">Tất cả nội dung lỗi</span>
                                <i class="fas fa-chevron-down multi-select-icon"></i>
                            </button>
                            <div id="noiDungLoiFilterDropdown" class="multi-select-dropdown hidden">
                                <div class="multi-select-search">
                                    <input type="text" id="noiDungLoiSearch" class="w-full p-2 border rounded"
                                        placeholder="Tìm kiếm nội dung lỗi...">
                                </div>
                                <div class="multi-select-search">
                                    <label class="multi-select-option">
                                        <input type="checkbox" id="selectAllNoiDungLoi">
                                        <span class="font-semibold">Chọn tất cả</span>
                                    </label>
                                </div>
                                <div id="noiDungLoiOptions">
                                    <!-- Options will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Statistics -->
    <div class="mx-auto px-6 py-6">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 stats-grid">
            <div class="stats-card">
                <div class="stats-label">Tổng Order</div>
                <div class="stats-value" id="totalOrdersCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Tổng SLL</div>
                <div class="stats-value" id="totalSLLCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Tổng lỗi</div>
                <div class="stats-value text-red-600" id="totalErrorCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Tỷ lệ lỗi TB</div>
                <div class="stats-value text-orange-600" id="avgErrorRate">0%</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Đã chọn</div>
                <div class="stats-value text-green-600" id="selectedCountStat">0</div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="mx-auto px-6 pb-6">
        <div class="bg-white rounded-xl shadow-sm">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2"><input type="checkbox" id="selectAllCheckbox" class="checkbox-custom"></th>
                            <th rowspan="2">Số<br>tt</th>
                            <th rowspan="2">Order<br>KD</th>
                            <th rowspan="2">Tên<br>chi tiết</th>
                            <th rowspan="2">Slg<br>lệnh</th>
                            <th rowspan="2">AMJ<br>XN</th>
                            <th rowspan="2">Tinh chất<br>đơn hàng</th>
                            <th rowspan="2">Thời hạn<br>khách hàng</th>
                            <th rowspan="2">Tổng<br>SL tồn lỗi</th>
                            <th colspan="3" class="error-header">Báo lỗi lần 1</th>
                            <th colspan="3" class="error-header">Báo lỗi lần 2</th>
                            <th colspan="3" class="error-header">Báo lỗi lần 3</th>
                            <th colspan="3" class="error-header">Báo lỗi lần 4</th>
                            <th colspan="3" class="error-header">Báo lỗi lần 5</th>
                            <th colspan="2" class="return-header">Trả lần 1</th>
                            <th colspan="2" class="return-header">Trả lần 2</th>
                            <th colspan="2" class="return-header">Trả lần 3</th>
                            <th colspan="2" class="return-header">Trả lần 4</th>
                            <th colspan="2" class="return-header">Trả lần 5</th>
                            <th rowspan="2">Số lần<br>báo lỗi</th>
                            <th rowspan="2" style="color: red;">Tỷ lệ<br>lỗi</th>
                            <th rowspan="2" style="color: red;">Bộ phận phát sinh<br>lỗi</th>
                            <th colspan="2" class="confirm-header">Xác nhận của SX AMJ</th>
                            <th rowspan="2">Kiểm tra<br>xác nhận lại</th>
                            <th rowspan="2">Ghi<br>chú</th>
                        </tr>
                        <tr>
                            <!-- Báo lỗi lần 1-5 -->
                            <th class="error-header">Ngày<br>BL</th>
                            <th class="error-header">Nội dung lỗi</th>
                            <th class="error-header">SL<br>BL</th>
                            <th class="error-header">Ngày<br>BL</th>
                            <th class="error-header">Nội dung lỗi</th>
                            <th class="error-header">SL<br>BL</th>
                            <th class="error-header">Ngày<br>BL</th>
                            <th class="error-header">Nội dung lỗi</th>
                            <th class="error-header">SL<br>BL</th>
                            <th class="error-header">Ngày<br>BL</th>
                            <th class="error-header">Nội dung lỗi</th>
                            <th class="error-header">SL<br>BL</th>
                            <th class="error-header">Ngày<br>BL</th>
                            <th class="error-header">Nội dung lỗi</th>
                            <th class="error-header">SL<br>BL</th>
                            <!-- Trả lần 1-5 -->
                            <th class="return-header">Ngày<br>trả</th>
                            <th class="return-header">SL<br>trả</th>
                            <th class="return-header">Ngày<br>trả</th>
                            <th class="return-header">SL<br>trả</th>
                            <th class="return-header">Ngày<br>trả</th>
                            <th class="return-header">SL<br>trả</th>
                            <th class="return-header">Ngày<br>trả</th>
                            <th class="return-header">SL<br>trả</th>
                            <th class="return-header">Ngày<br>trả</th>
                            <th class="return-header">SL<br>trả</th>
                            <!-- Xác nhận của SX AMJ -->
                            <th class="confirm-header">Máy sửa</th>
                            <th class="confirm-header">Hẹn sửa xong</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="41" class="text-center p-8">
                                <div class="loading"></div>
                                <div class="mt-2">Đang tải...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="p-6 border-t bg-gray-50 rounded-b-xl">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-600" id="paginationInfo">
                            Hiển thị 0 - 0 của 0 kết quả
                        </div>
                        <div class="filter-group">
                            <select id="pageSizeSelect" class="select-field" style="width: auto; min-width: 120px;">
                                <option value="25">25 dòng</option>
                                <option value="50" selected>50 dòng</option>
                                <option value="100">100 dòng</option>
                                <option value="200">200 dòng</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination" id="pagination">
                        <!-- Pagination buttons will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let processedData = [];
        let selectedRows = new Map();
        let currentPage = 0;
        let pageSize = 50;
        let isLoading = false;
        let selectedLoiTonValues = new Set();
        let selectedNoiDungLoiValues = new Set();
        let allNoiDungLoiValues = [];
        let filteredNoiDungLoiValues = [];
        let selectedMaLoiValues = new Set();
        let allMaLoiValues = [];
        let filteredMaLoiValues = [];

        const appId = 'e1339939-5987-4d7a-8c73-436348abf6b7';
        const accessKey = 'V2-WTcys-x7QFl-Z5SzF-zSe7D-qciuV-yaUHk-CDGEe-oSexL';
        const region = 'www';

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const d = new Date(dateString);
            return `${d.getDate()}-${getMonthName(d.getMonth())}`;
        }

        function getMonthName(month) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[month];
        }

        function formatDateFull(dateString) {
            if (!dateString || dateString === 'undefined' || dateString === 'NaN') return '';

            try {
                let d;

                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        const day = parts[0];
                        const month = parts[1];
                        const year = parts[2];

                        if (day && month && year && !isNaN(day) && !isNaN(month) && !isNaN(year)) {
                            d = new Date(year, month - 1, day);
                        } else {
                            return '';
                        }
                    } else {
                        return '';
                    }
                } else {
                    d = new Date(dateString);
                }

                if (isNaN(d.getTime())) return '';

                return `${d.getDate().toString().padStart(2, '0')}/${getMonthName(d.getMonth())}/${d.getFullYear()}`;

            } catch (error) {
                return '';
            }
        }

        function generateRowId(item, index) {
            return `${item.order_kd || ''}_${index}`;
        }

        // Set current date
        function setCurrentDate() {
            const today = new Date();
            const dateStr = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;
            document.getElementById('currentDate').textContent = dateStr;
        }

        // Data processing
        function processDataByOrder(rawData) {
            const orderGroups = {};

            rawData.forEach(item => {
                const orderKd = item.order_kd;
                if (!orderKd) return;

                if (!orderGroups[orderKd]) {
                    orderGroups[orderKd] = {
                        order_kd: orderKd,
                        ten_chi_tiet: item.ten_chi_tiet,
                        sll: parseInt(item.sll || 0),
                        tt: item.tt || '', // THÊM MỚI
                        tinh_chat: item.tinh_chat || '', // THÊM MỚI
                        thoi_han: item['Thời hạn'] || '',
                        bo_phan: item.noi_phat_sinh_loi || '',
                        may_sua: item.may_sua || '',
                        hen_sua_xong: item.hen_sua_xong || '',
                        kiem_tra: item.ho_va_ten || '',
                        ghi_chu: item['Thông tin'] || '',
                        errors: []
                    };
                }

                if (item.ngay_bao_loi || item.sl_loi) {
                    orderGroups[orderKd].errors.push({
                        ngay_bao_loi: item.ngay_bao_loi,
                        gio_bao_loi: item.gio_bao_loi,
                        noi_dung_loi: item.noi_dung_loi,
                        sl_loi: parseInt(item.sl_loi || 0),
                        ngay_tra_loi: item.ngay_tra_loi,
                        gio_tra_loi: item.gio_tra_loi,
                        sl_tra: parseInt(item.sl_tra || 0),
                        ma_loi: item.ma_loi,
                        timestamp: new Date(item.ngay_bao_loi + ' ' + (item.gio_bao_loi || '00:00')).getTime()
                    });
                }
            });

            const processed = [];
            Object.values(orderGroups).forEach((orderGroup, index) => {
                const sortedErrors = orderGroup.errors
                    .filter(error => error.ngay_bao_loi)
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 5);

                const totalSLBaoLoi = sortedErrors.reduce((sum, error) => sum + error.sl_loi, 0);
                const totalSLTra = sortedErrors.reduce((sum, error) => sum + error.sl_tra, 0);
                const tongSLTonLoiRaw = totalSLBaoLoi - totalSLTra;

                const tongSLTonLoi = tongSLTonLoiRaw > 0 ? -tongSLTonLoiRaw : (tongSLTonLoiRaw === 0 && totalSLBaoLoi > 0 ? 0 : '');

                const errorRate = orderGroup.sll > 0 ? Math.ceil((totalSLBaoLoi / orderGroup.sll) * 100) : 0;
                const errorCount = sortedErrors.length;

                const processedItem = {
                    _id: generateRowId(orderGroup, index),
                    _index: index,
                    order_kd: orderGroup.order_kd,
                    ten_chi_tiet: orderGroup.ten_chi_tiet,
                    sll: orderGroup.sll,
                    tt: orderGroup.tt, // THÊM MỚI
                    tinh_chat: orderGroup.tinh_chat, // THÊM MỚI
                    thoi_han: orderGroup.thoi_han,
                    tong_loi: tongSLTonLoi,
                    so_lan_loi: errorCount,
                    ty_le_loi: errorRate,
                    bo_phan: orderGroup.bo_phan,
                    may_sua: orderGroup.may_sua,
                    hen_sua_xong: orderGroup.hen_sua_xong,
                    kiem_tra: orderGroup.kiem_tra,
                    ghi_chu: orderGroup.ghi_chu,
                    errors: sortedErrors,
                    total_sl_bao_loi: totalSLBaoLoi,
                    total_sl_tra: totalSLTra,
                    tong_sl_ton_loi_raw: tongSLTonLoiRaw
                };

                processed.push(processedItem);
            });

            return processed.sort((a, b) => a.order_kd.localeCompare(b.order_kd));
        }

        // Data fetching
        async function fetchData() {
            if (isLoading) return;

            isLoading = true;
            updateLoadingState(true);

            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/tong_hop_loi/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: "Filter(tong_hop_loi, true)"
                    })
                });

                if (!response.ok) throw new Error('Failed to fetch');
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error('Invalid data');

                allData = data;
                processedData = processDataByOrder(allData);
                filteredData = [...processedData];

                populateFilters();
                updateStats();
                renderCurrentPage();

            } catch (error) {
                console.error('Error:', error);
                showError('Lỗi tải dữ liệu. Vui lòng thử lại.');
            } finally {
                isLoading = false;
                updateLoadingState(false);
            }
        }

        function updateLoadingState(loading) {
            const tbody = document.getElementById('table-body');
            if (loading) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="41" class="text-center p-8">
                        <div class="loading"></div>
                        <div class="mt-2">Đang tải...</div>
                    </td>
                </tr>
            `;
            }
        }

        function showError(message) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = `
           <tr>
               <td colspan="41" class="text-center p-8 text-red-500">
                   <i class="fas fa-exclamation-triangle mr-2"></i>${message}
               </td>
           </tr>
       `;
        }

        // Filter functions for dropdowns
        function populateLoiTonFilter() {
            const loiTonSet = new Set();

            processedData.forEach(item => {
                const tongSLTonLoi = item.tong_loi || 0;
                loiTonSet.add(tongSLTonLoi);
            });

            const loiTonOptions = document.getElementById('loiTonOptions');
            loiTonOptions.innerHTML = '';

            const sortedValues = Array.from(loiTonSet).sort((a, b) => a - b);

            sortedValues.forEach(value => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.innerHTML = `
           <label>
               <input type="checkbox" value="${value}" class="loi-ton-checkbox">
               <span>${value}</span>
           </label>
       `;
                loiTonOptions.appendChild(option);
            });
        }

        function updateLoiTonFilterText() {
            const button = document.getElementById('loiTonFilterText');
            const count = selectedLoiTonValues.size;

            if (count === 0) {
                button.textContent = 'Tất cả lỗi tồn';
            } else if (count === 1) {
                button.innerHTML = `Lỗi tồn: ${Array.from(selectedLoiTonValues)[0]}`;
            } else {
                button.innerHTML = `Đã chọn ${count} giá trị<span class="badge">${count}</span>`;
            }
        }

        function toggleLoiTonDropdown() {
            const dropdown = document.getElementById('loiTonFilterDropdown');
            const icon = document.querySelector('#loiTonFilterBtn .multi-select-icon');

            dropdown.classList.toggle('hidden');
            icon.style.transform = dropdown.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';

            // Close other dropdowns
            document.getElementById('noiDungLoiFilterDropdown').classList.add('hidden');
            document.getElementById('maLoiFilterDropdown').classList.add('hidden'); // Thêm dòng này
            document.querySelector('#noiDungLoiFilterBtn .multi-select-icon').style.transform = 'rotate(0deg)';
            document.querySelector('#maLoiFilterBtn .multi-select-icon').style.transform = 'rotate(0deg)'; // Thêm dòng này
        }

        // Thêm các hàm xử lý ma_loi filter
        function populateMaLoiFilter() {
            const maLoiSet = new Set();

            processedData.forEach(item => {
                item.errors.forEach(error => {
                    if (error.ma_loi && error.ma_loi.trim()) {
                        maLoiSet.add(error.ma_loi.trim());
                    }
                });
            });

            allMaLoiValues = Array.from(maLoiSet).sort();
            filteredMaLoiValues = [...allMaLoiValues];
            renderMaLoiOptions();
        }

        function renderMaLoiOptions() {
            const maLoiOptions = document.getElementById('maLoiOptions');
            maLoiOptions.innerHTML = '';

            filteredMaLoiValues.forEach(value => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.innerHTML = `
            <label>
                <input type="checkbox" value="${value}" class="ma-loi-checkbox" ${selectedMaLoiValues.has(value) ? 'checked' : ''}>
                <span title="${value}">${value}</span>
            </label>
        `;
                maLoiOptions.appendChild(option);
            });
        }

        function filterMaLoiOptions() {
            const searchTerm = document.getElementById('maLoiSearch').value.toLowerCase().trim();

            if (searchTerm === '') {
                filteredMaLoiValues = [...allMaLoiValues];
            } else {
                filteredMaLoiValues = allMaLoiValues.filter(value =>
                    value.toLowerCase().includes(searchTerm)
                );
            }

            renderMaLoiOptions();
        }

        function updateMaLoiFilterText() {
            const button = document.getElementById('maLoiFilterText');
            const count = selectedMaLoiValues.size;

            if (count === 0) {
                button.textContent = 'Tất cả mã lỗi';
            } else if (count === 1) {
                const selectedValue = Array.from(selectedMaLoiValues)[0];
                button.innerHTML = `${selectedValue.length > 15 ? selectedValue.substring(0, 15) + '...' : selectedValue}`;
            } else {
                button.innerHTML = `Đã chọn ${count} mã lỗi<span class="badge">${count}</span>`;
            }
        }

        function toggleMaLoiDropdown() {
            const dropdown = document.getElementById('maLoiFilterDropdown');
            const icon = document.querySelector('#maLoiFilterBtn .multi-select-icon');

            dropdown.classList.toggle('hidden');
            icon.style.transform = dropdown.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';

            // Close other dropdowns
            document.getElementById('loiTonFilterDropdown').classList.add('hidden');
            document.getElementById('noiDungLoiFilterDropdown').classList.add('hidden');
            document.querySelector('#loiTonFilterBtn .multi-select-icon').style.transform = 'rotate(0deg)';
            document.querySelector('#noiDungLoiFilterBtn .multi-select-icon').style.transform = 'rotate(0deg)';
        }

        // Nội dung lỗi filter functions
        function populateNoiDungLoiFilter() {
            const noiDungLoiSet = new Set();

            processedData.forEach(item => {
                item.errors.forEach(error => {
                    if (error.noi_dung_loi && error.noi_dung_loi.trim()) {
                        noiDungLoiSet.add(error.noi_dung_loi.trim());
                    }
                });
            });

            allNoiDungLoiValues = Array.from(noiDungLoiSet).sort();
            filteredNoiDungLoiValues = [...allNoiDungLoiValues];
            renderNoiDungLoiOptions();
        }

        function renderNoiDungLoiOptions() {
            const noiDungLoiOptions = document.getElementById('noiDungLoiOptions');
            noiDungLoiOptions.innerHTML = '';

            filteredNoiDungLoiValues.forEach(value => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.innerHTML = `
                  <label>
                      <input type="checkbox" value="${value}" class="noi-dung-loi-checkbox" ${selectedNoiDungLoiValues.has(value) ? 'checked' : ''}>
                      <span title="${value}">${value}</span>
                  </label>
              `;
                noiDungLoiOptions.appendChild(option);
            });
        }

        function filterNoiDungLoiOptions() {
            const searchTerm = document.getElementById('noiDungLoiSearch').value.toLowerCase().trim();

            if (searchTerm === '') {
                filteredNoiDungLoiValues = [...allNoiDungLoiValues];
            } else {
                filteredNoiDungLoiValues = allNoiDungLoiValues.filter(value =>
                    value.toLowerCase().includes(searchTerm)
                );
            }

            renderNoiDungLoiOptions();
        }

        function updateNoiDungLoiFilterText() {
            const button = document.getElementById('noiDungLoiFilterText');
            const count = selectedNoiDungLoiValues.size;

            if (count === 0) {
                button.textContent = 'Tất cả nội dung lỗi';
            } else if (count === 1) {
                const selectedValue = Array.from(selectedNoiDungLoiValues)[0];
                button.innerHTML = `${selectedValue.length > 15 ? selectedValue.substring(0, 15) + '...' : selectedValue}`;
            } else {
                button.innerHTML = `Đã chọn ${count} nội dung<span class="badge">${count}</span>`;
            }
        }

        function toggleNoiDungLoiDropdown() {
            const dropdown = document.getElementById('noiDungLoiFilterDropdown');
            const icon = document.querySelector('#noiDungLoiFilterBtn .multi-select-icon');

            dropdown.classList.toggle('hidden');
            icon.style.transform = dropdown.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';

            // Close other dropdowns
            document.getElementById('loiTonFilterDropdown').classList.add('hidden');
            document.getElementById('maLoiFilterDropdown').classList.add('hidden'); // Thêm dòng này
            document.querySelector('#loiTonFilterBtn .multi-select-icon').style.transform = 'rotate(0deg)';
            document.querySelector('#maLoiFilterBtn .multi-select-icon').style.transform = 'rotate(0deg)'; // Thêm dòng này
        }

        // Filtering
        const applyFilters = debounce(function () {
            const search = document.getElementById('searchInput').value.toLowerCase().trim();
            const boPhan = document.getElementById('boPhanFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            filteredData = processedData.filter(item => {
                // Search filter
                if (search) {
                    const searchableText = [
                        item.order_kd, item.ten_chi_tiet, item.bo_phan, item.ghi_chu
                    ].join(' ').toLowerCase();

                    if (!searchableText.includes(search)) return false;
                }

                // Bo phan filter
                if (boPhan !== 'all' && item.bo_phan !== boPhan) {
                    return false;
                }

                // Date range filter
                if (dateFrom || dateTo) {
                    const hasMatchingDate = item.errors.some(error => {
                        if (!error.ngay_bao_loi) return false;

                        let errorDate;
                        try {
                            errorDate = new Date(error.ngay_bao_loi);
                            if (isNaN(errorDate.getTime())) return false;
                        } catch (e) {
                            return false;
                        }

                        // QUAN TRỌNG: Reset về đầu ngày để so sánh chính xác
                        const errorDateOnly = new Date(errorDate.getFullYear(), errorDate.getMonth(), errorDate.getDate());

                        let withinRange = true;

                        if (dateFrom) {
                            const fromDate = new Date(dateFrom);
                            const fromDateOnly = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
                            withinRange = withinRange && errorDateOnly >= fromDateOnly;
                        }

                        if (dateTo) {
                            const toDate = new Date(dateTo);
                            const toDateOnly = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());
                            withinRange = withinRange && errorDateOnly <= toDateOnly;
                        }

                        return withinRange;
                    });

                    if (!hasMatchingDate) return false;
                }

                // Lỗi tồn filter
                if (selectedLoiTonValues.size > 0) {
                    const itemLoiTon = item.tong_loi;
                    if (item.total_sl_bao_loi > 0 && itemLoiTon !== '') {
                        const numericLoiTon = typeof itemLoiTon === 'number' ? itemLoiTon : parseInt(itemLoiTon);
                        const hasMatch = Array.from(selectedLoiTonValues).some(selectedValue => {
                            const numericSelected = typeof selectedValue === 'number' ? selectedValue : parseInt(selectedValue);
                            return numericLoiTon === numericSelected;
                        });
                        if (!hasMatch) {
                            return false;
                        }
                    } else if (item.total_sl_bao_loi === 0) {
                        return false;
                    }
                }

                // Nội dung lỗi filter
                if (selectedNoiDungLoiValues.size > 0) {
                    const hasMatchingNoiDung = item.errors.some(error =>
                        error.noi_dung_loi && selectedNoiDungLoiValues.has(error.noi_dung_loi.trim())
                    );
                    if (!hasMatchingNoiDung) return false;
                }

                // THÊM ĐOẠN CODE NÀY - Mã lỗi filter
                if (selectedMaLoiValues.size > 0) {
                    const hasMatchingMaLoi = item.errors.some(error =>
                        error.ma_loi && selectedMaLoiValues.has(error.ma_loi.trim())
                    );
                    if (!hasMatchingMaLoi) return false;
                }

                return true;
            });

            currentPage = 0;
            updateStats();
            renderCurrentPage();
            updatePagination();
        }, 500);

        // Stats
        function updateStats() {
            // Tính tổng từ tất cả dữ liệu
            const totalOrders = processedData.length;
            const totalSLL = processedData.reduce((sum, item) => sum + item.sll, 0);
            const totalErrors = processedData.reduce((sum, item) => {
                return sum + (item.total_sl_bao_loi || 0);
            }, 0);

            // Tính từ dữ liệu đã lọc
            const filteredSLL = filteredData.reduce((sum, item) => sum + item.sll, 0);
            const filteredErrors = filteredData.reduce((sum, item) => {
                return sum + (item.total_sl_bao_loi || 0);
            }, 0);

            const avgErrorRate = filteredSLL > 0 ? ((filteredErrors / filteredSLL) * 100).toFixed(1) : '0';
            const displayed = filteredData.length;
            const selected = selectedRows.size;

            document.getElementById('totalOrdersCount').textContent = displayed; // Hiển thị số order đã lọc
            document.getElementById('totalSLLCount').textContent = filteredSLL; // Hiển thị SLL đã lọc
            document.getElementById('totalErrorCount').textContent = filteredErrors; // Hiển thị lỗi đã lọc
            document.getElementById('avgErrorRate').textContent = avgErrorRate + '%';
            document.getElementById('selectedCountStat').textContent = selected;
            document.getElementById('selectedCount').textContent = selected;
            document.getElementById('selectedCountExcel').textContent = selected;
            document.getElementById('filteredCount').textContent = displayed;
        }

        // Populate filters
        function populateFilters() {
            const boPhanSet = new Set();
            processedData.forEach(item => {
                if (item.bo_phan && item.bo_phan.trim()) {
                    boPhanSet.add(item.bo_phan.trim());
                }
            });

            const boPhanSelect = document.getElementById('boPhanFilter');
            boPhanSelect.innerHTML = '<option value="all">Tất cả bộ phận</option>';
            Array.from(boPhanSet).sort().forEach(boPhan => {
                const option = document.createElement('option');
                option.value = boPhan;
                option.textContent = boPhan;
                boPhanSelect.appendChild(option);
            });

            populateLoiTonFilter();
            populateNoiDungLoiFilter();
            populateMaLoiFilter(); // Thêm dòng này
        }

        // Table rendering
        function renderCurrentPage() {
            const tbody = document.getElementById('table-body');
            const startIndex = currentPage * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="41" class="text-center p-8">Không có dữ liệu</td></tr>';
                updatePaginationInfo(0, 0, 0);
                return;
            }

            const fragment = document.createDocumentFragment();

            pageData.forEach((item, index) => {
                const row = createTableRow(item, startIndex + index + 1);
                fragment.appendChild(row);
            });

            tbody.innerHTML = '';
            tbody.appendChild(fragment);

            updatePaginationInfo(startIndex + 1, endIndex, filteredData.length);
            updateSelectAllCheckbox();
        }

        function createTableRow(item, stt) {
            const row = document.createElement('tr');
            row.setAttribute('data-row-id', item._id);

            const isSelected = selectedRows.has(item._id);
            if (isSelected) {
                row.classList.add('selected');
            }

            let html = `
            <td><input type="checkbox" class="checkbox-custom row-checkbox" ${isSelected ? 'checked' : ''}></td>
            <td>${stt}</td>
            <td>${item.order_kd || ''}</td>
            <td title="${item.ten_chi_tiet || ''}">${item.ten_chi_tiet || ''}</td>
            <td>${item.sll || ''}</td>
            <td>${item.tt || ''}</td>
            <td title="${item.tinh_chat || ''}">${item.tinh_chat || ''}</td>
            <td>${item.thoi_han || 'Theo KH'}</td>
            <td class="${item.tong_loi || ''}">${item.tong_loi !== '' ? item.tong_loi : ''}</td>
        `;

            // Add 5 error report columns
            for (let i = 0; i < 5; i++) {
                const error = item.errors[i];
                if (error) {
                    html += `
                    <td class="error-cell">${formatDate(error.ngay_bao_loi)}</td>
                    <td class="error-cell" title="${error.noi_dung_loi || ''}">${error.noi_dung_loi || ''}</td>
                    <td class="error-cell">${error.sl_loi || ''}</td>
                `;
                } else {
                    html += '<td class="error-cell"></td><td class="error-cell"></td><td class="error-cell"></td>';
                }
            }

            // Add 5 return columns
            for (let i = 0; i < 5; i++) {
                const error = item.errors[i];
                if (error && error.ngay_tra_loi) {
                    html += `
                    <td class="return-cell">${formatDate(error.ngay_tra_loi)}</td>
                    <td class="return-cell">${error.sl_tra || ''}</td>
                `;
                } else {
                    html += '<td class="return-cell"></td><td class="return-cell"></td>';
                }
            }

            html += `
            <td>${item.so_lan_loi || ''}</td>
            <td>${item.ty_le_loi || ''}%</td>
            <td>${item.bo_phan || ''}</td>
            <td></td>
            <td></td>
            <td></td>
            <td title="${item.ghi_chu || ''}">${item.ghi_chu || ''}</td>
        `;

            row.innerHTML = html;
            return row;
        }

        // Pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            html += `<button ${currentPage === 0 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
           <i class="fas fa-chevron-left"></i>
       </button>`;

            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages - 1, currentPage + 2);

            if (startPage > 0) {
                html += `<button onclick="goToPage(0)">1</button>`;
                if (startPage > 1) {
                    html += '<span>...</span>';
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
               ${i + 1}
           </button>`;
            }

            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    html += '<span>...</span>';
                }
                html += `<button onclick="goToPage(${totalPages - 1})">${totalPages}</button>`;
            }

            html += `<button ${currentPage >= totalPages - 1 ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
           <i class="fas fa-chevron-right"></i>
       </button>`;

            pagination.innerHTML = html;
        }

        function updatePaginationInfo(start, end, total) {
            document.getElementById('paginationInfo').textContent =
                `Hiển thị ${start} - ${end} của ${total} kết quả`;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (page < 0 || page >= totalPages) return;

            currentPage = page;
            renderCurrentPage();
            updatePagination();
        }

        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            currentPage = 0;
            renderCurrentPage();
            updatePagination();
        }

        // Selection handling
        function handleRowSelection(checkbox, rowId) {
            const row = checkbox.closest('tr');

            if (checkbox.checked) {
                selectedRows.set(rowId, true);
                row.classList.add('selected');
            } else {
                selectedRows.delete(rowId);
                row.classList.remove('selected');
            }

            updateStats();
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const currentPageIds = getCurrentPageRowIds();
            const selectedInCurrentPage = currentPageIds.filter(id => selectedRows.has(id)).length;

            if (selectedInCurrentPage === 0) {
                checkbox.indeterminate = false;
                checkbox.checked = false;
            } else if (selectedInCurrentPage === currentPageIds.length) {
                checkbox.indeterminate = false;
                checkbox.checked = true;
            } else {
                checkbox.indeterminate = true;
            }
        }

        function getCurrentPageRowIds() {
            return Array.from(document.querySelectorAll('#table-body tr[data-row-id]'))
                .map(row => row.getAttribute('data-row-id'));
        }

        function selectAllCurrentPage() {
            const currentPageIds = getCurrentPageRowIds();
            currentPageIds.forEach(id => selectedRows.set(id, true));

            document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('tr').classList.add('selected');
            });

            updateStats();
            updateSelectAllCheckbox();
        }

        function selectAllFiltered() {
            filteredData.forEach(item => selectedRows.set(item._id, true));

            document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('tr').classList.add('selected');
            });

            updateStats();
            updateSelectAllCheckbox();
        }

        function clearAllSelection() {
            selectedRows.clear();

            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('tr.selected').forEach(row => {
                row.classList.remove('selected');
            });

            updateStats();
            updateSelectAllCheckbox();
        }

        // Export functionality (giữ nguyên như code gốc)
        function generateExport() {
            const selectedItems = filteredData.filter(item => selectedRows.has(item._id));

            if (selectedItems.length === 0) {
                alert('Vui lòng chọn ít nhất một dòng để in báo cáo');
                return;
            }

            generateExportTemplate(selectedItems);
        }

        // Hàm tạo workbook Excel với định dạng
        // Hàm tạo và xuất Excel với định dạng đầy đủ
        async function generateExcelExport() {
            const selectedItems = filteredData.filter(item => selectedRows.has(item._id));

            if (selectedItems.length === 0) {
                alert('Vui lòng chọn ít nhất một dòng để xuất Excel');
                return;
            }

            try {
                // Hiển thị loading
                const exportBtn = document.getElementById('exportExcelBtn');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<div class="loading"></div> Đang xuất...';
                exportBtn.disabled = true;

                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Tổng hợp lỗi');

                await createExcelWorksheetWithFormat(worksheet, selectedItems);

                // Tạo tên file với ngày hiện tại
                const today = new Date();
                const dateStr = `${today.getDate()}_${today.getMonth() + 1}_${today.getFullYear()}`;
                const filename = `Tong_hop_loi_ton_dong_${dateStr}.xlsx`;

                // Xuất file
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                // Tạo link download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);

                // Khôi phục nút
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;

            } catch (error) {
                console.error('Lỗi xuất Excel:', error);
                alert('Có lỗi xảy ra khi xuất Excel. Vui lòng thử lại.');

                // Khôi phục nút
                const exportBtn = document.getElementById('exportExcelBtn');
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }
        }

        // Tạo worksheet với định dạng chi tiết
        // Cập nhật hàm createExcelWorksheetWithFormat
        async function createExcelWorksheetWithFormat(worksheet, selectedItems) {
            const today = new Date();
            const currentDate = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;

            // Thiết lập trang in A4 ngang
            worksheet.pageSetup = {
                paperSize: 9, // A4
                orientation: 'landscape', // Ngang
                fitToPage: true,
                fitToWidth: 1,
                fitToHeight: 0,
                margins: {
                    left: 0.25,
                    right: 0.25,
                    top: 0.75,
                    bottom: 0.75,
                    header: 0.3,
                    footer: 0.3
                },
                printArea: 'A1:AL1000',
                scale: 100
            };

            // Thiết lập độ rộng cột được tối ưu cho A4 ngang
            worksheet.columns = [
                { width: 4 },    // A - Số tt
                { width: 8 },    // B - Order KD
                { width: 12 },   // C - Tên chi tiết
                { width: 6 },    // D - Slg lệnh
                { width: 6 },    // E - AMJ XN (MỚI)
                { width: 12 },   // F - Tinh chất đơn hàng (MỚI)
                { width: 8 },    // E - Thời hạn
                { width: 6 },    // F - Tổng SL tồn lỗi
                // Báo lỗi lần 1-5 (G-U)
                { width: 6 }, { width: 10 }, { width: 4 }, // G,H,I - Lần 1
                { width: 6 }, { width: 10 }, { width: 4 }, // J,K,L - Lần 2
                { width: 6 }, { width: 10 }, { width: 4 }, // M,N,O - Lần 3
                { width: 6 }, { width: 10 }, { width: 4 }, // P,Q,R - Lần 4
                { width: 6 }, { width: 10 }, { width: 4 }, // S,T,U - Lần 5
                // Trả lần 1-5 (V-AE)
                { width: 6 }, { width: 4 }, // V,W - Trả lần 1
                { width: 6 }, { width: 4 }, // X,Y - Trả lần 2
                { width: 6 }, { width: 4 }, // Z,AA - Trả lần 3
                { width: 6 }, { width: 4 }, // AB,AC - Trả lần 4
                { width: 6 }, { width: 4 }, // AD,AE - Trả lần 5
                // Các cột cuối (AF-AL)
                { width: 5 },    // AF - Số lần báo lỗi
                { width: 5 },    // AG - Tỷ lệ lỗi
                { width: 12 },   // AH - Bộ phận
                { width: 8 },    // AI - Máy sửa
                { width: 8 },    // AJ - Hẹn sửa xong
                { width: 8 },    // AK - Kiểm tra
                { width: 12 }    // AL - Ghi chú
            ];

            // Tiêu đề chính (dòng 1)
            const titleRow = worksheet.addRow([`TỔNG HỢP LỖI CÒN TỒN ĐỌNG TRONG NGÀY ${currentDate}`]);
            worksheet.mergeCells('A1:AL1');
            titleRow.getCell(1).style = {
                font: { name: 'Times New Roman', size: 12, bold: true },
                alignment: { horizontal: 'center', vertical: 'middle' }
            };
            titleRow.height = 20;

            // Dòng trống
            worksheet.addRow([]);

            // Header chính (dòng 3)
            const mainHeaderRow = worksheet.addRow([
                'Số tt', 'Order KD', 'Tên chi tiết', 'Slg lệnh', 'AMJ XN', 'Tinh chất đơn hàng', 'Thời hạn KH', 'Tổng SL tồn lỗi',
                'Báo lỗi lần 1', '', '', 'Báo lỗi lần 2', '', '', 'Báo lỗi lần 3', '', '',
                'Báo lỗi lần 4', '', '', 'Báo lỗi lần 5', '', '',
                'Trả lần 1', '', 'Trả lần 2', '', 'Trả lần 3', '', 'Trả lần 4', '', 'Trả lần 5', '',
                'Số lần BL', 'Tỷ lệ lỗi', 'Bộ phận phát sinh lỗi',
                'Xác nhận SX AMJ', '', 'Kiểm tra', 'Ghi chú'
            ]);

            // Sub-header (dòng 4)
            const subHeaderRow = worksheet.addRow([
                '', '', '', '', '', '', '', '',
                'Ngày', 'Nội dung', 'SL',
                'Ngày', 'Nội dung', 'SL',
                'Ngày', 'Nội dung', 'SL',
                'Ngày', 'Nội dung', 'SL',
                'Ngày', 'Nội dung', 'SL',
                'Ngày', 'SL', 'Ngày', 'SL', 'Ngày', 'SL',
                'Ngày', 'SL', 'Ngày', 'SL',
                '', '', '', 'Máy sửa', 'Hẹn sửa', '', ''
            ]);

            // THÊM MỚI: Hàng với dấu * ở TẤT CẢ các cột, màu nền trắng (dòng 5)
            const emptyRowWithStar = worksheet.addRow([
                '*', '*', '*', '*', '*', '*',
                '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*',
                '*', '*', '*', '*', '*', '*', '*', '*', '*', '*',
                '*', '*', '*', '*', '*', '*', '*'
            ]);

            // Merge cells cho header - KHÔNG merge hàng với dấu * (chỉ merge dòng 3 và 4)
            const merges = [
                'A3:A4', 'B3:B4', 'C3:C4', 'D3:D4', 'E3:E4', 'F3:F4', 'G3:G4', 'H3:H4', // Merge 2 dòng cho các cột đơn
                'I3:K3', 'L3:N3', 'O3:Q3', 'R3:T3', 'U3:W3', // Merge ngang cho báo lỗi (đã điều chỉnh từ G-I thành I-K)
                'X3:Y3', 'Z3:AA3', 'AB3:AC3', 'AD3:AE3', 'AF3:AG3', // Merge ngang cho trả lần (đã điều chỉnh từ V-W thành X-Y)
                'AH3:AH4', 'AI3:AI4', 'AJ3:AJ4', // Merge 2 dòng cho các cột đơn (đã điều chỉnh từ AF, AG, AH)
                'AK3:AL3', 'AM3:AM4', 'AN3:AN4' // Merge 2 dòng cho các cột đơn (đã điều chỉnh từ AI-AJ, AK, AL)
            ];

            merges.forEach(range => {
                worksheet.mergeCells(range);
            });

            // Định dạng header với border đen liền
            const headerBorderStyle = {
                top: { style: 'thin', color: { argb: '000000' } },
                bottom: { style: 'thin', color: { argb: '000000' } },
                left: { style: 'thin', color: { argb: '000000' } },
                right: { style: 'thin', color: { argb: '000000' } }
            };

            const headerStyle = {
                font: { name: 'Times New Roman', size: 7, bold: true },
                alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                border: headerBorderStyle
            };

            // Áp dụng style cho header rows (chỉ dòng 3 và 4)
            [mainHeaderRow, subHeaderRow].forEach(row => {
                row.eachCell(cell => {
                    cell.style = { ...headerStyle };
                });
            });

            // Định dạng riêng cho hàng với dấu * (dòng 5) - màu nền TRẮNG, không merge
            emptyRowWithStar.eachCell(cell => {
                cell.style = {
                    font: { name: 'Times New Roman', size: 6, bold: false, color: { argb: '808080' } },
                    alignment: { horizontal: 'center', vertical: 'middle' },
                    border: headerBorderStyle,
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } } // Màu trắng
                };
            });

            // Màu nền cho các nhóm cột header (CHỈ áp dụng cho dòng 3 và 4, KHÔNG áp dụng cho dòng 5)
            const errorBgColor = 'FDE9D9';
            const returnBgColor = 'EBF1DE';

            // Áp dụng màu nền cho cột báo lỗi (G-U) - chỉ cho dòng 3 và 4
            for (let col = 7; col <= 21; col++) {
                mainHeaderRow.getCell(col).fill = {
                    type: 'pattern', pattern: 'solid', fgColor: { argb: errorBgColor }
                };
                subHeaderRow.getCell(col).fill = {
                    type: 'pattern', pattern: 'solid', fgColor: { argb: errorBgColor }
                };
            }

            // Áp dụng màu nền cho cột trả lỗi (V-AE) - chỉ cho dòng 3 và 4
            for (let col = 22; col <= 31; col++) {
                mainHeaderRow.getCell(col).fill = {
                    type: 'pattern', pattern: 'solid', fgColor: { argb: returnBgColor }
                };
                subHeaderRow.getCell(col).fill = {
                    type: 'pattern', pattern: 'solid', fgColor: { argb: returnBgColor }
                };
            }

            // Màu chữ đặc biệt cho header
            const redTextColor = 'DC2626';
            const blueTextColor = '4C73C0';

            [33, 34].forEach(col => {
                mainHeaderRow.getCell(col).font = {
                    ...mainHeaderRow.getCell(col).font,
                    color: { argb: redTextColor }
                };
            });

            [35, 36].forEach(col => {
                mainHeaderRow.getCell(col).font = {
                    ...mainHeaderRow.getCell(col).font,
                    color: { argb: blueTextColor }
                };
                subHeaderRow.getCell(col).font = {
                    ...subHeaderRow.getCell(col).font,
                    color: { argb: blueTextColor }
                };
            });

            // Thêm dữ liệu với định dạng giống y hệt bản in (bắt đầu từ dòng 6)
            selectedItems.forEach((item, index) => {
                const rowData = [
                    index + 1,
                    item.order_kd ? parseFloat(item.order_kd) || item.order_kd : '',
                    item.ten_chi_tiet || '',
                    item.sll || '',
                    item.tt || '', // MỚI
                    item.tinh_chat || '', // MỚI
                    item.thoi_han || 'Theo KH',
                    item.tong_loi === 0 ? 0 : (item.tong_loi || '')
                ];

                // Thêm dữ liệu báo lỗi 5 lần
                for (let i = 0; i < 5; i++) {
                    const error = item.errors[i];
                    if (error) {
                        rowData.push(
                            formatDate(error.ngay_bao_loi) || '',
                            error.noi_dung_loi || '',
                            error.sl_loi || ''
                        );
                    } else {
                        rowData.push('', '', '');
                    }
                }

                // Thêm dữ liệu trả lỗi 5 lần
                for (let i = 0; i < 5; i++) {
                    const error = item.errors[i];
                    if (error && error.ngay_tra_loi) {
                        rowData.push(
                            formatDate(error.ngay_tra_loi) || '',
                            error.sl_tra || ''
                        );
                    } else {
                        rowData.push('', '');
                    }
                }

                // Thêm các cột cuối
                rowData.push(
                    item.so_lan_loi || '',
                    item.ty_le_loi ? item.ty_le_loi + '%' : '',
                    item.bo_phan || '',
                    '', '', '', item.ghi_chu || ''
                );

                const dataRow = worksheet.addRow(rowData);

                // Định dạng cho dòng dữ liệu
                dataRow.eachCell((cell, colNumber) => {
                    let cellBorder = {
                        top: { style: 'thin', color: { argb: '000000' } },
                        left: { style: 'thin', color: { argb: '000000' } },
                        right: { style: 'thin', color: { argb: '000000' } },
                        bottom: { style: 'dotted', color: { argb: 'D3D3D3' } }
                    };

                    cell.style = {
                        font: {
                            name: 'Times New Roman',
                            size: 7,
                            bold: false,
                            color: { argb: '000000' }
                        },
                        alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                        border: cellBorder
                    };

                    // Thêm định dạng số cho cột Order KD
                    if (colNumber === 2) {
                        cell.numFmt = '0';
                    }

                    // Màu nền cho các cột báo lỗi
                    if (colNumber >= 7 && colNumber <= 21) {
                        cell.fill = {
                            type: 'pattern', pattern: 'solid', fgColor: { argb: errorBgColor }
                        };
                    }
                    // Màu nền cho các cột trả lỗi
                    else if (colNumber >= 22 && colNumber <= 31) {
                        cell.fill = {
                            type: 'pattern', pattern: 'solid', fgColor: { argb: returnBgColor }
                        };
                    }
                });

                dataRow.height = 20;
            });

            // Border cho dòng cuối cùng
            if (selectedItems.length > 0) {
                const lastRowNumber = 5 + selectedItems.length;
                const lastRow = worksheet.getRow(lastRowNumber);

                for (let col = 1; col <= 38; col++) {
                    const cell = lastRow.getCell(col);
                    if (cell.style && cell.style.border) {
                        cell.style.border.bottom = { style: 'thin', color: { argb: '000000' } };
                    }
                }
            }
        }

        // Tạo worksheet với định dạng giống bản in
        function createExcelWorksheet(selectedItems) {
            const today = new Date();
            const currentDate = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;

            // Tạo dữ liệu cho Excel
            const data = [];

            // Tiêu đề chính
            data.push([`TỔNG HỢP LỖI CÒN TỒN ĐỌNG TRONG NGÀY ${currentDate}`]);
            data.push([]); // Dòng trống

            // Header chính (dòng 1)
            const mainHeader = [
                'Số tt',
                'Order KD',
                'Tên chi tiết',
                'Slg lệnh',
                'Thời hạn khách hàng',
                'Tổng SL tồn lỗi',
                'Báo lỗi lần 1', '', '',
                'Báo lỗi lần 2', '', '',
                'Báo lỗi lần 3', '', '',
                'Báo lỗi lần 4', '', '',
                'Báo lỗi lần 5', '', '',
                'Trả lần 1', '',
                'Trả lần 2', '',
                'Trả lần 3', '',
                'Trả lần 4', '',
                'Trả lần 5', '',
                'Số lần báo lỗi',
                'Tỷ lệ lỗi',
                'Bộ phận phát sinh lỗi',
                'Xác nhận của SX AMJ', '',
                'Kiểm tra xác nhận lại',
                'Ghi chú'
            ];
            data.push(mainHeader);

            // Sub-header (dòng 2)
            const subHeader = [
                '', '', '', '', '', '',
                'Ngày BL', 'Nội dung lỗi', 'SL BL',
                'Ngày BL', 'Nội dung lỗi', 'SL BL',
                'Ngày BL', 'Nội dung lỗi', 'SL BL',
                'Ngày BL', 'Nội dung lỗi', 'SL BL',
                'Ngày BL', 'Nội dung lỗi', 'SL BL',
                'Ngày trả', 'SL trả',
                'Ngày trả', 'SL trả',
                'Ngày trả', 'SL trả',
                'Ngày trả', 'SL trả',
                'Ngày trả', 'SL trả',
                '', '', '',
                'Máy sửa', 'Hẹn sửa xong',
                '', ''
            ];
            data.push(subHeader);

            // Dữ liệu các dòng
            selectedItems.forEach((item, index) => {
                const row = [
                    index + 1,
                    item.order_kd || '',
                    item.ten_chi_tiet || '',
                    item.sll || '',
                    item.thoi_han || 'Theo KH',
                    item.tong_loi === 0 ? '0' : (item.tong_loi || '')
                ];

                // Thêm dữ liệu báo lỗi 5 lần
                for (let i = 0; i < 5; i++) {
                    const error = item.errors[i];
                    if (error) {
                        row.push(
                            formatDate(error.ngay_bao_loi),
                            error.noi_dung_loi || '',
                            error.sl_loi || ''
                        );
                    } else {
                        row.push('', '', '');
                    }
                }

                // Thêm dữ liệu trả lỗi 5 lần
                for (let i = 0; i < 5; i++) {
                    const error = item.errors[i];
                    if (error && error.ngay_tra_loi) {
                        row.push(
                            formatDate(error.ngay_tra_loi),
                            error.sl_tra || ''
                        );
                    } else {
                        row.push('', '');
                    }
                }

                // Thêm các cột cuối
                row.push(
                    item.so_lan_loi || '',
                    (item.ty_le_loi || '') + '%',
                    item.bo_phan || '',
                    '', // Máy sửa
                    '', // Hẹn sửa xong
                    '', // Kiểm tra xác nhận lại
                    item.ghi_chu || ''
                );

                data.push(row);
            });

            // Tạo worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Thiết lập độ rộng cột
            const colWidths = [
                { wch: 5 },   // Số tt
                { wch: 12 },  // Order KD
                { wch: 15 },  // Tên chi tiết
                { wch: 8 },   // Slg lệnh
                { wch: 12 },  // Thời hạn
                { wch: 10 },  // Tổng SL tồn lỗi
                // Báo lỗi lần 1-5
                { wch: 10 }, { wch: 15 }, { wch: 8 },
                { wch: 10 }, { wch: 15 }, { wch: 8 },
                { wch: 10 }, { wch: 15 }, { wch: 8 },
                { wch: 10 }, { wch: 15 }, { wch: 8 },
                { wch: 10 }, { wch: 15 }, { wch: 8 },
                // Trả lần 1-5
                { wch: 10 }, { wch: 8 },
                { wch: 10 }, { wch: 8 },
                { wch: 10 }, { wch: 8 },
                { wch: 10 }, { wch: 8 },
                { wch: 10 }, { wch: 8 },
                // Các cột cuối
                { wch: 8 },   // Số lần báo lỗi
                { wch: 8 },   // Tỷ lệ lỗi
                { wch: 20 },  // Bộ phận
                { wch: 12 },  // Máy sửa
                { wch: 12 },  // Hẹn sửa xong
                { wch: 15 },  // Kiểm tra
                { wch: 20 }   // Ghi chú
            ];
            ws['!cols'] = colWidths;

            // Merge cells cho tiêu đề
            if (!ws['!merges']) ws['!merges'] = [];

            // Merge tiêu đề chính
            ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 38 } });

            // Merge cells cho header chính
            const mergeRanges = [
                // Báo lỗi lần 1-5 (mỗi lần có 3 cột)
                { s: { r: 2, c: 6 }, e: { r: 2, c: 8 } },   // Báo lỗi lần 1
                { s: { r: 2, c: 9 }, e: { r: 2, c: 11 } },  // Báo lỗi lần 2
                { s: { r: 2, c: 12 }, e: { r: 2, c: 14 } }, // Báo lỗi lần 3
                { s: { r: 2, c: 15 }, e: { r: 2, c: 17 } }, // Báo lỗi lần 4
                { s: { r: 2, c: 18 }, e: { r: 2, c: 20 } }, // Báo lỗi lần 5
                // Trả lần 1-5 (mỗi lần có 2 cột)
                { s: { r: 2, c: 21 }, e: { r: 2, c: 22 } }, // Trả lần 1
                { s: { r: 2, c: 23 }, e: { r: 2, c: 24 } }, // Trả lần 2
                { s: { r: 2, c: 25 }, e: { r: 2, c: 26 } }, // Trả lần 3
                { s: { r: 2, c: 27 }, e: { r: 2, c: 28 } }, // Trả lần 4
                { s: { r: 2, c: 29 }, e: { r: 2, c: 30 } }, // Trả lần 5
                // Xác nhận của SX AMJ
                { s: { r: 2, c: 34 }, e: { r: 2, c: 35 } }
            ];

            // Merge các cột đơn từ dòng 2 đến dòng 3
            const singleCols = [0, 1, 2, 3, 4, 5, 31, 32, 33, 36, 37];
            singleCols.forEach(col => {
                mergeRanges.push({ s: { r: 2, c: col }, e: { r: 3, c: col } });
            });

            ws['!merges'].push(...mergeRanges);

            // Áp dụng định dạng
            applyExcelFormatting(ws, data.length);

            return ws;
        }

        // Áp dụng định dạng cho Excel
        function applyExcelFormatting(ws, dataLength) {
            const range = XLSX.utils.decode_range(ws['!ref']);

            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cellAddress]) continue;

                    const cell = ws[cellAddress];

                    // Định dạng chung cho tất cả các cell
                    cell.s = {
                        font: { name: 'Times New Roman', sz: 10 },
                        alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                        border: {
                            top: { style: 'thin', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: { style: 'thin', color: { rgb: '000000' } },
                            right: { style: 'thin', color: { rgb: '000000' } }
                        }
                    };

                    // Định dạng cho tiêu đề chính
                    if (R === 0) {
                        cell.s.font = { name: 'Times New Roman', sz: 14, bold: true };
                        cell.s.alignment = { horizontal: 'center', vertical: 'middle' };
                        delete cell.s.border;
                    }
                    // Định dạng cho header
                    else if (R === 2 || R === 3) {
                        cell.s.font.bold = true;
                        cell.s.font.sz = 9;

                        // Màu nền cho các cột báo lỗi
                        if (C >= 6 && C <= 20) {
                            cell.s.fill = { fgColor: { rgb: 'FDE9D9' } };
                        }
                        // Màu nền cho các cột trả lỗi
                        else if (C >= 21 && C <= 30) {
                            cell.s.fill = { fgColor: { rgb: 'EBF1DE' } };
                        }
                        // Màu chữ cho xác nhận SX AMJ
                        else if (C >= 34 && C <= 35) {
                            cell.s.font.color = { rgb: '4C73C0' };
                        }
                    }
                    // Định dạng cho dữ liệu
                    else if (R > 3) {
                        cell.s.font.sz = 8;

                        // Màu nền cho các cột báo lỗi
                        if (C >= 6 && C <= 20) {
                            cell.s.fill = { fgColor: { rgb: 'FDE9D9' } };
                        }
                        // Màu nền cho các cột trả lỗi
                        else if (C >= 21 && C <= 30) {
                            cell.s.fill = { fgColor: { rgb: 'EBF1DE' } };
                        }

                        // Định dạng màu chữ cho các cột đặc biệt
                        if (C === 5 || C === 8 || C === 11 || C === 14 || C === 17 || C === 20) { // Cột SL lỗi
                            cell.s.font.color = { rgb: 'DC2626' };
                            cell.s.font.bold = true;
                        }
                        else if (C === 32) { // Cột tỷ lệ lỗi
                            const value = parseFloat(cell.v);
                            if (value > 5) {
                                cell.s.font.color = { rgb: 'DC2626' };
                            } else if (value > 2) {
                                cell.s.font.color = { rgb: 'CA8A04' };
                            } else {
                                cell.s.font.color = { rgb: '16A34A' };
                            }
                            cell.s.font.bold = true;
                        }
                        else if (C === 4 || C === 31) { // Cột SLL và số lần báo lỗi
                            cell.s.font.bold = true;
                        }
                    }
                }
            }
        }

        function generateExportTemplate(selectedItems) {
            const printArea = document.getElementById('printArea');
            const today = new Date();
            const currentDate = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;

            let content = `
               <div style="font-family:'Times New Roman', Times, serif; margin: 0; padding: 15px;">
                   <div style="text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 15px;">
                       TỔNG HỢP LỖI CÒN TỒN ĐỌNG TRONG NGÀY ${currentDate}
                   </div>
                   
                   <table style="width: 100%; border-collapse: collapse; border: 0.5px solid #000; font-size: 7px; ">
                       <thead>
                           <tr>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 13px;">Số<br>tt</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 52px;">Order<br>KD</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 65px;">Tên<br>chi tiết</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 20px;">Slg<br>lệnh</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 25px;">AMJ<br>XN</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 50px;">Tinh chất<br>đơn hàng</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 42px;">Thời hạn<br>khách hàng</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 25px;">Tổng<br>SL tồn lỗi</th>
                               <th colspan="3" style="border: 0.5px solid #000; padding: 1px; background: #fde9d9; text-align: center;">Báo lỗi lần 1</th>
                               <th colspan="3" style="border: 0.5px solid #000; padding: 1px; background: #fde9d9; text-align: center;">Báo lỗi lần 2</th>
                               <th colspan="3" style="border: 0.5px solid #000; padding: 1px; background: #fde9d9; text-align: center;">Báo lỗi lần 3</th>
                               <th colspan="3" style="border: 0.5px solid #000; padding: 1px; background: #fde9d9; text-align: center;">Báo lỗi lần 4</th>
                               <th colspan="3" style="border: 0.5px solid #000; padding: 1px; background: #fde9d9; text-align: center;">Báo lỗi lần 5</th>
                               <th colspan="2" style="border: 0.5px solid #000; padding: 1px; background: #ebf1de; text-align: center;">Trả lần 1</th>
                               <th colspan="2" style="border: 0.5px solid #000; padding: 1px; background: #ebf1de; text-align: center;">Trả lần 2</th>
                               <th colspan="2" style="border: 0.5px solid #000; padding: 1px; background: #ebf1de; text-align: center;">Trả lần 3</th>
                               <th colspan="2" style="border: 0.5px solid #000; padding: 1px; background: #ebf1de; text-align: center;">Trả lần 4</th>
                               <th colspan="2" style="border: 0.5px solid #000; padding: 1px; background: #ebf1de; text-align: center;">Trả lần 5</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 30px;">Số lần<br>báo lỗi</th>
                               <th rowspan="2" style="border: 0.5px solid #000; padding: 1px; color: red; width: 25px;">Tỷ lệ<br>lỗi</th>
                               <th rowspan="2" style="border: 0.5px solid #000; padding: 1px; color: red; width: 80px;">Bộ phận phát sinh lỗi</th>
                               <th colspan="2" style="border: 0.5px solid #000; padding: 1px; text-align: center; color: #4c73c0;">Xác nhận của SX AMJ</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 73px;">Kiểm tra<br>xác nhận lại</th>
                               <th rowspan="2" style=" font-weight: normal;border: 0.5px solid #000; padding: 1px; width: 100px;">Ghi<br>chú</th>
                           </tr>
                           <tr>
           `;

            // Add sub-headers for each Báo lỗi lần
            for (let i = 1; i <= 5; i++) {
                content += `
                   <th style="border: 0.5px solid #000; padding: 1px; background: #fde9d9; font-weight: normal; font-size: 6px; width: 37px;">Ngày<br>BL</th>
                   <th style="border: 0.5px solid #000; padding: 1px; background: #fde9d9; font-weight: normal; font-size: 6px; width: 60px;">Nội dung lỗi</th>
                   <th style="border: 0.5px solid #000; padding: 1px; font-weight: normal; background: #fde9d9; font-size: 6px; width: 15px;">SL<br>BL</th>
               `;
            }

            // Add sub-headers for each Trả lần
            for (let i = 1; i <= 5; i++) {
                content += `
                   <th style="border: 0.5px solid #000; padding: 1px; font-weight: normal; background: #ebf1de; font-size: 7px; width: 37px;">Ngày<br>trả</th>
                   <th style="border: 0.5px solid #000; padding: 1px; font-weight: normal; background: #ebf1de; font-size: 7px; width: 15px;">SL<br>trả</th>
               `;
            }

            // Add sub-headers for Xác nhận của SX AMJ
            content += `
                   <th style="border: 0.5px solid #000; padding: 1px; font-weight: normal; font-size: 7px; color: #4c73c0; width: 45px;">Máy sửa</th>
                   <th style="border: 0.5px solid #000; padding: 1px; font-weight: normal; font-size: 7px; color: #4c73c0; width: 75px;">Hẹn sửa xong</th>
           `;

            content += `
                           </tr>
                       </thead>
                       <tbody>
           `;

            selectedItems.forEach((item, index) => {
                content += `<tr style="font - size: 8px;">`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px; ">${index + 1}</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px; ">${item.order_kd || ''}</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px; ">${item.ten_chi_tiet || ''}</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px;">${item.sll || ''}</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px;">${item.tt || ''}</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px;">${item.tinh_chat || ''}</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px; ">${item.thoi_han || 'Theo KH'}</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px; ">${item.tong_loi === 0 ? '0' : (item.tong_loi || '')}</td>`;

                // Add error data for 5 occurrences (Báo lỗi)
                for (let i = 0; i < 5; i++) {
                    const error = item.errors[i];
                    if (error) {
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; background: #fde9d9; padding: 1px; text-align: center; height: 20px; ">${formatDate(error.ngay_bao_loi)}</td>`;
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; background: #fde9d9; padding: 1px; font-size: 7px;">${error.noi_dung_loi || ''}</td>`;
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; background: #fde9d9; padding: 1px; text-align: center; height: 20px;  ">${error.sl_loi || ''}</td>`;
                    } else {
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; background: #fde9d9; padding: 1px;"></td>`;
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; background: #fde9d9; padding: 1px;"></td>`;
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; background: #fde9d9; padding: 1px;"></td>`;
                    }
                }

                // Add return data for 5 occurrences (Trả lần)
                for (let i = 0; i < 5; i++) {
                    const error = item.errors[i];
                    if (error && error.ngay_tra_loi) {
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; background: #ebf1de;  padding: 1px; text-align: center; height: 20px; ">${formatDate(error.ngay_tra_loi)}</td>`;
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3;  background: #ebf1de; padding: 1px; text-align: center; height: 20px; ">${error.sl_tra || ''}</td>`;
                    } else {
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; background: #ebf1de;  padding: 1px;"></td>`;
                        content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; background: #ebf1de;  padding: 1px;"></td>`;
                    }
                }

                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px;">${item.so_lan_loi || ''}</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; text-align: center; height: 20px;">${item.ty_le_loi || ''}%</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; font-size: 7px; text-align: center;">${item.bo_phan || ''}</td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; font-size: 7px;"></td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; font-size: 7px;"></td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; font-size: 7px;"></td>`;
                content += `<td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; font-size: 7px;">${item.ghi_chu || ''}</td>`;
                content += `</tr>`;
            });

            content += `
                       </tbody>
                   </table>
               </div>
           `;

            printArea.innerHTML = content;

            // Create iframe for printing
            const iframe = document.createElement('iframe');
            iframe.name = 'print_frame';
            iframe.style.position = 'absolute';
            iframe.style.top = '-1000px';
            iframe.style.left = '-1000px';
            document.body.appendChild(iframe);

            const frameDoc = iframe.contentWindow ? iframe.contentWindow : iframe.contentDocument.document ? iframe.contentDocument.document : iframe.contentDocument;
            frameDoc.document.open();
            frameDoc.document.write(`
               <title>Tổng hợp lỗi còn tồn đọng</title>
               <style>
                   @page { 
                       size: A4 landscape;
                       margin: 0;
                   }
                   body {
                       font-family: 'Times New Roman', Times, serif;
                       margin: 0;
                       padding: 0;
                   }
               </style>
               ${content}
           `);
            frameDoc.document.close();

            setTimeout(function () {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                document.body.removeChild(iframe);
            }, 500);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Search and basic filters
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('boPhanFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFromFilter').addEventListener('change', applyFilters);
            document.getElementById('dateToFilter').addEventListener('change', applyFilters);

            // Page size
            document.getElementById('pageSizeSelect').addEventListener('change', function () {
                changePageSize(this.value);
            });

            // Lỗi tồn filter events
            document.getElementById('loiTonFilterBtn').addEventListener('click', function (e) {
                e.stopPropagation();
                toggleLoiTonDropdown();
            });

            // Individual lỗi tồn checkboxes
            document.getElementById('loiTonOptions').addEventListener('change', function (e) {
                if (e.target.classList.contains('loi-ton-checkbox')) {
                    const value = e.target.value;
                    const numericValue = isNaN(value) ? value : parseInt(value);

                    if (e.target.checked) {
                        selectedLoiTonValues.add(numericValue);
                    } else {
                        selectedLoiTonValues.delete(numericValue);
                    }

                    // Update select all checkbox
                    const allCheckboxes = document.querySelectorAll('.loi-ton-checkbox');
                    const checkedCheckboxes = document.querySelectorAll('.loi-ton-checkbox:checked');
                    const selectAllCheckbox = document.getElementById('selectAllLoiTon');

                    if (checkedCheckboxes.length === 0) {
                        selectAllCheckbox.indeterminate = false;
                        selectAllCheckbox.checked = false;
                    } else if (checkedCheckboxes.length === allCheckboxes.length) {
                        selectAllCheckbox.indeterminate = false;
                        selectAllCheckbox.checked = true;
                    } else {
                        selectAllCheckbox.indeterminate = true;
                    }

                    updateLoiTonFilterText();
                    applyFilters();
                }
            });

            // Select all lỗi tồn
            document.getElementById('selectAllLoiTon').addEventListener('change', function () {
                const checkboxes = document.querySelectorAll('.loi-ton-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });

                if (this.checked) {
                    checkboxes.forEach(checkbox => {
                        const value = checkbox.value;
                        const numericValue = isNaN(value) ? value : parseInt(value);
                        selectedLoiTonValues.add(numericValue);
                    });
                } else {
                    selectedLoiTonValues.clear();
                }

                updateLoiTonFilterText();
                applyFilters();
            });

            // Ma lỗi filter events
            document.getElementById('maLoiFilterBtn').addEventListener('click', function (e) {
                e.stopPropagation();
                toggleMaLoiDropdown();
            });

            // Search mã lỗi
            document.getElementById('maLoiSearch').addEventListener('input', debounce(filterMaLoiOptions, 300));

            // Select all mã lỗi
            document.getElementById('selectAllMaLoi').addEventListener('change', function () {
                const checkboxes = document.querySelectorAll('.ma-loi-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });

                if (this.checked) {
                    filteredMaLoiValues.forEach(value => {
                        selectedMaLoiValues.add(value);
                    });
                } else {
                    filteredMaLoiValues.forEach(value => {
                        selectedMaLoiValues.delete(value);
                    });
                }

                updateMaLoiFilterText();
                applyFilters();
            });

            // Individual mã lỗi checkboxes
            document.getElementById('maLoiOptions').addEventListener('change', function (e) {
                if (e.target.classList.contains('ma-loi-checkbox')) {
                    const value = e.target.value;

                    if (e.target.checked) {
                        selectedMaLoiValues.add(value);
                    } else {
                        selectedMaLoiValues.delete(value);
                    }

                    // Update select all checkbox
                    const allCheckboxes = document.querySelectorAll('.ma-loi-checkbox');
                    const checkedCheckboxes = document.querySelectorAll('.ma-loi-checkbox:checked');
                    const selectAllCheckbox = document.getElementById('selectAllMaLoi');

                    if (checkedCheckboxes.length === 0) {
                        selectAllCheckbox.indeterminate = false;
                        selectAllCheckbox.checked = false;
                    } else if (checkedCheckboxes.length === allCheckboxes.length) {
                        selectAllCheckbox.indeterminate = false;
                        selectAllCheckbox.checked = true;
                    } else {
                        selectAllCheckbox.indeterminate = true;
                    }

                    updateMaLoiFilterText();
                    applyFilters();
                }
            });

            // Nội dung lỗi filter events
            document.getElementById('noiDungLoiFilterBtn').addEventListener('click', function (e) {
                e.stopPropagation();
                toggleNoiDungLoiDropdown();
            });

            // Search nội dung lỗi
            document.getElementById('noiDungLoiSearch').addEventListener('input', debounce(filterNoiDungLoiOptions, 300));

            // Select all nội dung lỗi
            document.getElementById('selectAllNoiDungLoi').addEventListener('change', function () {
                const checkboxes = document.querySelectorAll('.noi-dung-loi-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });

                if (this.checked) {
                    filteredNoiDungLoiValues.forEach(value => {
                        selectedNoiDungLoiValues.add(value);
                    });
                } else {
                    filteredNoiDungLoiValues.forEach(value => {
                        selectedNoiDungLoiValues.delete(value);
                    });
                }

                updateNoiDungLoiFilterText();
                applyFilters();
            });

            // Individual nội dung lỗi checkboxes
            document.getElementById('noiDungLoiOptions').addEventListener('change', function (e) {
                if (e.target.classList.contains('noi-dung-loi-checkbox')) {
                    const value = e.target.value;

                    if (e.target.checked) {
                        selectedNoiDungLoiValues.add(value);
                    } else {
                        selectedNoiDungLoiValues.delete(value);
                    }

                    // Update select all checkbox
                    const allCheckboxes = document.querySelectorAll('.noi-dung-loi-checkbox');
                    const checkedCheckboxes = document.querySelectorAll('.noi-dung-loi-checkbox:checked');
                    const selectAllCheckbox = document.getElementById('selectAllNoiDungLoi');

                    if (checkedCheckboxes.length === 0) {
                        selectAllCheckbox.indeterminate = false;
                        selectAllCheckbox.checked = false;
                    } else if (checkedCheckboxes.length === allCheckboxes.length) {
                        selectAllCheckbox.indeterminate = false;
                        selectAllCheckbox.checked = true;
                    } else {
                        selectAllCheckbox.indeterminate = true;
                    }

                    updateNoiDungLoiFilterText();
                    applyFilters();
                }
            });

            // Cập nhật event listener đóng dropdowns khi clicking outside
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.multi-select-container')) {
                    document.getElementById('loiTonFilterDropdown').classList.add('hidden');
                    document.getElementById('noiDungLoiFilterDropdown').classList.add('hidden');
                    document.getElementById('maLoiFilterDropdown').classList.add('hidden'); // Thêm dòng này
                    document.querySelector('#loiTonFilterBtn .multi-select-icon').style.transform = 'rotate(0deg)';
                    document.querySelector('#noiDungLoiFilterBtn .multi-select-icon').style.transform = 'rotate(0deg)';
                    document.querySelector('#maLoiFilterBtn .multi-select-icon').style.transform = 'rotate(0deg)'; // Thêm dòng này
                }
            });

            // Prevent dropdown from closing when clicking inside
            document.getElementById('maLoiFilterDropdown').addEventListener('click', function (e) {
                e.stopPropagation();
            });

            // Prevent dropdowns from closing when clicking inside
            document.getElementById('loiTonFilterDropdown').addEventListener('click', function (e) {
                e.stopPropagation();
            });

            document.getElementById('noiDungLoiFilterDropdown').addEventListener('click', function (e) {
                e.stopPropagation();
            });

            document.getElementById('exportExcelBtn').addEventListener('click', generateExcelExport);
        });

        // Table events with delegation
        document.getElementById('table-body').addEventListener('click', function (e) {
            const row = e.target.closest('tr');
            if (!row || !row.hasAttribute('data-row-id')) return;

            const rowId = row.getAttribute('data-row-id');

            if (e.target.type !== 'checkbox') {
                const checkbox = row.querySelector('.row-checkbox');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    handleRowSelection(checkbox, rowId);
                }
            }
        });

        document.getElementById('table-body').addEventListener('change', function (e) {
            if (e.target.classList.contains('row-checkbox')) {
                const row = e.target.closest('tr');
                const rowId = row.getAttribute('data-row-id');
                handleRowSelection(e.target, rowId);
            }
        });

        // Header controls
        document.getElementById('selectAllCheckbox').addEventListener('change', function () {
            if (this.checked) {
                selectAllCurrentPage();
            } else {
                const currentPageIds = getCurrentPageRowIds();
                currentPageIds.forEach(id => selectedRows.delete(id));

                document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.closest('tr').classList.remove('selected');
                });

                updateStats();
                updateSelectAllCheckbox();
            }
        });

        document.getElementById('selectAllBtn').addEventListener('click', selectAllCurrentPage);
        document.getElementById('selectAllFilteredBtn').addEventListener('click', selectAllFiltered);
        document.getElementById('clearSelectionBtn').addEventListener('click', clearAllSelection);
        document.getElementById('exportBtn').addEventListener('click', generateExport);

        // Initialize
        setCurrentDate();
        fetchData();

        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</body>

</html>
