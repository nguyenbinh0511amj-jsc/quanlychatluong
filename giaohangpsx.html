<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xu·∫•t Excel t·ª´ AppSheet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        
        .filter-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-tertiary {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .data-preview {
            margin-top: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .preview-header {
            background: #f5f5f5;
            padding: 15px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-content {
            max-height: 600px;
            overflow: auto;
            padding: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin: 0;
        }
        
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            border-right: 1px solid #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .record-count {
            margin: 15px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
            color: #1976d2;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöö Xu·∫•t D·ªØ Li·ªáu Giao H√†ng</h1>
        
        <div class="filter-section">
            <div class="filter-title">üîç B·ªô l·ªçc d·ªØ li·ªáu</div>
            
            <div class="filter-row">
                <div class="form-group">
                    <label for="fromDate">T·ª´ ng√†y:</label>
                    <input type="date" id="fromDate">
                </div>
                
                <div class="form-group">
                    <label for="toDate">ƒê·∫øn ng√†y:</label>
                    <input type="date" id="toDate">
                </div>
                
                <div class="form-group">
                    <label for="fromTime">T·ª´ gi·ªù:</label>
                    <input type="time" id="fromTime">
                </div>
                
                <div class="form-group">
                    <label for="toTime">ƒê·∫øn gi·ªù:</label>
                    <input type="time" id="toTime">
                </div>
            </div>
            
            <div class="filter-row">
                <div class="form-group">
                    <label for="trangThai">Tr·∫°ng th√°i giao:</label>
                    <select id="trangThai">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <!-- C√°c option s·∫Ω ƒë∆∞·ª£c load ƒë·ªông t·ª´ d·ªØ li·ªáu -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="orderKd">M√£ ƒë∆°n h√†ng:</label>
                    <input type="text" id="orderKd" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng...">
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="loadData()">üì• T·∫£i d·ªØ li·ªáu</button>
            <button class="btn-secondary" onclick="previewData()" disabled>üëÅÔ∏è Xem tr∆∞·ªõc</button>
            <button class="btn-tertiary" onclick="exportToExcel()" disabled>üìä Xu·∫•t Excel</button>
        </div>
        
        <div id="status"></div>
        <div id="recordCount" class="record-count" style="display: none;"></div>
        
        <div id="dataPreview" class="data-preview" style="display: none;">
            <div class="preview-header">
                üìã Xem tr∆∞·ªõc d·ªØ li·ªáu (hi·ªÉn th·ªã to√†n b·ªô)
            </div>
            <div class="preview-content">
                <table id="previewTable">
                    <thead>
                        <tr>
                            <th>ID Giao H√†ng</th>
                            <th>M√£ ƒê∆°n</th>
                            <th>T√™n Chi Ti·∫øt</th>
                            <th>SLL</th>
                            <th>T√≠nh Ch·∫•t</th>
                            <th>SLL Giao</th>
                            <th>Ng√†y Giao</th>
                            <th>Gi·ªù Giao</th>
                            <th>Ng√†y Nh·∫≠n</th>
                            <th>Code</th>
                            <th>Tr·∫°ng Th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="previewTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        var APP_ID = 'e1339939-5987-4d7a-8c73-436348abf6b7';
        var ACCESS_KEY = 'V2-WTcys-x7QFl-Z5SzF-zSe7D-qciuV-yaUHk-CDGEe-oSexL';
        var TABLE_NAME = 'Giao_Hang_PSX';
        
        var rawData = [];
        var filteredData = [];
        
        window.onload = function() {
            var today = new Date();
            var weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('fromDate').value = weekAgo.toISOString().split('T')[0];
            document.getElementById('toDate').value = today.toISOString().split('T')[0];
        };
        
        function populateStatusFilter() {
            var statusSelect = document.getElementById('trangThai');
            var currentValue = statusSelect.value;
            
            if (!rawData || rawData.length === 0) {
                return;
            }
            
            var uniqueStatuses = [];
            var statusSet = {};
            
            for (var i = 0; i < rawData.length; i++) {
                var row = rawData[i];
                if (row.trang_thai_giao) {
                    var status = String(row.trang_thai_giao).trim();
                    if (status && !statusSet[status]) {
                        statusSet[status] = true;
                        uniqueStatuses.push(status);
                    }
                }
            }
            
            uniqueStatuses.sort();
            console.log('Unique statuses found:', uniqueStatuses);
            
            statusSelect.innerHTML = '<option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>';
            
            for (var j = 0; j < uniqueStatuses.length; j++) {
                var option = document.createElement('option');
                option.value = uniqueStatuses[j];
                option.textContent = uniqueStatuses[j];
                statusSelect.appendChild(option);
            }
            
            if (currentValue && uniqueStatuses.indexOf(currentValue) !== -1) {
                statusSelect.value = currentValue;
            }
            
            console.log('Populated ' + uniqueStatuses.length + ' status options');
        }
        
        function showStatus(message, type) {
            var statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + (type || 'loading');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        function loadData() {
            showStatus('üîÑ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ AppSheet...', 'loading');
            
            var url = 'https://api.appsheet.com/api/v2/apps/' + APP_ID + '/tables/' + TABLE_NAME + '/Action';
            
            var requestBody = {
                "Action": "Find",
                "Properties": {},
                "Rows": []
            };
            
            console.log('Requesting data from:', url);
            console.log('Request body:', requestBody);
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': ACCESS_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) {
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    return response.text().then(function(errorText) {
                        console.error('Error response:', errorText);
                        throw new Error('HTTP error! status: ' + response.status + ' - ' + errorText);
                    });
                }
                
                return response.json();
            })
            .then(function(data) {
                console.log('Raw response data:', data);
                
                rawData = data || [];
                console.log('Processed rawData:', rawData);
                
                populateStatusFilter();
                
                if (rawData.length > 0) {
                    console.log('Sample data format:', rawData[0]);
                    console.log('Sample ngay_giao format:', rawData[0].ngay_giao, typeof rawData[0].ngay_giao);
                    console.log('Sample trang_thai_giao format:', rawData[0].trang_thai_giao, typeof rawData[0].trang_thai_giao);
                }
                
                applyFilters();
                
                showStatus('‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng ' + rawData.length + ' b·∫£n ghi!', 'success');
                
                document.querySelector('button[onclick="previewData()"]').disabled = false;
                document.querySelector('button[onclick="exportToExcel()"]').disabled = false;
                
                setTimeout(hideStatus, 3000);
            })
            .catch(function(error) {
                console.error('Error:', error);
                showStatus('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
            });
        }
        
        function applyFilters() {
            var fromDate = document.getElementById('fromDate').value;
            var toDate = document.getElementById('toDate').value;
            var fromTime = document.getElementById('fromTime').value;
            var toTime = document.getElementById('toTime').value;
            var trangThai = document.getElementById('trangThai').value;
            var orderKd = document.getElementById('orderKd').value.toLowerCase().trim();
            
            console.log('Applying filters:', { fromDate: fromDate, toDate: toDate, fromTime: fromTime, toTime: toTime, trangThai: trangThai, orderKd: orderKd });
            console.log('Raw data count:', rawData.length);
            
            filteredData = [];
            
            for (var i = 0; i < rawData.length; i++) {
                var row = rawData[i];
                var include = true;
                
                console.log('Processing row:', row);
                
                if (fromDate && row.ngay_giao) {
                    try {
                        var ngayGiaoStr = row.ngay_giao;
                        
                        if (typeof ngayGiaoStr === 'string') {
                            if (ngayGiaoStr.indexOf('/') !== -1) {
                                var parts = ngayGiaoStr.split('/');
                                if (parts.length === 3) {
                                    ngayGiaoStr = parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
                                }
                            }
                        }
                        
                        var ngayGiao = new Date(ngayGiaoStr);
                        var fromDateObj = new Date(fromDate);
                        
                        ngayGiao.setHours(0, 0, 0, 0);
                        fromDateObj.setHours(0, 0, 0, 0);
                        
                        console.log('Date comparison - ngayGiao:', ngayGiao, 'fromDate:', fromDateObj);
                        
                        if (ngayGiao < fromDateObj) {
                            console.log('Filtered out by fromDate');
                            include = false;
                        }
                    } catch (e) {
                        console.error('Error parsing fromDate:', e, row.ngay_giao);
                    }
                }
                
                if (include && toDate && row.ngay_giao) {
                    try {
                        var ngayGiaoStr = row.ngay_giao;
                        
                        if (typeof ngayGiaoStr === 'string') {
                            if (ngayGiaoStr.indexOf('/') !== -1) {
                                var parts = ngayGiaoStr.split('/');
                                if (parts.length === 3) {
                                    ngayGiaoStr = parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
                                }
                            }
                        }
                        
                        var ngayGiao = new Date(ngayGiaoStr);
                        var toDateObj = new Date(toDate);
                        
                        ngayGiao.setHours(23, 59, 59, 999);
                        toDateObj.setHours(23, 59, 59, 999);
                        
                        console.log('Date comparison - ngayGiao:', ngayGiao, 'toDate:', toDateObj);
                        
                        if (ngayGiao > toDateObj) {
                            console.log('Filtered out by toDate');
                            include = false;
                        }
                    } catch (e) {
                        console.error('Error parsing toDate:', e, row.ngay_giao);
                    }
                }
                
                if (include && fromTime && row.gio_giao) {
                    var gioGiao = String(row.gio_giao);
                    if (gioGiao < fromTime) {
                        console.log('Filtered out by fromTime');
                        include = false;
                    }
                }
                
                if (include && toTime && row.gio_giao) {
                    var gioGiao = String(row.gio_giao);
                    if (gioGiao > toTime) {
                        console.log('Filtered out by toTime');
                        include = false;
                    }
                }
                
                if (include && trangThai && row.trang_thai_giao) {
                    var rowStatus = String(row.trang_thai_giao).trim();
                    if (rowStatus !== trangThai) {
                        console.log('Filtered out by trangThai:', rowStatus, '!==', trangThai);
                        include = false;
                    }
                }
                
                if (include && orderKd && row.order_kd && String(row.order_kd).toLowerCase().indexOf(orderKd) === -1) {
                    console.log('Filtered out by orderKd');
                    include = false;
                }
                
                if (include) {
                    filteredData.push(row);
                }
            }
            
            console.log('Filtered data count:', filteredData.length);
            updateRecordCount();
        }
        
        function updateRecordCount() {
            var countDiv = document.getElementById('recordCount');
            var fromDate = document.getElementById('fromDate').value;
            var toDate = document.getElementById('toDate').value;
            
            var message = 'üìä T√¨m th·∫•y ' + filteredData.length + ' b·∫£n ghi';
            if (fromDate || toDate) {
                message += ' (t·ª´ ' + rawData.length + ' b·∫£n ghi g·ªëc)';
            }
            if (fromDate && toDate) {
                message += ' trong kho·∫£ng ' + fromDate + ' ƒë·∫øn ' + toDate;
            } else if (fromDate) {
                message += ' t·ª´ ng√†y ' + fromDate;
            } else if (toDate) {
                message += ' ƒë·∫øn ng√†y ' + toDate;
            }
            
            countDiv.textContent = message;
            countDiv.style.display = 'block';
            
            if (filteredData.length > 0) {
                console.log('Sample filtered data:', filteredData.slice(0, 3));
            }
        }
        
        function previewData() {
            applyFilters();
            
            var previewDiv = document.getElementById('dataPreview');
            var tableBody = document.getElementById('previewTableBody');
            
            tableBody.innerHTML = '';
            
            var previewData = filteredData;
            
            if (previewData.length === 0) {
                var tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="11" style="text-align: center; color: #999; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</td>';
                tableBody.appendChild(tr);
            } else {
                for (var i = 0; i < previewData.length; i++) {
                    var row = previewData[i];
                    var tr = document.createElement('tr');
                    tr.innerHTML = 
                        '<td>' + (row.ID_Giao_hang || '') + '</td>' +
                        '<td>' + (row.order_kd || '') + '</td>' +
                        '<td>' + (row.ten_chi_tiet || '') + '</td>' +
                        '<td>' + (row.sll || '') + '</td>' +
                        '<td>' + (row.tinh_chat || '') + '</td>' +
                        '<td>' + (row.sll_giao || '') + '</td>' +
                        '<td>' + (row.ngay_giao || '') + '</td>' +
                        '<td>' + (row.gio_giao || '') + '</td>' +
                        '<td>' + (row.ngay_nhan || '') + '</td>' +
                        '<td>' + (row.code || '') + '</td>' +
                        '<td>' + (row.trang_thai_giao || '') + '</td>';
                    tableBody.appendChild(tr);
                }
            }
            
            previewDiv.style.display = 'block';
            previewDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function exportToExcel() {
            applyFilters();
            
            if (filteredData.length === 0) {
                alert('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                return;
            }
            
            showStatus('üìä ƒêang t·∫°o file Excel...', 'loading');
            
            try {
                var excelData = [];
                for (var i = 0; i < filteredData.length; i++) {
                    var row = filteredData[i];
                    excelData.push({
                        'ID Giao H√†ng': row.ID_Giao_hang || '',
                        'M√£ ƒê∆°n KD': String(row.order_kd || ''),
                        'T√™n Chi Ti·∫øt': row.ten_chi_tiet || '',
                        'SLL': row.sll || '',
                        'T√≠nh Ch·∫•t': row.tinh_chat || '',
                        'SLL Giao': row.sll_giao || '',
                        'Ng√†y Giao': row.ngay_giao || '',
                        'Gi·ªù Giao': row.gio_giao || '',
                        'Ng√†y Nh·∫≠n': row.ngay_nhan || '',
                        'Code': String(row.code || ''),
                        'Tr·∫°ng Th√°i Giao': row.trang_thai_giao || ''
                    });
                }
                
                var ws = XLSX.utils.json_to_sheet(excelData);
                var wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Giao Hang PSX");
                
                var range = XLSX.utils.decode_range(ws['!ref']);
                var headers = ['ID Giao H√†ng', 'M√£ ƒê∆°n KD', 'T√™n Chi Ti·∫øt', 'SLL', 'T√≠nh Ch·∫•t', 'SLL Giao', 'Ng√†y Giao', 'Gi·ªù Giao', 'Ng√†y Nh·∫≠n', 'Code', 'Tr·∫°ng Th√°i Giao'];
                var orderKdCol = headers.indexOf('M√£ ƒê∆°n KD');
                var codeCol = headers.indexOf('Code');
                
                for (var R = range.s.r; R <= range.e.r; R++) {
                    if (orderKdCol >= 0) {
                        var cellRef = XLSX.utils.encode_cell({ r: R, c: orderKdCol });
                        if (ws[cellRef]) {
                            ws[cellRef].t = 's';
                            ws[cellRef].z = '@';
                        }
                    }
                    
                    if (codeCol >= 0) {
                        var cellRef = XLSX.utils.encode_cell({ r: R, c: codeCol });
                        if (ws[cellRef]) {
                            ws[cellRef].t = 's';
                            ws[cellRef].z = '@';
                        }
                    }
                }
                
                var colWidths = [];
                for (var h = 0; h < headers.length; h++) {
                    var header = headers[h];
                    var maxWidth = header.length;
                    for (var d = 0; d < excelData.length; d++) {
                        var cellValue = String(excelData[d][header] || '');
                        maxWidth = Math.max(maxWidth, cellValue.length);
                    }
                    colWidths[h] = { width: Math.min(maxWidth + 2, 50) };
                }
                ws['!cols'] = colWidths;
                
                var now = new Date();
                var timestamp = now.toISOString().slice(0, 19).replace(/[:\-T]/g, '');
                var filename = 'GiaoHang_PSX_' + timestamp + '.xlsx';
                
                XLSX.writeFile(wb, filename);
                
                showStatus('‚úÖ ƒê√£ xu·∫•t th√†nh c√¥ng ' + filteredData.length + ' b·∫£n ghi ra file ' + filename + '! C·ªôt "M√£ ƒê∆°n KD" ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng d∆∞·ªõi d·∫°ng text.', 'success');
                setTimeout(hideStatus, 5000);
                
            } catch (error) {
                console.error('Export error:', error);
                showStatus('‚ùå L·ªói khi xu·∫•t Excel: ' + error.message, 'error');
            }
        }
        
        document.getElementById('fromDate').addEventListener('change', function() {
            if (rawData.length > 0) applyFilters();
        });
        
        document.getElementById('toDate').addEventListener('change', function() {
            if (rawData.length > 0) applyFilters();
        });
        
        document.getElementById('fromTime').addEventListener('change', function() {
            if (rawData.length > 0) applyFilters();
        });
        
        document.getElementById('toTime').addEventListener('change', function() {
            if (rawData.length > 0) applyFilters();
        });
        
        document.getElementById('trangThai').addEventListener('change', function() {
            if (rawData.length > 0) applyFilters();
        });
        
        document.getElementById('orderKd').addEventListener('input', function() {
            if (rawData.length > 0) applyFilters();
        });
    </script>
</body>
</html>
