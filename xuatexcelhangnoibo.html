<!DOCTYPE html>
<html>
<head>
    <title>Xu·∫•t D·ªØ Li·ªáu AppSheet sang Excel (C√≥ L·ªçc Ng√†y & Giao Di·ªán)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script> 
    <style>
        /* CSS cho Giao Di·ªán */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .date-input-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .date-input-item {
            display: flex;
            flex-direction: column;
            width: 48%; /* Chia ƒë√¥i m√†n h√¨nh cho 2 tr∆∞·ªùng ng√†y */
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        input[type="date"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background-color: #28a745; /* M√†u xanh l√° c√¢y cho n√∫t h√†nh ƒë·ªông */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #218838;
        }

        #message {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9f7ff;
            border: 1px solid #cce5ff;
            color: #004085;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Xu·∫•t D·ªØ Li·ªáu Nh·∫≠p Kho (XLSX)</h2>
        
        <div class="date-input-group">
            <div class="date-input-item">
                <label for="startDate">üìÖ T·ª´ Ng√†y:</label>
                <input type="date" id="startDate">
            </div>
            
            <div class="date-input-item">
                <label for="endDate">üìÖ ƒê·∫øn Ng√†y:</label>
                <input type="date" id="endDate">
            </div>
        </div>

        <button onclick="xuatDuLieuExcel()">T·∫£i D·ªØ Li·ªáu sang XLSX</button>
        <p id="message"></p>
    </div>

    <script>
        // THAY TH·∫æ C√ÅC GI√Å TR·ªä C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        const APP_ID = 'e1339939-5987-4d7a-8c73-436348abf6b7';
        const ACCESS_KEY = 'V2-WTcys-x7QFl-Z5SzF-zSe7D-qciuV-yaUHk-CDGEe-oSexL';
        const TABLE_NAME = 'nhap_kho_hang_NB';
        const DATE_COLUMN = 'ngay_dong_goi'; // C·ªôt ƒë·ªÉ l·ªçc theo ng√†y

        const API_ENDPOINT = `https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/${TABLE_NAME}/Action`;

        // C√°c tr∆∞·ªùng (Headers) b·∫°n mu·ªën xu·∫•t ra Excel
        const COLUMNS = [
            'so_dh', 'order_kd', 'order_phoi', 'order_vat_lieu',
            'ten_chi_tiet', 'dvt', 'sll', DATE_COLUMN, 
            'trang_thai', 'Code', 'ho_va_ten'
        ];
        
        const messageElement = document.getElementById('message');

        async function xuatDuLieuExcel() {
            messageElement.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu t·ª´ AppSheet... Vui l√≤ng ch·ªù.';
            messageElement.style.backgroundColor = '#fff3cd'; // M√†u v√†ng nh·∫°t khi ƒëang x·ª≠ l√Ω
            messageElement.style.color = '#856404';

            // 1. L·∫•y gi√° tr·ªã ng√†y t·ª´ input
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert("Vui l√≤ng ch·ªçn c·∫£ 'T·ª´ Ng√†y' v√† 'ƒê·∫øn Ng√†y'.");
                messageElement.textContent = 'Vui l√≤ng ch·ªçn c·∫£ "T·ª´ Ng√†y" v√† "ƒê·∫øn Ng√†y".';
                messageElement.style.backgroundColor = '#f8d7da';
                messageElement.style.color = '#721c24';
                return;
            }

            // 2. X√¢y d·ª±ng c√¥ng th·ª©c l·ªçc (Selector) c·ªßa AppSheet
            const formattedStartDate = startDate.replace(/-/g, '/');
            const formattedEndDate = endDate.replace(/-/g, '/');
            
            // C√¥ng th·ª©c l·ªçc: [ngay_dong_goi] >= DATE("Ng√†y B·∫Øt ƒê·∫ßu") V√Ä [ngay_dong_goi] <= DATE("Ng√†y K·∫øt Th√∫c")
            const filterFormula = `FILTER(${TABLE_NAME}, AND([${DATE_COLUMN}] >= DATE("${formattedStartDate}"), [${DATE_COLUMN}] <= DATE("${formattedEndDate}")))`;

            // 3. Chu·∫©n b·ªã y√™u c·∫ßu API v·ªõi Selector
            const requestBody = {
                "Action": "Find", 
                "Properties": {
                    "Locale": "vi-VN",
                    "Selector": filterFormula 
                }
            };

            try {
                // 4. G·ªçi AppSheet API
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': ACCESS_KEY 
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`L·ªói API: ${response.status} - ${response.statusText}`);
                }

                // 5. Nh·∫≠n d·ªØ li·ªáu JSON
                const data = await response.json();

                if (data && data.length > 0) {
                    // 6. Chuy·ªÉn ƒë·ªïi JSON sang Worksheet v√† Workbook
                    convertToXLSX(data, COLUMNS, 'DuLieuNhapKho');
                    messageElement.textContent = `‚úÖ ƒê√£ t·∫£i xu·ªëng ${data.length} d√≤ng d·ªØ li·ªáu Excel (.xlsx)!`;
                    messageElement.style.backgroundColor = '#d4edda'; // M√†u xanh l√° khi th√†nh c√¥ng
                    messageElement.style.color = '#155724';
                } else {
                    messageElement.textContent = '‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√†o kh·ªõp v·ªõi b·ªô l·ªçc ng√†y ƒë√£ ch·ªçn.';
                    messageElement.style.backgroundColor = '#fff3cd'; 
                    messageElement.style.color = '#856404';
                    alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√†o trong kho·∫£ng th·ªùi gian n√†y.");
                }

            } catch (error) {
                console.error("ƒê√£ x·∫£y ra l·ªói:", error);
                messageElement.textContent = '‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra console ho·∫∑c Access Key.';
                messageElement.style.backgroundColor = '#f8d7da';
                messageElement.style.color = '#721c24';
                alert("L·ªói khi t·∫£i d·ªØ li·ªáu: " + error.message);
            }
        }

        /**
         * Chuy·ªÉn ƒë·ªïi m·∫£ng JSON th√†nh file XLSX v√† k√≠ch ho·∫°t t·∫£i xu·ªëng (S·ª≠ d·ª•ng SheetJS)
         */
        function convertToXLSX(jsonData, headers, sheetName) {
            
            // X√¢y d·ª±ng m·∫£ng d·ªØ li·ªáu v·ªõi ti√™u ƒë·ªÅ ·ªü d√≤ng ƒë·∫ßu ti√™n
            const worksheetData = [ headers ];

            // Th√™m c√°c d√≤ng d·ªØ li·ªáu, ch·ªâ l·∫•y c√°c tr∆∞·ªùng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong 'headers'
            jsonData.forEach(row => {
                const values = headers.map(header => row[header] === undefined ? '' : row[header]);
                worksheetData.push(values);
            });

            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            
            // Ghi file v√† k√≠ch ho·∫°t t·∫£i xu·ªëng
            XLSX.writeFile(wb, "du_lieu_nhap_kho.xlsx");
        }
    </script>
</body>
</html>
