<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIÊN BẢN CHECK GIAO KHO VP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thêm thư viện SheetJS để xuất Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        * {
            font-family: 'Times New Roman', Times, serif;
            box-sizing: border-box;
        }

        @media print {
            body>*:not(#printArea) {
                display: none !important;
            }

            #printArea {
                display: block !important;
            }
        }

        #printArea {
            display: none;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-exported {
            background: #d1fae5;
            color: #065f46;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #059669;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-success:hover {
            background: #047857;
        }

        .table-container {
            overflow: auto;
            max-height: 60vh;
        }

        table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #e5e7eb;
            padding: 8px 4px;
            text-align: left;
            font-size: 13px;
        }

        th {
            background: #f9fafb;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr.selected {
            background-color: #dbeafe;
        }

        tbody tr:hover {
            background-color: #f3f4f6;
        }

        tbody tr.selected:hover {
            background-color: #bfdbfe;
        }

        .checkbox-custom {
            width: 16px;
            height: 16px;
        }

        .hidden {
            display: none;
        }

        /* Fixed column widths */
        th:nth-child(1),
        td:nth-child(1) {
            width: 40px;
        }

        th:nth-child(2),
        td:nth-child(2) {
            width: 80px;
        }

        th:nth-child(3),
        td:nth-child(3) {
            width: 80px;
        }

        th:nth-child(4),
        td:nth-child(4) {
            width: 80px;
        }

        th:nth-child(5),
        td:nth-child(5) {
            width: 80px;
        }

        th:nth-child(6),
        td:nth-child(6) {
            width: 150px;
        }

        th:nth-child(7),
        td:nth-child(7) {
            width: 50px;
        }

        th:nth-child(8),
        td:nth-child(8) {
            width: 60px;
        }

        th:nth-child(9),
        td:nth-child(9) {
            width: 80px;
        }

        th:nth-child(10),
        td:nth-child(10) {
            width: 80px;
        }

        th:nth-child(11),
        td:nth-child(11) {
            width: 70px;
        }

        th:nth-child(12),
        td:nth-child(12) {
            width: 100px;
        }

        th:nth-child(13),
        td:nth-child(13) {
            width: 60px;
        }

        th:nth-child(14),
        td:nth-child(14) {
            width: 60px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #f3f4f6;
        }

        .pagination button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bulk-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column;
                gap: 8px;
            }

            .mobile-stack>div {
                width: 100%;
            }

            .bulk-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination {
                flex-wrap: wrap;
                gap: 4px;
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="printArea"></div>

    <!-- Header -->
    <header class="bg-white border-b p-4">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-500 p-2 rounded text-white">
                    <i class="fas fa-warehouse"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">GIAO KHO VP</h1>
                </div>
            </div>

            <div class="bulk-actions">
                <button id="selectAllBtn" class="btn-secondary">
                    <i class="fas fa-check-square mr-1"></i>Chọn tất cả trang
                </button>
                <button id="selectAllFilteredBtn" class="btn-secondary">
                    <i class="fas fa-check-double mr-1"></i>Chọn tất cả lọc (<span id="filteredCount">0</span>)
                </button>
                <button id="clearSelectionBtn" class="btn-secondary">
                    <i class="fas fa-times mr-1"></i>Bỏ chọn
                </button>
                <button id="exportBtn" class="btn-primary">
                    <i class="fas fa-print mr-1"></i>In (<span id="selectedCount">0</span>)
                </button>
                <button id="exportExcelBtn" class="btn-success">
                    <i class="fas fa-file-excel mr-1"></i>Xuất Excel
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mobile-stack">
            <div class="md:col-span-3">
                <input type="text" placeholder="Tìm kiếm..." class="w-full p-2 border rounded" id="searchInput">
            </div>
            <select id="lanGiaoFilter" class="p-2 border rounded">
                <option value="all">Tất cả lần giao</option>
            </select>
            <input type="date" id="dateFilter" class="p-2 border rounded">
            <div class="page-size-selector">
                <label class="text-sm">Hiển thị:</label>
                <select id="pageSizeSelect" class="p-2 border rounded">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                </select>
            </div>
        </div>
    </header>

    <!-- Statistics -->
    <div class="bg-white border-b p-4">
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <div class="p-3 border rounded">
                <div class="text-xs text-gray-500">Tổng lệnh</div>
                <div class="font-bold text-lg" id="totalOrdersCount">0</div>
            </div>
            <div class="p-3 border rounded">
                <div class="text-xs text-gray-500">Tổng số lượng</div>
                <div class="font-bold text-lg" id="totalQuantityCount">0</div>
            </div>
            <div class="p-3 border rounded">
                <div class="text-xs text-gray-500">Chưa xuất</div>
                <div class="font-bold text-lg" id="pendingCount">0</div>
            </div>
            <div class="p-3 border rounded">
                <div class="text-xs text-gray-500">Đã xuất</div>
                <div class="font-bold text-lg" id="exportedCount">0</div>
            </div>
            <div class="p-3 border rounded">
                <div class="text-xs text-gray-500">Hiển thị</div>
                <div class="font-bold text-lg" id="displayedCount">0</div>
            </div>
            <div class="p-3 border rounded">
                <div class="text-xs text-gray-500">Đã chọn</div>
                <div class="font-bold text-lg" id="selectedCountStat">0</div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="p-4">
        <div class="bg-white border rounded">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" class="checkbox-custom"></th>
                            <th>Order KD</th>
                            <th>Số PO</th>
                            <th>Order phôi</th>
                            <th>Order VL</th>
                            <th>Tên chi tiết</th>
                            <th>ĐVT</th>
                            <th>SLL</th>
                            <th>Ngày gói</th>
                            <th>Label</th>
                            <th>Xác nhận</th>
                            <th>Ghi chú</th>
                            <th>Số gói</th>
                            <th>Lần giao</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="14" class="text-center p-8">
                                <div class="loading"></div>
                                <div class="mt-2">Đang tải...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="p-4 border-t">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-sm text-gray-600" id="paginationInfo">
                        Hiển thị 0 - 0 của 0 kết quả
                    </div>
                    <div class="pagination" id="pagination">
                        <!-- Pagination buttons will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let selectedRows = new Map();
        let currentPage = 0;
        let pageSize = 50;
        let isLoading = false;

        const appId = 'e1339939-5987-4d7a-8c73-436348abf6b7';
        const accessKey = 'V2-WTcys-x7QFl-Z5SzF-zSe7D-qciuV-yaUHk-CDGEe-oSexL';
        const region = 'www';

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const d = new Date(dateString);
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
        }

        function generateRowId(item, index) {
            return `${item.order_kd || ''}_${item.order_vat_lieu || ''}_${index}`;
        }

        // Data fetching
        async function fetchData() {
            if (isLoading) return;

            isLoading = true;
            updateLoadingState(true);

            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/giao_kho_vp/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: "Filter(giao_kho_vp, true)"
                    })
                });

                if (!response.ok) throw new Error('Failed to fetch');
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error('Invalid data');

                // Add unique IDs and process data
                allData = data.reverse().map((item, index) => ({
                    ...item,
                    _id: generateRowId(item, index),
                    _index: index,
                    _formattedDate: formatDate(item.ngay_dong_goi)
                }));

                filteredData = [...allData];
                populateLanGiaoFilter(allData);
                updateStats();
                renderCurrentPage();

            } catch (error) {
                console.error('Error:', error);
                showError('Lỗi tải dữ liệu. Vui lòng thử lại.');
            } finally {
                isLoading = false;
                updateLoadingState(false);
            }
        }

        function updateLoadingState(loading) {
            const tbody = document.getElementById('table-body');
            if (loading) {
                tbody.innerHTML = `
                   <tr>
                       <td colspan="14" class="text-center p-8">
                           <div class="loading"></div>
                           <div class="mt-2">Đang tải...</div>
                       </td>
                   </tr>
               `;
            }
        }

        function showError(message) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = `
               <tr>
                   <td colspan="14" class="text-center p-8 text-red-500">
                       <i class="fas fa-exclamation-triangle mr-2"></i>${message}
                   </td>
               </tr>
           `;
        }

        // Filtering
        const applyFilters = debounce(function () {
            const search = document.getElementById('searchInput').value.toLowerCase().trim();
            const lanGiao = document.getElementById('lanGiaoFilter').value;
            const date = document.getElementById('dateFilter').value;

            let dateFormatted = '';
            if (date) {
                dateFormatted = formatDate(date);
            }

            let tempFilteredData = allData.filter(item => {
                if (search) {
                    const searchableText = [
                        item.order_kd, item.so_dh, item.order_phoi, item.order_vat_lieu,
                        item.ten_chi_tiet, item.dvt, item.sll, item.loai_giay_to,
                        item.ghi_chu, item.so_goi, item.lan_giao
                    ].join(' ').toLowerCase();

                    if (!searchableText.includes(search)) return false;
                }

                if (dateFormatted && item._formattedDate !== dateFormatted) {
                    return false;
                }

                return true;
            });

            let dataForLanGiaoFilter;
            if (dateFormatted && tempFilteredData.length === 0) {
                dataForLanGiaoFilter = allData;
            } else {
                dataForLanGiaoFilter = tempFilteredData;
            }

            populateLanGiaoFilter(dataForLanGiaoFilter);

            filteredData = tempFilteredData.filter(item => {
                if (lanGiao !== 'all' && item.lan_giao !== lanGiao) {
                    return false;
                }
                return true;
            });

            currentPage = 0;
            updateStats();
            renderCurrentPage();
            updatePagination();
        }, 500);

        // Stats
        function updateStats() {
            const total = allData.length;
            const totalQuantity = allData.reduce((sum, item) => sum + parseInt(item.sll || 0), 0);
            const pending = allData.filter(item => item.thoi_han !== 'Đã xuất').length;
            const exported = allData.filter(item => item.thoi_han === 'Đã xuất').length;
            const displayed = filteredData.length;
            const selected = selectedRows.size;

            document.getElementById('totalOrdersCount').textContent = total;
            document.getElementById('totalQuantityCount').textContent = totalQuantity;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('exportedCount').textContent = exported;
            document.getElementById('displayedCount').textContent = displayed;
            document.getElementById('selectedCountStat').textContent = selected;
            document.getElementById('selectedCount').textContent = selected;
            document.getElementById('filteredCount').textContent = displayed;
        }

        // Lan giao filter
        function populateLanGiaoFilter(dataToFilter = allData) {
            const lanGiaoSet = new Set();
            dataToFilter.forEach(item => {
                if (item.lan_giao && item.lan_giao.trim()) {
                    lanGiaoSet.add(item.lan_giao.trim());
                }
            });

            const select = document.getElementById('lanGiaoFilter');
            const currentValue = select.value;
            select.innerHTML = '<option value="all">Tất cả lần giao</option>';

            const sortedLanGiao = Array.from(lanGiaoSet).sort((a, b) => {
                const parseDate = (dateStr) => {
                    try {
                        const [datePart] = dateStr.split('-');
                        const [day, month, year] = datePart.split('/');
                        const fullYear = parseInt(year) + (parseInt(year) < 50 ? 2000 : 1900);
                        return new Date(fullYear, parseInt(month) - 1, parseInt(day));
                    } catch (e) {
                        return new Date(0);
                    }
                };

                const dateA = parseDate(a);
                const dateB = parseDate(b);
                return dateB - dateA;
            });

            sortedLanGiao.forEach(lanGiao => {
                const option = document.createElement('option');
                option.value = lanGiao;
                option.textContent = `Lần ${lanGiao}`;
                select.appendChild(option);
            });

            if (sortedLanGiao.includes(currentValue)) {
                select.value = currentValue;
            } else {
                select.value = 'all';
            }
        }

        // Table rendering
        function renderCurrentPage() {
            const tbody = document.getElementById('table-body');
            const startIndex = currentPage * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center p-8">Không có dữ liệu</td></tr>';
                updatePaginationInfo(0, 0, 0);
                return;
            }

            const fragment = document.createDocumentFragment();

            pageData.forEach(item => {
                const row = createTableRow(item);
                fragment.appendChild(row);
            });

            tbody.innerHTML = '';
            tbody.appendChild(fragment);

            updatePaginationInfo(startIndex + 1, endIndex, filteredData.length);
            updateSelectAllCheckbox();
        }

        function createTableRow(item) {
            const row = document.createElement('tr');
            row.setAttribute('data-row-id', item._id);

            const isExported = item.thoi_han === 'Đã xuất';
            const isSelected = selectedRows.has(item._id);

            if (isSelected) {
                row.classList.add('selected');
            }

            const status = isExported
                ? '<span class="status-badge status-exported">Đã xuất</span>'
                : '<span class="status-badge status-pending">Chưa xuất</span>';

            row.innerHTML = `
               <td><input type="checkbox" class="checkbox-custom row-checkbox" ${isSelected ? 'checked' : ''}></td>
               <td>${item.order_kd || ''}</td>
               <td>${item.so_dh || ''}</td>
               <td>${item.order_phoi || ''}</td>
               <td>${item.order_vat_lieu || ''}</td>
               <td title="${item.ten_chi_tiet || ''}">${truncateText(item.ten_chi_tiet || '', 20)}</td>
               <td>${item.dvt || ''}</td>
               <td><strong>${item.sll || ''}</strong></td>
               <td>${item._formattedDate}</td>
               <td>${item.Label}</td>
               <td>${item.loai_giay_to || ''}</td>
               <td title="${item.ghi_chu || ''}">${truncateText(item.ghi_chu || '', 15)}</td>
               <td>${item.so_goi || ''}</td>
               <td>${item.lan_giao || ''}</td>
           `;

            return row;
        }

        function truncateText(text, length) {
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        // Pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            html += `<button ${currentPage === 0 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
               <i class="fas fa-chevron-left"></i>
           </button>`;

            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages - 1, currentPage + 2);

            if (startPage > 0) {
                html += `<button onclick="goToPage(0)">1</button>`;
                if (startPage > 1) {
                    html += '<span>...</span>';
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                   ${i + 1}
               </button>`;
            }

            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    html += '<span>...</span>';
                }
                html += `<button onclick="goToPage(${totalPages - 1})">${totalPages}</button>`;
            }

            html += `<button ${currentPage >= totalPages - 1 ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
               <i class="fas fa-chevron-right"></i>
           </button>`;

            pagination.innerHTML = html;
        }

        function updatePaginationInfo(start, end, total) {
            document.getElementById('paginationInfo').textContent =
                `Hiển thị ${start} - ${end} của ${total} kết quả`;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (page < 0 || page >= totalPages) return;

            currentPage = page;
            renderCurrentPage();
            updatePagination();
        }

        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            currentPage = 0;
            renderCurrentPage();
            updatePagination();
        }

        // Selection handling
        function handleRowSelection(checkbox, rowId) {
            const row = checkbox.closest('tr');

            if (checkbox.checked) {
                selectedRows.set(rowId, true);
                row.classList.add('selected');
            } else {
                selectedRows.delete(rowId);
                row.classList.remove('selected');
            }

            updateStats();
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const currentPageIds = getCurrentPageRowIds();
            const selectedInCurrentPage = currentPageIds.filter(id => selectedRows.has(id)).length;

            if (selectedInCurrentPage === 0) {
                checkbox.indeterminate = false;
                checkbox.checked = false;
            } else if (selectedInCurrentPage === currentPageIds.length) {
                checkbox.indeterminate = false;
                checkbox.checked = true;
            } else {
                checkbox.indeterminate = true;
            }
        }

        function getCurrentPageRowIds() {
            return Array.from(document.querySelectorAll('#table-body tr[data-row-id]'))
                .map(row => row.getAttribute('data-row-id'));
        }

        function selectAllCurrentPage() {
            const currentPageIds = getCurrentPageRowIds();
            currentPageIds.forEach(id => selectedRows.set(id, true));

            document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('tr').classList.add('selected');
            });

            updateStats();
            updateSelectAllCheckbox();
        }

        function selectAllFiltered() {
            filteredData.forEach(item => selectedRows.set(item._id, true));

            document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('tr').classList.add('selected');
            });

            updateStats();
            updateSelectAllCheckbox();
        }

        function clearAllSelection() {
            selectedRows.clear();

            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('tr.selected').forEach(row => {
                row.classList.remove('selected');
            });

            updateStats();
            updateSelectAllCheckbox();
        }

        // Hàm xuất Excel mới sử dụng ExcelJS
        async function exportToExcel() {
            try {
                const dataToExport = filteredData;

                if (dataToExport.length === 0) {
                    alert('Không có dữ liệu để xuất Excel');
                    return;
                }

                // Hiển thị loading
                const exportBtn = document.getElementById('exportExcelBtn');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<div class="loading"></div> Đang xuất...';
                exportBtn.disabled = true;

                const workbook = new ExcelJS.Workbook();

                // Tạo 3 sheets (đã xóa Giao vp autel)
                await createGiaoVpRrcSheetExcelJS(workbook, dataToExport);
                await createGiaoVpKhacSheetExcelJS(workbook);
                await createGiaoVpNoiBoSheetExcelJS(workbook);

                // Tạo tên file
                let fileName = 'BBGH_GOI_';
                const dateFilter = document.getElementById('dateFilter').value;
                const lanGiaoFilter = document.getElementById('lanGiaoFilter').value;

                if (dateFilter) {
                    const date = new Date(dateFilter);
                    fileName += `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
                } else if (lanGiaoFilter !== 'all') {
                    fileName += lanGiaoFilter.replace(/\//g, '');
                } else {
                    const today = new Date();
                    fileName += `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
                }

                // Xuất file
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName + '.xlsx';
                a.click();
                window.URL.revokeObjectURL(url);

                // Khôi phục nút
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;

                showSuccess('Xuất Excel thành công!');

            } catch (error) {
                console.error('Lỗi xuất Excel:', error);
                alert('Có lỗi xảy ra khi xuất Excel. Vui lòng thử lại.');

                const exportBtn = document.getElementById('exportExcelBtn');
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }
        }

        // Sheet 1: Giao vp rrc - có dữ liệu thực
        async function createGiaoVpRrcSheetExcelJS(workbook, dataToExport) {
            const worksheet = workbook.addWorksheet('Giao vp rrc');

            // Tính tổng số lượng
            const totalQuantity = dataToExport.reduce((sum, item) => sum + parseInt(item.sll || 0), 0);

            // Thiết lập độ rộng cột giống mẫu
            worksheet.columns = [
                { width: 6 },   // STT
                { width: 15 },  // Text
                { width: 15 },  // Order Kinh Doanh
                { width: 15 },  // Order Lệnh phôi
                { width: 15 },  // Order Vật liệu
                { width: 25 },  // Tên sản phẩm
                { width: 8 },   // ĐVT
                { width: 12 },  // Số lượng
                { width: 15 },  // Ngày đóng gói
                { width: 18 },  // Xác nhận từ RRC
                { width: 18 },  // Ghi chú
                { width: 15 }   // Thùng (vị trí)
            ];

            // Tiêu đề chính
            const titleRow = worksheet.addRow(['LIST GIAO HÀNG VĂN PHÒNG RRC HÀNG NGÀY']);
            worksheet.mergeCells('A1:L1');
            titleRow.getCell(1).style = {
                font: { name: 'Times New Roman', size: 20, bold: true },
                alignment: { horizontal: 'center', vertical: 'middle' },
                border: createFullBorder()
            };
            titleRow.height = 25;

            // Header
            const headers = [
                'STT', 'Text', 'Order\nKinh Doanh', 'Order\nLệnh phôi', 'Order\nVật liệu',
                'Tên sản phẩm', 'ĐVT', 'Số lượng', 'Ngày đóng\ngói', 'Xác nhận từ RRC',
                'Ghi chú', 'Thùng\n(vị trí)'
            ];
            const headerRow = worksheet.addRow(headers);

            headerRow.eachCell((cell) => {
                cell.style = {
                    font: { name: 'Times New Roman', size: 11, bold: true },
                    alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'D9D9D9' } },
                    border: createFullBorder()
                };
            });
            headerRow.height = 35;

            // Dòng tổng
            const totalRow = worksheet.addRow([
                '*', '*', '*', '*', '*', '*', '*', totalQuantity, '*', '*', '*', '*'
            ]);

            totalRow.eachCell((cell, colNumber) => {
                let fillColor = 'FFFFFF';
                let fontColor = '000000';

                if (colNumber === 8) { // Cột số lượng
                    fillColor = '00B0F0';
                    fontColor = 'FFFFFF';
                }

                cell.style = {
                    font: { name: 'Times New Roman', size: 11, bold: true, color: { argb: fontColor } },
                    alignment: { horizontal: 'center', vertical: 'middle' },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } },
                    border: createFullBorder()
                };
            });
            totalRow.height = 20;

            // Thêm dữ liệu
            dataToExport.forEach((item, index) => {
                const rowData = [
                    index + 1,
                    item.order_kd || '',
                    item.order_kd || '',
                    item.order_phoi || '',
                    item.order_vat_lieu || '',
                    item.ten_chi_tiet || '',
                    item.dvt || '',
                    parseInt(item.sll || 0),
                    item._formattedDate || '',
                    item.loai_giay_to || '',
                    item.ghi_chu || '',
                    ''
                ];

                const dataRow = worksheet.addRow(rowData);

                dataRow.eachCell((cell, colNumber) => {
                    let alignment = { vertical: 'middle', horizontal: 'center' };
                    let fillColor = 'FFFFFF';
                    let numFmt = undefined; // Thêm biến để định dạng số

                    // Căn trái cho tên sản phẩm và ghi chú
                    if (colNumber === 6 || colNumber === 11) {
                        alignment.horizontal = 'left';
                    }

                    // Định dạng số cho cột Order Kinh Doanh (cột 3)
                    if (colNumber === 3) {
                        numFmt = '0'; // Định dạng số nguyên
                        // Hoặc có thể dùng: numFmt = '#,##0' để có dấu phẩy ngăn cách hàng nghìn
                    }

                    cell.style = {
                        font: { name: 'Times New Roman', size: 10 },
                        alignment: alignment,
                        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } },
                        border: createFullBorder(),
                        numFmt: numFmt // Thêm định dạng số
                    };
                });
                dataRow.height = 20;
            });
        }

        // Sheet 3: Giao vp khác
        async function createGiaoVpKhacSheetExcelJS(workbook) {
            const worksheet = workbook.addWorksheet('Giao vp khác');

            // Thiết lập độ rộng cột
            worksheet.columns = [
                { width: 6 },   // STT
                { width: 12 },  // Số Po
                { width: 15 },  // Order Kinh Doanh
                { width: 15 },  // Order Lệnh phôi
                { width: 15 },  // Order Vật liệu
                { width: 25 },  // Tên sản phẩm
                { width: 8 },   // ĐVT
                { width: 12 },  // Số lượng
                { width: 15 },  // Ngày đóng gói
                { width: 18 },  // Xác nhận từ RRC
                { width: 18 },  // Ghi chú
                { width: 15 }   // Thùng (vị trí)
            ];

            // Tiêu đề chính
            const titleRow = worksheet.addRow(['LIST GIAO HÀNG VĂN PHÒNG HÀNG KHÁC HÀNG NGÀY']);
            worksheet.mergeCells('A1:L1');
            titleRow.getCell(1).style = {
                font: { name: 'Times New Roman', size: 20, bold: true },
                alignment: { horizontal: 'center', vertical: 'middle' },
                border: createFullBorder()
            };
            titleRow.height = 25;

            // Header
            const headers = [
                'STT', 'Số Po', 'Order\nKinh Doanh', 'Order\nLệnh phôi', 'Order\nVật liệu',
                'Tên sản phẩm', 'ĐVT', 'Số lượng', 'Ngày đóng\ngói', 'Xác nhận từ RRC',
                'Ghi chú', 'Thùng\n(vị trí)'
            ];
            const headerRow = worksheet.addRow(headers);

            headerRow.eachCell((cell) => {
                cell.style = {
                    font: { name: 'Times New Roman', size: 11, bold: true },
                    alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'D9D9D9' } },
                    border: createFullBorder()
                };
            });
            headerRow.height = 35;

            // Dòng tổng
            const totalRow = worksheet.addRow([
                '*', '*', '*', '*', '*', '*', '*', 0, '*', '*', '*', '*'
            ]);

            totalRow.eachCell((cell, colNumber) => {
                let fillColor = 'FFFFFF';
                let fontColor = '000000';

                if (colNumber === 8) { // Cột số lượng
                    fillColor = '00B0F0';
                    fontColor = 'FFFFFF';
                }

                cell.style = {
                    font: { name: 'Times New Roman', size: 11, bold: true, color: { argb: fontColor } },
                    alignment: { horizontal: 'center', vertical: 'middle' },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } },
                    border: createFullBorder()
                };
            });
            totalRow.height = 20;

            // Thêm 20 dòng trống có border
            for (let i = 0; i < 20; i++) {
                const emptyRow = worksheet.addRow(['', '', '', '', '', '', '', '', '', '', '', '']);
                emptyRow.eachCell((cell) => {
                    cell.style = {
                        border: createFullBorder()
                    };
                });
                emptyRow.height = 20;
            }
        }

        // Sheet 4: Giao vp hàng nội bộ - có cấu trúc khác
        async function createGiaoVpNoiBoSheetExcelJS(workbook) {
            const worksheet = workbook.addWorksheet('Giao vp hàng nội bộ');

            // Thiết lập độ rộng cột (10 cột thay vì 12)
            worksheet.columns = [
                { width: 6 },   // STT
                { width: 12 },  // Số Po
                { width: 15 },  // Order Kinh Doanh
                { width: 25 },  // Tên sản phẩm
                { width: 8 },   // ĐVT
                { width: 12 },  // Số lượng
                { width: 15 },  // Ngày đóng gói
                { width: 18 },  // Xác nhận từ RRC
                { width: 18 },  // Ghi chú
                { width: 15 }   // Thùng (vị trí)
            ];

            // Tiêu đề chính
            const titleRow = worksheet.addRow(['LIST GIAO HÀNG VĂN PHÒNG HÀNG NỘI BỘ']);
            worksheet.mergeCells('A1:J1');
            titleRow.getCell(1).style = {
                font: { name: 'Times New Roman', size: 20, bold: true },
                alignment: { horizontal: 'center', vertical: 'middle' },
                border: createFullBorder()
            };
            titleRow.height = 25;

            // Header
            const headers = [
                'STT', 'Số Po', 'Order\nKinh Doanh', 'Tên sản phẩm', 'ĐVT', 'Số lượng',
                'Ngày đóng gói', 'Xác nhận từ RRC', 'Ghi chú', 'Thùng\n(vị trí)'
            ];
            const headerRow = worksheet.addRow(headers);

            headerRow.eachCell((cell) => {
                cell.style = {
                    font: { name: 'Times New Roman', size: 11, bold: true },
                    alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'D9D9D9' } },
                    border: createFullBorder()
                };
            });
            headerRow.height = 35;

            // Dòng tổng
            const totalRow = worksheet.addRow([
                '*', '*', '*', '*', '*', 0, '*', '*', '*', '*'
            ]);

            totalRow.eachCell((cell, colNumber) => {
                let fillColor = 'FFFFFF';
                let fontColor = '000000';

                if (colNumber === 6) { // Cột số lượng
                    fillColor = '00B0F0';
                    fontColor = 'FFFFFF';
                }

                cell.style = {
                    font: { name: 'Times New Roman', size: 11, bold: true, color: { argb: fontColor } },
                    alignment: { horizontal: 'center', vertical: 'middle' },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } },
                    border: createFullBorder()
                };
            });
            totalRow.height = 20;

            // Thêm 20 dòng trống có border
            for (let i = 0; i < 20; i++) {
                const emptyRow = worksheet.addRow(['', '', '', '', '', '', '', '', '', '']);
                emptyRow.eachCell((cell) => {
                    cell.style = {
                        border: createFullBorder()
                    };
                });
                emptyRow.height = 20;
            }
        }

        // Hàm helper để tạo border đầy đủ
        function createFullBorder() {
            return {
                top: { style: 'thin', color: { argb: '000000' } },
                bottom: { style: 'thin', color: { argb: '000000' } },
                left: { style: 'thin', color: { argb: '000000' } },
                right: { style: 'thin', color: { argb: '000000' } }
            };
        }

        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;">
            <i class="fas fa-check-circle mr-2"></i>${message}
        </div>
    `;
            document.body.appendChild(notification);

            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function createGiaoVpRrcSheet(wb, dataToExport) {
            // Tính tổng số lượng
            const totalQuantity = dataToExport.reduce((sum, item) => sum + parseInt(item.sll || 0), 0);

            // Tạo header và data
            const headers = [
                'STT', 'Text', 'Order\nKinh Doanh', 'Order\nLệnh phôi', 'Order\nVật liệu',
                'Tên sản phẩm', 'ĐVT', 'Số lượng', 'Ngày đóng\ngói', 'Xác nhận từ RRC',
                'Ghi chú', 'Thùng\n(vị trí)'
            ];

            // Tạo dòng tổng với dấu * cho các cột không có tổng
            const totalRow = [
                '*', '*', '*', '*', '*', '*', '*', totalQuantity, '*', '*', '*', '*'
            ];

            // Tạo dữ liệu
            const data = [
                ['LIST GIAO HÀNG VĂN PHÒNG RRC HÀNG NGÀY'], // Tiêu đề
                headers, // Headers
                totalRow, // Dòng tổng
            ];

            // Thêm dữ liệu
            dataToExport.forEach((item, index) => {
                data.push([
                    index + 1,
                    item.order_kd || '',
                    item.order_kd || '',
                    item.order_phoi || '',
                    item.order_vat_lieu || '',
                    item.ten_chi_tiet || '',
                    item.dvt || '',
                    parseInt(item.sll || 0),
                    item._formattedDate || '',
                    item.loai_giay_to || '',
                    item.ghi_chu || '',
                    ''
                ]);
            });

            // Tạo worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Thiết lập độ rộng cột
            ws['!cols'] = [
                { wch: 5 },   // STT
                { wch: 12 },  // Text
                { wch: 12 },  // Order Kinh Doanh
                { wch: 12 },  // Order Lệnh phôi
                { wch: 12 },  // Order Vật liệu
                { wch: 20 },  // Tên sản phẩm
                { wch: 8 },   // ĐVT
                { wch: 10 },  // Số lượng
                { wch: 12 },  // Ngày đóng gói
                { wch: 15 },  // Xác nhận từ RRC
                { wch: 15 },  // Ghi chú
                { wch: 12 }   // Thùng (vị trí)
            ];

            // Merge cell cho tiêu đề
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 11 } } // Merge tiêu đề
            ];

            // Định dạng cells
            const range = XLSX.utils.decode_range(ws['!ref']);

            for (let R = range.s.r; R <= range.e.r; R++) {
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });

                    if (!ws[cellAddress]) {
                        ws[cellAddress] = { t: 's', v: '' };
                    }

                    // Định dạng tiêu đề chính (dòng 0)
                    if (R === 0) {
                        ws[cellAddress].s = {
                            font: {
                                bold: true,
                                size: 20,
                                name: 'Times New Roman'
                            },
                            alignment: {
                                horizontal: 'center',
                                vertical: 'center'
                            },
                            fill: {
                                fgColor: { rgb: 'FFFFFF' }
                            }
                        };
                    }
                    // Định dạng header (dòng 1)
                    else if (R === 1) {
                        ws[cellAddress].s = {
                            font: {
                                bold: true,
                                size: 10,
                                name: 'Times New Roman'
                            },
                            alignment: {
                                horizontal: 'center',
                                vertical: 'center',
                                wrapText: true
                            },
                            fill: {
                                fgColor: { rgb: 'F2F2F2' }
                            },
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: { style: 'thin', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                    }
                    // Định dạng dòng tổng (dòng 2)
                    else if (R === 2) {
                        let fill = {};
                        let font = {
                            size: 10,
                            name: 'Times New Roman',
                            bold: true // Dòng tổng in đậm
                        };

                        // Cột số lượng có background màu xanh nhạt và hiển thị tổng
                        if (C === 7) {
                            fill.fgColor = { rgb: 'E6F3FF' };
                        }

                        ws[cellAddress].s = {
                            font: font,
                            alignment: {
                                horizontal: 'center',
                                vertical: 'center'
                            },
                            fill: fill,
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: { style: 'thin', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                    }
                    // Định dạng dữ liệu (từ dòng 3 trở đi)
                    else if (R >= 3) {
                        let alignment = { vertical: 'center' };
                        let fill = {};

                        // Căn giữa cho các cột số
                        if (C === 0 || C === 6 || C === 7) { // STT, ĐVT, Số lượng
                            alignment.horizontal = 'center';
                        }
                        // Cột số lượng có background màu xanh nhạt
                        if (C === 7) {
                            fill.fgColor = { rgb: 'E6F3FF' };
                        }

                        ws[cellAddress].s = {
                            font: {
                                size: 10,
                                name: 'Times New Roman'
                            },
                            alignment: alignment,
                            fill: fill,
                            border: {
                                top: { style: 'thin', color: { rgb: 'CCCCCC' } },
                                bottom: { style: 'thin', color: { rgb: 'CCCCCC' } },
                                left: { style: 'thin', color: { rgb: 'CCCCCC' } },
                                right: { style: 'thin', color: { rgb: 'CCCCCC' } }
                            }
                        };
                    }
                }
            }

            // Thiết lập chiều cao dòng
            ws['!rows'] = [
                { hpt: 25 }, // Tiêu đề
                { hpt: 40 }, // Header
                { hpt: 25 }, // Dòng tổng
            ];

            // Thêm chiều cao cho các dòng dữ liệu
            for (let i = 3; i < data.length; i++) {
                if (!ws['!rows'][i]) ws['!rows'][i] = {};
                ws['!rows'][i].hpt = 20;
            }

            XLSX.utils.book_append_sheet(wb, ws, 'Giao vp rrc');
        }

        function createEmptySheets(wb) {
            // Sheet "Giao vp autel"
            const wsAutel = createEmptySheet(
                'LIST GIAO HÀNG VĂN PHÒNG AUTEL HÀNG NGÀY',
                ['STT', 'Số Po', 'Order\nKinh Doanh', 'Order\nLệnh phôi', 'Order\nVật liệu', 'Tên sản phẩm', 'ĐVT', 'Số lượng', 'Ngày đóng\ngói', 'Xác nhận từ RRC', 'Ghi chú', 'Thùng\n(vị trí)']
            );
            XLSX.utils.book_append_sheet(wb, wsAutel, 'Giao vp autel');

            // Sheet "Giao vp khác"
            const wsKhac = createEmptySheet(
                'LIST GIAO HÀNG VĂN PHÒNG HÀNG KHÁC HÀNG NGÀY',
                ['STT', 'Số Po', 'Order\nKinh Doanh', 'Order\nLệnh phôi', 'Order\nVật liệu', 'Tên sản phẩm', 'ĐVT', 'Số lượng', 'Ngày đóng\ngói', 'Xác nhận từ RRC', 'Ghi chú', 'Thùng\n(vị trí)']
            );
            XLSX.utils.book_append_sheet(wb, wsKhac, 'Giao vp khác');

            // Sheet "Giao vp hàng nội bộ"
            const wsNoiBo = createEmptySheet(
                'LIST GIAO HÀNG VĂN PHÒNG HÀNG NỘI BỘ',
                ['STT', 'Số Po', 'Order\nKinh Doanh', 'Tên sản phẩm', 'ĐVT', 'Số lượng', 'Ngày đóng gói', 'Xác nhận từ RRC', 'Ghi chú', 'Thùng\n(vị trí)']
            );
            XLSX.utils.book_append_sheet(wb, wsNoiBo, 'Giao vp hàng nội bộ');
        }

        function createEmptySheet(title, headers) {
            // Tạo dòng tổng với dấu * cho tất cả các cột trừ cột số lượng
            const totalRow = headers.map((header, index) => {
                // Tìm cột "Số lượng" 
                if (header.includes('Số lượng')) {
                    return 0; // Giá trị mặc định cho tổng
                }
                return '*'; // Dấu * cho các cột khác
            });

            const data = [
                [title],
                headers,
                totalRow // Thêm dòng tổng
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);

            // Thiết lập độ rộng cột
            const colCount = headers.length;
            ws['!cols'] = Array(colCount).fill({ wch: 12 });

            // Merge cell cho tiêu đề
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: colCount - 1 } }
            ];

            // Định dạng giống như sheet chính
            const range = XLSX.utils.decode_range(ws['!ref']);

            for (let R = range.s.r; R <= range.e.r; R++) {
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });

                    if (!ws[cellAddress]) {
                        ws[cellAddress] = { t: 's', v: '' };
                    }

                    if (R === 0) {
                        ws[cellAddress].s = {
                            font: { bold: true, size: 20, name: 'Times New Roman' },
                            alignment: { horizontal: 'center', vertical: 'center' },
                            fill: { fgColor: { rgb: 'FFFFFF' } }
                        };
                    } else if (R === 1) {
                        ws[cellAddress].s = {
                            font: { bold: true, size: 10, name: 'Times New Roman' },
                            alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                            fill: { fgColor: { rgb: 'F2F2F2' } },
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: { style: 'thin', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                    } else if (R === 2) {
                        // Định dạng dòng tổng
                        let fill = {};
                        let font = {
                            size: 10,
                            name: 'Times New Roman',
                            bold: true
                        };

                        // Tìm cột số lượng để tô màu
                        const header = headers[C];
                        if (header && header.includes('Số lượng')) {
                            fill.fgColor = { rgb: 'E6F3FF' };
                        }

                        ws[cellAddress].s = {
                            font: font,
                            alignment: { horizontal: 'center', vertical: 'center' },
                            fill: fill,
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: { style: 'thin', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                    }
                }
            }

            ws['!rows'] = [
                { hpt: 25 }, // Tiêu đề
                { hpt: 40 }, // Header
                { hpt: 25 }  // Dòng tổng
            ];

            return ws;
        }

        // Export functionality (in biên bản)
        function generateExport() {
            const selectedItems = allData.filter(item => selectedRows.has(item._id));

            if (selectedItems.length === 0) {
                alert('Vui lòng chọn ít nhất một dòng để in biên bản');
                return;
            }

            generateExportTemplate(selectedItems);
        }

        function generateExportTemplate(selectedItems) {
            const printArea = document.getElementById('printArea');
            const itemsPerPage = 36;
            const totalPages = Math.ceil(selectedItems.length / itemsPerPage);

            let allContent = '';

            for (let page = 0; page < totalPages; page++) {
                const startIndex = page * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, selectedItems.length);
                const pageItems = selectedItems.slice(startIndex, endIndex);

                let pageContent = `
          <div style="font-family:'Times New Roman', Times, serif; page-break-after: ${page < totalPages - 1 ? 'always' : 'auto'};">
              <div style="text-align: center; font-weight: bold; font-size: 24px; margin-bottom: 10px;">BIÊN BẢN CHECK GIAO KHO VP</div>
              <div style="font-weight: bold; font-style: italic; font-size: 14px;">Lần: ......... &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Giao Kho VP: ......... h ........, ngày ........ tháng ........ năm 20........</div>
              
              <table style="width: 100%; border-collapse: collapse; border: 1px solid black; margin-bottom: 10px;">
                  <thead>
                      <tr>
                          <th style="border: 1px solid black; width: 5pt; font-weight: bold; text-align: center; padding: 1px; font-size: 13px;" rowspan="2">Stt</th>
                          <th style="border: 1px solid black; width: 55pt; font-weight: bold; text-align: center; padding: 1px; font-size: 13px;" rowspan="2">Order Vật liệu</th>
                          <th style="border: 1px solid black; width: 55pt; font-weight: bold; text-align: center; padding: 1px; font-size: 13px;" rowspan="2">Order Kinh doanh</th>
                          <th style="border: 1px solid black; width: 75pt; font-weight: bold; text-align: center; padding: 1px; font-size: 13px;" rowspan="2">Tên sản phẩm</th>
                          <th style="border: 1px solid black; width: 7mm; font-weight: bold; text-align: center; padding: 1px; font-size: 13px;" rowspan="2">Số lg</th>
                          <th style="border: 1px solid black; width: 5pt; font-weight: bold; text-align: center; padding: 1px; font-size: 15px;" colspan="7">CHECK THỰC HIỆN</th>
                          <th style="border: 1px solid black; font-weight: bold; text-align: center; padding: 1px; font-size: 13px;" rowspan="2">Ghi chú</th>
                      </tr>
                      <tr>
                          <th style="border: 1px solid black; width: 7mm; font-weight: normal; text-align: center; padding: 4px; font-size: 10px;">Dán tem</th>
                          <th style="border: 1px solid black; width: 7mm; font-weight: normal; text-align: center; padding: 4px; font-size: 10px;">BB ktra</th>
                          <th style="border: 1px solid black; width: 9mm; font-weight: normal; text-align: center; padding: 1px; font-size: 10px;">Dấu Rửa + Sp mới</th>
                          <th style="border: 1px solid black; width: 7mm; font-weight: normal; text-align: center; padding: 4px; font-size: 10x;">Dấu D.gói</th>
                          <th style="border: 1px solid black; width: 7mm; font-weight: normal; text-align: center; padding: 4px; font-size: 10x;">Mail XN</th>
                          <th style="border: 1px solid black; width: 7mm; font-weight: normal; text-align: center; padding: 4px; font-size: 10px;">QR code</th>
                          <th style="border: 1px solid black; width: 7pt; font-weight: normal; text-align: center; padding: 4px; font-size: 11px;">Tổng số gói</th>
                      </tr>
                  </thead>
                  <tbody>
      `;

                pageItems.forEach((item, index) => {
                    const globalIndex = startIndex + index + 1;
                    const orderVL = item.order_vat_lieu || '';
                    const orderKD = item.order_kd || '';
                    const tenSP = item.ten_chi_tiet || '';
                    const soLuong = item.sll || '';
                    const soGoi = item.so_goi || '';
                    const mailxn = item.loai_giay_to || '';
                    const qrcode = item.qr_code || '';

                    let daurua = '';
                    const dongDauRua = (item.dong_dau_rua || '').toUpperCase();
                    const giaCongMoi = (item.gia_cong_moi || '').toUpperCase();

                    const hasSUS = dongDauRua.includes('SUS');
                    const hasGC = giaCongMoi.includes('GC');

                    if (hasSUS || hasGC) {
                        daurua = '';
                    } else {
                        daurua = '\\\\\\\\\\\\\\\\';
                    }

                    let ghiChu = '';
                    const mailxnUpper = mailxn.toUpperCase();
                    const hasBV = mailxnUpper.includes('BẢN VẼ') || mailxnUpper.includes('BV');

                    if (hasSUS && hasGC) {
                        ghiChu = 'BBKT có dấu rửa - BV có dấu g/c lần 1';
                    } else if (daurua === '' && hasBV) {
                        ghiChu = 'BBKT có dấu rửa - BV có dấu g/c lần 1';
                    } else if (hasBV) {
                        ghiChu = 'BV có dấu g/c lần 1';
                    } else if (hasSUS) {
                        ghiChu = 'BBKT có dấu rửa';
                    } else if (hasGC) {
                        ghiChu = 'BV có dấu g/c lần 1';
                    }

                    pageContent += `
      <tr>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1.5px; height: 23px; text-align: center; font-size: 13px;">${globalIndex}</td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1.5px; height: 23px; text-align: center; font-size: 13px;">${orderVL}</td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1.5px; height: 23px; text-align: center; font-size: 13px;">${orderKD}</td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1.5px; height: 23px; text-align: center; font-size: 13px;">${tenSP}</td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1.5px; height: 23px; text-align: center; font-size: 13px;">${soLuong}</td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 9px;"></td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 9px;"></td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 9px;">${daurua}</td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 9px;"></td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 9px;">${mailxn}</td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 9px;">${qrcode}</td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;">${soGoi}</td>
          <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;">${ghiChu}</td>
      </tr>
  `;
                });

                const remainingRows = itemsPerPage - pageItems.length;
                for (let i = 0; i < remainingRows; i++) {
                    const emptyRowIndex = startIndex + pageItems.length + i + 1;
                    pageContent += `
              <tr>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;">${emptyRowIndex}</td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
                  <td style="border-right: 1px solid black; border-bottom: 0.5px dashed #d3d3d3; padding: 1px; height: 23px; text-align: center; font-size: 13px;"></td>
              </tr>
          `;
                }

                pageContent += `
                  </tbody>
              </table>
              
              <div style="text-align: center; margin-top: 10px; font-size: 13px;">
                  <span>Thực hiện việc đến đâu tích dấu "√" vào ô tương ứng bảng bút đó.</span> <br>
                  <span>Kiểm tra lại biên bản đã được tích đủ các ô, các cột mới được giao Kho VP</span>
              </div>
              
              <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                  <div style="text-align: right; width: 40%; font-size: 13px;">
                      <span>Người thực hiện</span>
                  </div>
                  <div style="text-align: left; width: 40%; font-size: 13px;">
                      <span>Người soát xét</span>
                  </div>
              </div>
          </div>
      `;

                allContent += pageContent;
            }

            printArea.innerHTML = allContent;

            const iframe = document.createElement('iframe');
            iframe.name = 'print_frame';
            iframe.style.position = 'absolute';
            iframe.style.top = '-1000px';
            iframe.style.left = '-1000px';
            document.body.appendChild(iframe);

            const frameDoc = iframe.contentWindow ? iframe.contentWindow : iframe.contentDocument.document ? iframe.contentDocument.document : iframe.contentDocument;
            frameDoc.document.open();
            frameDoc.document.write(`
      <title>Biên bản check giao kho VP</title>
      <style>
          @page { 
              size: A4;
              margin: 5mm;
          }
          body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 0;
          }
          th, td {
              text-align: center;
              font-size: 13px;
              padding: 1px;
          }
      </style>
      ${allContent}
  `);
            frameDoc.document.close();

            setTimeout(function () {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                document.body.removeChild(iframe);
            }, 500);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('lanGiaoFilter').addEventListener('change', applyFilters);
        document.getElementById('dateFilter').addEventListener('change', applyFilters);

        document.getElementById('pageSizeSelect').addEventListener('change', function () {
            changePageSize(this.value);
        });

        // Table events with delegation
        document.getElementById('table-body').addEventListener('click', function (e) {
            const row = e.target.closest('tr');
            if (!row || !row.hasAttribute('data-row-id')) return;

            const rowId = row.getAttribute('data-row-id');

            if (e.target.type !== 'checkbox') {
                const checkbox = row.querySelector('.row-checkbox');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    handleRowSelection(checkbox, rowId);
                }
            }
        });

        document.getElementById('table-body').addEventListener('change', function (e) {
            if (e.target.classList.contains('row-checkbox')) {
                const row = e.target.closest('tr');
                const rowId = row.getAttribute('data-row-id');
                handleRowSelection(e.target, rowId);
            }
        });

        // Header controls
        document.getElementById('selectAllCheckbox').addEventListener('change', function () {
            if (this.checked) {
                selectAllCurrentPage();
            } else {
                const currentPageIds = getCurrentPageRowIds();
                currentPageIds.forEach(id => selectedRows.delete(id));

                document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.closest('tr').classList.remove('selected');
                });

                updateStats();
                updateSelectAllCheckbox();
            }
        });

        document.getElementById('selectAllBtn').addEventListener('click', selectAllCurrentPage);
        document.getElementById('selectAllFilteredBtn').addEventListener('click', selectAllFiltered);
        document.getElementById('clearSelectionBtn').addEventListener('click', clearAllSelection);
        document.getElementById('exportBtn').addEventListener('click', generateExport);
        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);

        // Initialize
        fetchData();

        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</body>

</html>
