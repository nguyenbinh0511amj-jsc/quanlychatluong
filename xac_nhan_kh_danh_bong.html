<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XÁC NHẬN KẾ HOẠCH</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        * {
            font-family: 'Times New Roman', Times, serif;
            box-sizing: border-box;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        }

        .input-field {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .select-field {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .select-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Custom Dropdown Styles */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-header {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 45px;
        }

        .dropdown-header:hover {
            border-color: #d1d5db;
        }

        .dropdown-header.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dropdown-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #374151;
        }

        .dropdown-arrow {
            transition: transform 0.2s ease;
            color: #6b7280;
            font-size: 12px;
        }

        .dropdown-header.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: #f9fafb;
        }

        .dropdown-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
            cursor: pointer;
        }

        .dropdown-item label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            margin: 0;
        }

        /* Scrollbar cho dropdown */
        .dropdown-content::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .dropdown-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .dropdown-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .date-range-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-range-group .input-field {
            flex: 1;
            min-width: 0;
        }

        .date-range-separator {
            color: #6b7280;
            font-weight: 500;
            white-space: nowrap;
            font-size: 12px;
        }

        .stats-card {
            background: white;
            padding: 8px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            text-align: center;
        }

        .stats-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .stats-label {
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stats-value {
            font-size: 18px;
            font-weight: bold;
            color: #111827;
        }

        .table-container {
            overflow: auto;
            max-height: 70vh;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            min-width: 1800px;
            border-collapse: collapse;
            font-size: 10px;
        }

        th,
        td {
            border: 1px solid #d1d5db;
            padding: 8px 4px;
            text-align: center;
            vertical-align: middle;
        }

        th {
            background: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 11px;
            font-weight: 600;
        }

        tbody tr:hover {
            background-color: #f9fafb;
        }

        tbody tr.selected {
            background-color: #dbeafe;
        }

        .checkbox-custom {
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
            min-width: 40px;
        }

        .pagination button:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .pagination button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Responsive cho mobile */
        @media (max-width: 768px) {
            body {
                font-size: 12px;
            }

            /* Header mobile */
            .mobile-header {
                padding: 12px 16px;
            }

            .header-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .header-title h1 {
                font-size: 18px;
                line-height: 1.2;
            }

            .header-title p {
                font-size: 12px;
            }

            .header-icon {
                width: 40px;
                height: 40px;
                padding: 8px;
            }

            .header-icon i {
                font-size: 16px;
            }

            /* Buttons mobile */
            .header-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                width: 100%;
            }

            .header-actions .btn {
                justify-content: center;
                padding: 8px 12px;
                font-size: 12px;
                min-height: 40px;
            }

            .header-actions .btn i {
                font-size: 14px;
            }

            /* Filters mobile */
            .filters-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
                padding: 16px !important;
            }

            .filter-group {
                margin-bottom: 8px;
            }

            .filter-label {
                font-size: 11px;
                margin-bottom: 6px;
            }

            .input-field,
            .select-field {
                padding: 10px 12px;
                font-size: 13px;
                border-radius: 6px;
            }

            .dropdown-header {
                padding: 10px 12px;
                font-size: 13px;
                min-height: 40px;
            }
            
            .dropdown-content {
                max-height: 150px;
            }
            
            .dropdown-item {
                padding: 6px 10px;
            }
            
            .dropdown-item label {
                font-size: 13px;
            }
            
            .dropdown-item input[type="checkbox"] {
                width: 14px;
                height: 14px;
            }

            /* Stats mobile */
            .stats-container {
                padding: 12px 16px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
            }

            .stats-card {
                padding: 6px;
                border-radius: 8px;
            }

            .stats-label {
                font-size: 9px;
                margin-bottom: 2px;
            }

            .stats-value {
                font-size: 14px;
            }

            /* Table mobile */
            .table-mobile-container {
                padding: 0 16px 16px;
            }

            .table-container {
                max-height: 60vh;
                border-radius: 8px;
            }

            table {
                font-size: 9px;
                min-width: 1600px;
            }

            th,
            td {
                padding: 6px 3px;
            }

            th {
                font-size: 10px;
                height: 35px;
            }

            /* Pagination mobile */
            .pagination-container {
                padding: 12px 16px;
                background: white;
                border-radius: 0 0 8px 8px;
            }

            .pagination-info {
                font-size: 11px;
                text-align: center;
                margin-bottom: 8px;
            }

            .pagination {
                gap: 4px;
                justify-content: center;
            }

            .pagination button {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 35px;
                border-radius: 6px;
            }

            /* Hide some columns on very small screens */
            @media (max-width: 480px) {
                .header-actions {
                    grid-template-columns: 1fr;
                }

                .stats-grid {
                    grid-template-columns: repeat(2, 1fr) !important;
                }

                .btn {
                    font-size: 11px;
                    padding: 8px 10px;
                }
            }

            /* Compact mode for small screens */
            .compact-mode {
                .stats-card {
                    padding: 4px;
                }

                .stats-value {
                    font-size: 12px;
                }

                .stats-label {
                    font-size: 8px;
                }
            }
        }

        /* Màu cho các cột đặc biệt */
        .xac-nhan-cu-col {
            background-color: #ffeb3b !important;
        }

        .xac-nhan-moi-col {
            background-color: #ffa726 !important;
        }

        .ok-status {
            color: #16a34a;
            font-weight: bold;
        }

        .hbv-status {
            color: #dc2626;
            font-weight: bold;
        }

        /* Màu cho các cột số lượng - CHỈ TRÊN TRANG WEB */
        .sx-xl-nonzero {
            color: #dc2626 !important;
            font-weight: bold !important;
        }

        .tap-via-rua-ktra-goi-nonzero {
            color: #16a34a !important;
            font-weight: bold !important;
        }

        /* Style cho ô input có thể chỉnh sửa */
        .editable-cell {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            padding: 2px 4px;
            min-width: 80px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .editable-cell:hover {
            background-color: #ffeaa7;
            border-color: #ff9f00;
        }

        .editable-input {
            background: white;
            border: 2px solid #007bff;
            padding: 4px 6px;
            font-size: 10px;
            width: 100%;
            min-width: 80px;
            text-align: center;
            border-radius: 3px;
        }

        .editable-input:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .saving-indicator {
            color: #007bff;
            font-size: 9px;
            font-weight: bold;
        }

        .save-success {
            color: #28a745;
            font-size: 9px;
            font-weight: bold;
        }

        .save-error {
            color: #dc3545;
            font-size: 9px;
            font-weight: bold;
        }

        /* Mobile specific improvements */
        @media (max-width: 768px) {
            .mobile-scroll-hint {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #3b82f6;
                color: white;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 11px;
                z-index: 1000;
                animation: fadeInOut 3s ease-in-out;
            }

            @keyframes fadeInOut {

                0%,
                100% {
                    opacity: 0;
                }

                50% {
                    opacity: 1;
                }
            }

            /* Touch-friendly checkboxes */
            .checkbox-custom {
                width: 20px;
                height: 20px;
                margin: 4px;
            }

            /* Better touch targets */
            .btn {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Improved table scrolling */
            .table-container {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            .table-container::-webkit-scrollbar {
                height: 8px;
            }

            .table-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }

            .table-container::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }

            .table-container::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

            .editable-cell {
                min-width: 60px;
                font-size: 9px;
            }

            .editable-input {
                min-width: 60px;
                font-size: 9px;
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="mx-auto mobile-header px-6 py-6">
            <!-- Title Section -->
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                <div class="flex items-center space-x-4 header-title">
                    <div
                        class="bg-gradient-to-r from-blue-500 to-blue-600 p-3 rounded-xl text-white shadow-lg header-icon">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">XÁC NHẬN KẾ HOẠCH</h1>
                        <p class="text-sm text-gray-500 mt-1" id="currentDate"></p>
                    </div>
                </div>

                <div class="header-actions">
                    <button id="selectAllBtn" class="btn btn-secondary">
                        <i class="fas fa-check-square"></i>
                        <span class="hidden sm:inline">Chọn tất cả trang</span>
                        <span class="sm:hidden">Chọn trang</span>
                    </button>
                    <button id="selectAllFilteredBtn" class="btn btn-secondary">
                        <i class="fas fa-check-double"></i>
                        <span class="hidden sm:inline">Chọn tất cả lọc</span>
                        <span class="sm:hidden">Chọn lọc</span>
                        (<span id="filteredCount">0</span>)
                    </button>
                    <button id="clearSelectionBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        <span class="hidden sm:inline">Bỏ chọn</span>
                        <span class="sm:hidden">Bỏ chọn</span>
                    </button>
                    <button id="exportExcelBtn" class="btn btn-primary">
                        <i class="fas fa-file-excel"></i>
                        <span class="hidden sm:inline">Xuất Excel</span>
                        <span class="sm:hidden">Excel</span>
                        (<span id="selectedCountExcel">0</span>)
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="bg-gray-50 rounded-xl p-2">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 filters-grid">
                    <!-- Search -->
                    <div class="filter-group">
                        <label class="filter-label">Tìm kiếm</label>
                        <input type="text" placeholder="Order KD, tên chi tiết..." class="input-field" id="searchInput">
                    </div>

                    <!-- Thời hạn mới của KH filter -->
                    <div class="filter-group">
                        <label class="filter-label">Thời hạn mới của KH</label>
                        <div class="custom-dropdown" id="thoiHanDropdown">
                            <div class="dropdown-header">
                                <span class="dropdown-text">Tất cả</span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="dropdown-content" id="thoiHanContent">
                                <div class="dropdown-item">
                                    <input type="checkbox" id="thoihan_all" value="all" checked>
                                    <label for="thoihan_all">Tất cả</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Xác nhận cũ filter -->
                    <div class="filter-group">
                        <label class="filter-label">Xác nhận cũ</label>
                        <div class="custom-dropdown" id="xacNhanCuDropdown">
                            <div class="dropdown-header">
                                <span class="dropdown-text">Tất cả</span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="dropdown-content" id="xacNhanCuContent">
                                <div class="dropdown-item">
                                    <input type="checkbox" id="xacnhancu_all" value="all" checked>
                                    <label for="xacnhancu_all">Tất cả</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Xác nhận mới filter -->
                    <div class="filter-group">
                        <label class="filter-label">Xác nhận mới</label>
                        <div class="custom-dropdown" id="xacNhanMoiDropdown">
                            <div class="dropdown-header">
                                <span class="dropdown-text">Tất cả</span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="dropdown-content" id="xacNhanMoiContent">
                                <div class="dropdown-item">
                                    <input type="checkbox" id="xacnhanmoi_all" value="all" checked>
                                    <label for="xacnhanmoi_all">Tất cả</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Xác nhận xuất filter -->
                    <div class="filter-group">
                        <label class="filter-label">Xác nhận xuất</label>
                        <div class="custom-dropdown" id="xacNhanXuatDropdown">
                            <div class="dropdown-header">
                                <span class="dropdown-text">Tất cả</span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="dropdown-content" id="xacNhanXuatContent">
                                <div class="dropdown-item">
                                    <input type="checkbox" id="xacnhanxuat_all" value="all" checked>
                                    <label for="xacnhanxuat_all">Tất cả</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Page size selector -->
                    <div class="filter-group">
                        <label class="filter-label">Hiển thị</label>
                        <select id="pageSizeSelect" class="select-field">
                            <option value="100">100 dòng</option>
                            <option value="200" selected>200 dòng</option>
                            <option value="500">500 dòng</option>
                            <option value="700">700 dòng</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Statistics -->
    <div class="mx-auto stats-container p-4">
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-10 gap-4 stats-grid">
            <div class="stats-card">
                <div class="stats-label">Tổng SLL</div>
                <div class="stats-value" id="totalSLLCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">SX</div>
                <div class="stats-value text-blue-600" id="sxCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">XL</div>
                <div class="stats-value text-green-600" id="xlCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">TAP</div>
                <div class="stats-value text-purple-600" id="tapCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">VIA</div>
                <div class="stats-value text-orange-600" id="viaCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Rửa</div>
                <div class="stats-value text-cyan-600" id="ruaCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Ktra</div>
                <div class="stats-value text-pink-600" id="ktraCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Gói</div>
                <div class="stats-value text-indigo-600" id="goiCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Đã gói</div>
                <div class="stats-value text-red-600" id="daGoiCount">0</div>
            </div>
            <div class="stats-card">
                <div class="stats-label">Đã chọn</div>
                <div class="stats-value text-green-600" id="selectedCountStat">0</div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="mx-auto table-mobile-container px-6 pb-6">
        <div class="bg-white rounded-xl shadow-sm">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" class="checkbox-custom"></th>
                            <th>STT</th>
                            <th>Order KD</th>
                            <th>Tên chi tiết</th>
                            <th>File GC</th>
                            <th>Số lượng</th>
                            <th>Ngày GC KT</th>
                            <th>Thời hạn mới của KH</th>
                           <th>Tính chất</th>
                           <th>TT ưu tiên</th>
                           <th class="xac-nhan-cu-col">Xác nhận cũ</th>
                           <th class="xac-nhan-moi-col">Xác nhận mới</th>
                           <th>Xác nhận xuất</th>
                           <th>Trạng thái</th>
                           <th>SX</th>
                           <th>XL</th>
                           <th>TAP</th>
                           <th>VIA</th>
                           <th>Rửa</th>
                           <th>Ktra</th>
                           <th>Gói</th>
                           <th>Đã gói</th>
                           <th>Thông tin</th>
                       </tr>
                   </thead>
                   <tbody id="table-body">
                       <tr>
                           <td colspan="28" class="text-center p-8">
                               <div class="loading"></div>
                               <div class="mt-2">Đang tải...</div>
                           </td>
                       </tr>
                   </tbody>
               </table>
           </div>

           <!-- Pagination -->
           <div class="pagination-container p-6 border-t bg-gray-50 rounded-b-xl">
               <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                   <div class="text-sm text-gray-600 pagination-info" id="paginationInfo">
                       Hiển thị 0 - 0 của 0 kết quả
                   </div>
                   <div class="pagination" id="pagination">
                       <!-- Pagination buttons will be inserted here -->
                   </div>
               </div>
           </div>
       </div>
   </div>

   <!-- Mobile scroll hint -->
   <div class="mobile-scroll-hint hidden" id="scrollHint">
       <i class="fas fa-arrows-alt-h"></i> Vuốt để xem thêm
   </div>

   <script>
       // Global variables
       let allData = [];
       let filteredData = [];
       let selectedRows = new Map();
       let currentPage = 0;
       let pageSize = 200;
       let isLoading = false;

       const appId = 'e1339939-5987-4d7a-8c73-436348abf6b7';
       const accessKey = 'V2-WTcys-x7QFl-Z5SzF-zSe7D-qciuV-yaUHk-CDGEe-oSexL';
       const region = 'www';

       // Custom Dropdown functionality
       class CustomDropdown {
           constructor(dropdownId, contentId, filterId) {
               this.dropdown = document.getElementById(dropdownId);
               this.content = document.getElementById(contentId);
               this.header = this.dropdown.querySelector('.dropdown-header');
               this.text = this.dropdown.querySelector('.dropdown-text');
               this.filterId = filterId;
               
               this.init();
           }
           
           init() {
               // Toggle dropdown khi click header
               this.header.addEventListener('click', (e) => {
                   e.stopPropagation();
                   this.toggle();
               });
               
               // Xử lý click checkbox
               this.content.addEventListener('change', (e) => {
                   if (e.target.type === 'checkbox') {
                       this.handleCheckboxChange(e.target);
                   }
               });
               
               // Ngăn dropdown đóng khi click vào content
               this.content.addEventListener('click', (e) => {
                   e.stopPropagation();
               });
           }
           
           toggle() {
               const isOpen = this.content.classList.contains('show');
               
               // Đóng tất cả dropdown khác
               document.querySelectorAll('.dropdown-content.show').forEach(content => {
                   content.classList.remove('show');
               });
               document.querySelectorAll('.dropdown-header.active').forEach(header => {
                   header.classList.remove('active');
               });
               
               // Toggle dropdown hiện tại
               if (!isOpen) {
                   this.content.classList.add('show');
                   this.header.classList.add('active');
               }
           }
           
           close() {
               this.content.classList.remove('show');
               this.header.classList.remove('active');
           }
           
           handleCheckboxChange(checkbox) {
               const allCheckbox = this.content.querySelector('input[value="all"]');
               
               if (checkbox.value === 'all') {
                   // Nếu chọn "Tất cả", bỏ chọn tất cả các checkbox khác
                   if (checkbox.checked) {
                       this.content.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                           cb.checked = cb.value === 'all';
                       });
                   }
               } else {
                   // Nếu chọn item khác, bỏ chọn "Tất cả"
                   if (checkbox.checked && allCheckbox.checked) {
                       allCheckbox.checked = false;
                   }
                   
                   // Nếu không có gì được chọn, tự động chọn "Tất cả"
                   const checkedItems = this.content.querySelectorAll('input[type="checkbox"]:checked');
                   if (checkedItems.length === 0) {
                       allCheckbox.checked = true;
                   }
               }
               
               this.updateText();
               applyFilters();
           }
           
           updateText() {
               const checkedItems = Array.from(this.content.querySelectorAll('input[type="checkbox"]:checked'));
               const allCheckbox = this.content.querySelector('input[value="all"]');
               
               if (allCheckbox.checked || checkedItems.length === 0) {
                   this.text.textContent = 'Tất cả';
               } else if (checkedItems.length === 1) {
                   this.text.textContent = checkedItems[0].nextElementSibling.textContent;
               } else {
                   this.text.textContent = `Đã chọn ${checkedItems.length} mục`;
               }
           }
           
           getSelectedValues() {
               const checkedItems = Array.from(this.content.querySelectorAll('input[type="checkbox"]:checked'));
               return checkedItems.map(item => item.value);
           }
           
           populateOptions(options, sortFunction) {
               // Xóa tất cả options cũ trừ "Tất cả"
               const allItem = this.content.querySelector('.dropdown-item');
               this.content.innerHTML = '';
               this.content.appendChild(allItem);
               
               // Sắp xếp options
               const sortedOptions = Array.from(options).sort(sortFunction);
               
               // Thêm options mới
               sortedOptions.forEach((option, index) => {
                   const item = document.createElement('div');
                   item.className = 'dropdown-item';
                   
                   const checkbox = document.createElement('input');
                   checkbox.type = 'checkbox';
                   checkbox.id = `${this.filterId}_${index}`;
                   checkbox.value = option;
                   
                   const label = document.createElement('label');
                   label.htmlFor = checkbox.id;
                   label.textContent = option;
                   
                   item.appendChild(checkbox);
                   item.appendChild(label);
                   this.content.appendChild(item);
               });
           }
       }

       // Khởi tạo dropdowns
       let thoiHanDropdown, xacNhanCuDropdown, xacNhanMoiDropdown, xacNhanXuatDropdown;

       // Hàm lấy giá trị được chọn từ dropdown
       function getSelectedValues(filterId) {
           let dropdown;
           switch(filterId) {
               case 'thoiHanFilter':
                   dropdown = thoiHanDropdown;
                   break;
               case 'xacNhanCuFilter':
                   dropdown = xacNhanCuDropdown;
                   break;
               case 'xacNhanMoiFilter':
                   dropdown = xacNhanMoiDropdown;
                   break;
               case 'xacNhanXuatFilter':
                   dropdown = xacNhanXuatDropdown;
                   break;
           }
           return dropdown ? dropdown.getSelectedValues() : ['all'];
       }

       // Mobile-specific functions
       function showMobileScrollHint() {
           if (window.innerWidth <= 768) {
               const hint = document.getElementById('scrollHint');
               hint.classList.remove('hidden');
               setTimeout(() => {
                   hint.classList.add('hidden');
               }, 3000);
           }
       }

       function optimizeForMobile() {
           if (window.innerWidth <= 768) {
               // Reduce page size for mobile
               pageSize = 50;
               document.getElementById('pageSizeSelect').value = '50';

               // Add compact mode for very small screens
               if (window.innerWidth <= 480) {
                   document.body.classList.add('compact-mode');
               }
           }
       }

       // Utility functions
       function debounce(func, wait) {
           let timeout;
           return function (...args) {
               clearTimeout(timeout);
               timeout = setTimeout(() => func.apply(this, args), wait);
           };
       }

       function formatDate(dateString) {
           if (!dateString) return '';
           try {
               const d = new Date(dateString);
               if (isNaN(d.getTime())) return '';
               return `${d.getDate().toString().padStart(2, '0')}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getFullYear()}`;
           } catch (error) {
               return '';
           }
       }

       function generateRowId(item, index) {
           return `${item.order_kd || ''}_${index}`;
       }

       // Set current date
       function setCurrentDate() {
           const today = new Date();
           const dateStr = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;
           document.getElementById('currentDate').textContent = dateStr;
       }

       // Data fetching
       async function fetchData() {
           if (isLoading) return;

           isLoading = true;
           updateLoadingState(true);

           try {
               const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/xac_nhan_ke_hoach_danh_bong/Action`, {
                   method: 'POST',
                   headers: {
                       'ApplicationAccessKey': accessKey,
                       'Content-Type': 'application/json'
                   },
                   body: JSON.stringify({
                       Action: 'Find',
                       Properties: {},
                       Selector: "Filter(xac_nhan_ke_hoach_danh_bong, true)"
                   })
               });

               if (!response.ok) throw new Error('Failed to fetch');
               const data = await response.json();
               if (!Array.isArray(data)) throw new Error('Invalid data');

               allData = data.map((item, index) => ({
                   ...item,
                   _id: generateRowId(item, index),
                   _index: index
               }));

               filteredData = [...allData];
               populateFilters();
               updateStats();
               renderCurrentPage();
               showMobileScrollHint();

           } catch (error) {
               console.error('Error:', error);
               showError('Lỗi tải dữ liệu. Vui lòng thử lại.');
           } finally {
               isLoading = false;
               updateLoadingState(false);
           }
       }

       function updateLoadingState(loading) {
           const tbody = document.getElementById('table-body');
           if (loading) {
               tbody.innerHTML = `
              <tr>
                  <td colspan="28" class="text-center p-8">
                      <div class="loading"></div>
                      <div class="mt-2">Đang tải...</div>
                  </td>
              </tr>
          `;
           }
       }

       function showError(message) {
           const tbody = document.getElementById('table-body');
           tbody.innerHTML = `
         <tr>
             <td colspan="28" class="text-center p-8 text-red-500">
                 <i class="fas fa-exclamation-triangle mr-2"></i>${message}
             </td>
         </tr>
     `;
       }

       // Hàm cập nhật dữ liệu
       async function updateXacNhanMoi(orderKd, newValue) {
           try {
               const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/xac_nhan_ke_hoach_danh_bong/Action`, {
                   method: 'POST',
                   headers: {
                       'ApplicationAccessKey': accessKey,
                       'Content-Type': 'application/json'
                   },
                   body: JSON.stringify({
                       Action: 'Edit',
                       Properties: {},
                       Rows: [{
                           order_kd: orderKd,
                           xac_nhan_moi: newValue
                       }]
                   })
               });

               if (!response.ok) {
                   throw new Error(`HTTP error! status: ${response.status}`);
               }

               const result = await response.json();
               console.log('Update success:', result);

               // Cập nhật dữ liệu local
               const item = allData.find(item => item.order_kd === orderKd);
               if (item) {
                   item.xac_nhan_moi = newValue;
               }

               // Cập nhật filtered data nếu cần
               const filteredItem = filteredData.find(item => item.order_kd === orderKd);
               if (filteredItem) {
                   filteredItem.xac_nhan_moi = newValue;
               }

               // Cập nhật bộ lọc
               populateFilters();

               return true;
           } catch (error) {
               console.error('Error updating xac_nhan_moi:', error);
               return false;
           }
       }

       // Hàm tạo ô có thể chỉnh sửa cho cột "Xác nhận mới"
       function createEditableCell(value, orderKd) {
           const cell = document.createElement('div');
           cell.className = 'editable-cell';
           cell.textContent = value || '';
           cell.setAttribute('data-order-kd', orderKd);
           cell.setAttribute('data-original-value', value || '');

           // Sự kiện click để chỉnh sửa
           cell.addEventListener('click', function (e) {
               e.stopPropagation();
               startEditing(this);
           });

           return cell;
       }

       // Bắt đầu chỉnh sửa
       function startEditing(cell) {
           const originalValue = cell.getAttribute('data-original-value');
           const orderKd = cell.getAttribute('data-order-kd');

           // Tạo input field
           const input = document.createElement('input');
           input.type = 'text';
           input.className = 'editable-input';
           input.value = originalValue;

           // Thay thế cell bằng input
           cell.innerHTML = '';
           cell.appendChild(input);

           // Focus và select text
           input.focus();
           input.select();

           // Xử lý sự kiện
           input.addEventListener('blur', function () {
               finishEditing(cell, input, orderKd, originalValue);
           });

           input.addEventListener('keydown', function (e) {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   input.blur();
               } else if (e.key === 'Escape') {
                   e.preventDefault();
                   cancelEditing(cell, originalValue);
               }
           });
       }

       // Hoàn thành chỉnh sửa
       async function finishEditing(cell, input, orderKd, originalValue) {
           const newValue = input.value.trim();

           // Nếu giá trị không đổi
           if (newValue === originalValue) {
               cancelEditing(cell, originalValue);
               return;
           }

           // Hiển thị trạng thái đang lưu
           cell.innerHTML = '<span class="saving-indicator">Đang lưu...</span>';

           try {
               const success = await updateXacNhanMoi(orderKd, newValue);

               if (success) {
                   // Lưu thành công
                   cell.innerHTML = `<span class="save-success">✓</span> ${newValue}`;
                   cell.setAttribute('data-original-value', newValue);

                   // Sau 2 giây, hiển thị giá trị bình thường
                   setTimeout(() => {
                       cell.innerHTML = newValue;
                       cell.className = 'editable-cell';
                   }, 2000);

               } else {
                   // Lưu thất bại
                   cell.innerHTML = `<span class="save-error">✗ Lỗi</span> ${originalValue}`;

                   // Sau 3 giây, khôi phục giá trị cũ
                   setTimeout(() => {
                       cell.innerHTML = originalValue;
                       cell.className = 'editable-cell';
                   }, 3000);
               }

           } catch (error) {
               // Xử lý lỗi
               cell.innerHTML = `<span class="save-error">✗ Lỗi</span> ${originalValue}`;

               setTimeout(() => {
                   cell.innerHTML = originalValue;
                   cell.className = 'editable-cell';
               }, 3000);
           }
       }

       // Hủy chỉnh sửa
       function cancelEditing(cell, originalValue) {
           cell.innerHTML = originalValue;
           cell.className = 'editable-cell';
       }

       // Filtering
       const applyFilters = debounce(function () {
           const search = document.getElementById('searchInput').value.toLowerCase().trim();

           // Lấy các giá trị được chọn từ multi-select
           const thoiHanValues = getSelectedValues('thoiHanFilter');
           const xacNhanCuValues = getSelectedValues('xacNhanCuFilter');
           const xacNhanMoiValues = getSelectedValues('xacNhanMoiFilter');
           const xacNhanXuatValues = getSelectedValues('xacNhanXuatFilter');

           filteredData = allData.filter(item => {
               // Search filter
               if (search) {
                   const searchableText = [
                       item.order_kd, item.ten_chi_tiet, item.file_gc,
                   ].join(' ').toLowerCase();
                   if (!searchableText.includes(search)) return false;
               }

               // Thời hạn mới của KH filter
               if (thoiHanValues.length > 0 && !thoiHanValues.includes('all')) {
                   const itemDate = formatDate(item.thoi_han);
                   if (!thoiHanValues.includes(itemDate)) {
                       return false;
                   }
               }

               // Xác nhận cũ filter
               if (xacNhanCuValues.length > 0 && !xacNhanCuValues.includes('all')) {
                   const itemValue = (item.xac_nhan_cu || '').toString();
                   if (!xacNhanCuValues.includes(itemValue)) {
                       return false;
                   }
               }

               // Xác nhận mới filter
               if (xacNhanMoiValues.length > 0 && !xacNhanMoiValues.includes('all')) {
                   const itemValue = (item.xac_nhan_moi || '').toString();
                   if (!xacNhanMoiValues.includes(itemValue)) {
                       return false;
                   }
               }

               // Xác nhận xuất filter
               if (xacNhanXuatValues.length > 0 && !xacNhanXuatValues.includes('all')) {
                   const itemValue = (item.amj_xn || '').toString();
                   if (!xacNhanXuatValues.includes(itemValue)) {
                       return false;
                   }
               }

               return true;
           });

           currentPage = 0;
           updateStats();
           renderCurrentPage();
           updatePagination();
       }, 500);

       // Stats
       function updateStats() {
           const totalSLL = allData.reduce((sum, item) => sum + (parseInt(item.sll) || 0), 0);
           const sxCount = allData.reduce((sum, item) => sum + (parseInt(item.loi_ton) || 0), 0);
           const xlCount = allData.reduce((sum, item) => sum + (parseInt(item.loi_ton1) || 0), 0);
           const tapCount = allData.reduce((sum, item) => sum + (parseInt(item.ton_tap) || 0), 0);
           const viaCount = allData.reduce((sum, item) => sum + (parseInt(item.ton_via) || 0), 0);
           const ruaCount = allData.reduce((sum, item) => sum + (parseInt(item.ton_rua) || 0), 0);
           const ktraCount = allData.reduce((sum, item) => sum + (parseInt(item.ton_kiem_tra) || 0), 0);
           const goiCount = allData.reduce((sum, item) => sum + (parseInt(item.ton_goi) || 0), 0);
           const daGoiCount = allData.reduce((sum, item) => sum + (parseInt(item.da_goi) || 0), 0);
           const selected = selectedRows.size;

           document.getElementById('totalSLLCount').textContent = totalSLL;
           document.getElementById('sxCount').textContent = sxCount;
           document.getElementById('xlCount').textContent = xlCount;
           document.getElementById('tapCount').textContent = tapCount;
           document.getElementById('viaCount').textContent = viaCount;
           document.getElementById('ruaCount').textContent = ruaCount;
           document.getElementById('ktraCount').textContent = ktraCount;
           document.getElementById('goiCount').textContent = goiCount;
           document.getElementById('daGoiCount').textContent = daGoiCount;
           document.getElementById('selectedCountStat').textContent = selected;
           document.getElementById('selectedCountExcel').textContent = selected;
           document.getElementById('filteredCount').textContent = filteredData.length;
       }

       // Populate filters
       function populateFilters() {
           // Thời hạn mới của KH filter
           const thoiHanSet = new Set();
           allData.forEach(item => {
               const formattedDate = formatDate(item.thoi_han);
               if (formattedDate && formattedDate.trim()) {
                   thoiHanSet.add(formattedDate.trim());
               }
           });

           thoiHanDropdown.populateOptions(thoiHanSet, (a, b) => {
               const dateA = convertDateStringToDate(a);
               const dateB = convertDateStringToDate(b);
               return dateA - dateB;
           });

           // Xác nhận cũ filter
           const xacNhanCuSet = new Set();
           allData.forEach(item => {
               if (item.xac_nhan_cu && item.xac_nhan_cu.toString().trim()) {
                   xacNhanCuSet.add(item.xac_nhan_cu.toString().trim());
               }
           });

           xacNhanCuDropdown.populateOptions(xacNhanCuSet, (a, b) => {
               if (isDateFormat(a) && isDateFormat(b)) {
                   const dateA = convertDateStringToDate(a);
                   const dateB = convertDateStringToDate(b);
                   return dateA - dateB;
               }
               return a.localeCompare(b);
           });

           // Xác nhận mới filter
           const xacNhanMoiSet = new Set();
           allData.forEach(item => {
               if (item.xac_nhan_moi && item.xac_nhan_moi.toString().trim()) {
                   xacNhanMoiSet.add(item.xac_nhan_moi.toString().trim());
               }
           });

           xacNhanMoiDropdown.populateOptions(xacNhanMoiSet, (a, b) => {
               if (isDateFormat(a) && isDateFormat(b)) {
                   const dateA = convertDateStringToDate(a);
                   const dateB = convertDateStringToDate(b);
                   return dateA - dateB;
               }
               return a.localeCompare(b);
           });

           // Xác nhận xuất filter
           const xacNhanXuatSet = new Set();
           allData.forEach(item => {
               if (item.amj_xn && item.amj_xn.toString().trim()) {
                   xacNhanXuatSet.add(item.amj_xn.toString().trim());
               }
           });

           xacNhanXuatDropdown.populateOptions(xacNhanXuatSet, (a, b) => {
               if (isDateFormat(a) && isDateFormat(b)) {
                   const dateA = convertDateStringToDate(a);
                   const dateB = convertDateStringToDate(b);
                   return dateA - dateB;
               }
               return a.localeCompare(b);
           });
       }

       // Hàm hỗ trợ để kiểm tra xem có phải định dạng ngày không
       function isDateFormat(str) {
           // Kiểm tra các định dạng: dd/mm/yyyy, dd-mm-yyyy, mm/dd/yyyy, yyyy-mm-dd, etc.
           const datePatterns = [
               /^\d{1,2}\/\d{1,2}\/\d{4}$/,     // dd/mm/yyyy hoặc mm/dd/yyyy
               /^\d{1,2}-\d{1,2}-\d{4}$/,      // dd-mm-yyyy
               /^\d{4}-\d{1,2}-\d{1,2}$/,      // yyyy-mm-dd
               /^\d{1,2}\/[a-zA-Z]{3}\/\d{4}$/,// dd/mmm/yyyy (01/Jul/2025)
               /^\d{1,2}-[a-zA-Z]{3}-\d{4}$/   // dd-mmm-yyyy
           ];

           return datePatterns.some(pattern => pattern.test(str));
       }

       // Hàm chuyển đổi chuỗi ngày về đối tượng Date
       function convertDateStringToDate(dateStr) {
           if (!dateStr) return new Date(0);

           try {
               // Xử lý định dạng dd/mmm/yyyy (01/Jul/2025)
               if (dateStr.includes('/') && dateStr.split('/')[1].length === 3) {
                   const parts = dateStr.split('/');
                   const day = parseInt(parts[0]);
                   const monthMap = {
                       'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                       'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                   };
                   const month = monthMap[parts[1]];
                   const year = parseInt(parts[2]);
                   return new Date(year, month, day);
               }

               // Xử lý định dạng dd-mmm-yyyy
               if (dateStr.includes('-') && dateStr.split('-')[1].length === 3) {
                   const parts = dateStr.split('-');
                   const day = parseInt(parts[0]);
                   const monthMap = {
                       'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                       'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                   };
                   const month = monthMap[parts[1]];
                   const year = parseInt(parts[2]);
                   return new Date(year, month, day);
               }

               // Xử lý định dạng dd/mm/yyyy
               if (dateStr.includes('/')) {
                   const parts = dateStr.split('/');
                   if (parts.length === 3) {
                       const day = parseInt(parts[0]);
                       const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                       const year = parseInt(parts[2]);
                       return new Date(year, month, day);
                   }
               }

               // Xử lý định dạng dd-mm-yyyy
               if (dateStr.includes('-')) {
                   const parts = dateStr.split('-');
                   if (parts.length === 3) {
                       // Kiểm tra xem có phải yyyy-mm-dd không
                       if (parts[0].length === 4) {
                           const year = parseInt(parts[0]);
                           const month = parseInt(parts[1]) - 1;
                           const day = parseInt(parts[2]);
                           return new Date(year, month, day);
                       } else {
                           // dd-mm-yyyy
                           const day = parseInt(parts[0]);
                           const month = parseInt(parts[1]) - 1;
                           const year = parseInt(parts[2]);
                           return new Date(year, month, day);
                       }
                   }
               }

               // Fallback: thử parse trực tiếp
               const date = new Date(dateStr);
               return isNaN(date.getTime()) ? new Date(0) : date;

           } catch (error) {
               return new Date(0); // Return epoch if parsing fails
           }
       }

       // Table rendering
       function renderCurrentPage() {
           const tbody = document.getElementById('table-body');
           const startIndex = currentPage * pageSize;
           const endIndex = Math.min(startIndex + pageSize, filteredData.length);
           const pageData = filteredData.slice(startIndex, endIndex);

           if (pageData.length === 0) {
               tbody.innerHTML = '<tr><td colspan="28" class="text-center p-8">Không có dữ liệu</td></tr>';
               updatePaginationInfo(0, 0, 0);
               return;
           }

           const fragment = document.createDocumentFragment();

           pageData.forEach((item, index) => {
               const row = createTableRow(item, startIndex + index + 1);
               fragment.appendChild(row);
           });

           tbody.innerHTML = '';
           tbody.appendChild(fragment);

           updatePaginationInfo(startIndex + 1, endIndex, filteredData.length);
           updateSelectAllCheckbox();
       }

       function createTableRow(item, stt) {
           const row = document.createElement('tr');
           row.setAttribute('data-row-id', item._id);

           const isSelected = selectedRows.has(item._id);
           if (isSelected) {
               row.classList.add('selected');
           }

           const pkyClass = item.pky === 'OK' ? 'ok-status' : (item.pky === 'HBV' ? 'hbv-status' : '');

           // Kiểm tra số khác 0 và áp dụng class tương ứng CHỈ TRÊN TRANG WEB
           const sxValue = parseInt(item.loi_ton) || 0;
           const xlValue = parseInt(item.loi_ton1) || 0;
           const tapValue = parseInt(item.ton_tap) || 0;
           const viaValue = parseInt(item.ton_via) || 0;
           const ruaValue = parseInt(item.ton_rua) || 0;
           const ktraValue = parseInt(item.ton_kiem_tra) || 0;
           const goiValue = parseInt(item.ton_goi) || 0;
           const daGoiValue = parseInt(item.da_goi) || 0;

           const sxClass = sxValue !== 0 ? 'sx-xl-nonzero' : '';
           const xlClass = xlValue !== 0 ? 'sx-xl-nonzero' : '';
           const tapClass = tapValue !== 0 ? 'tap-via-rua-ktra-goi-nonzero' : '';
           const viaClass = viaValue !== 0 ? 'tap-via-rua-ktra-goi-nonzero' : '';
           const ruaClass = ruaValue !== 0 ? 'tap-via-rua-ktra-goi-nonzero' : '';
           const ktraClass = ktraValue !== 0 ? 'tap-via-rua-ktra-goi-nonzero' : '';
           const goiClass = goiValue !== 0 ? 'tap-via-rua-ktra-goi-nonzero' : '';
           const daGoiClass = daGoiValue !== 0 ? 'tap-via-rua-ktra-goi-nonzero' : '';

           // Tạo ô có thể chỉnh sửa cho cột "Xác nhận mới"
           const editableXacNhanMoi = createEditableCell(item.xac_nhan_moi, item.order_kd);

           row.innerHTML = `
            <td><input type="checkbox" class="checkbox-custom row-checkbox" ${isSelected ? 'checked' : ''}></td>
            <td>${item.stt || stt}</td>
            <td>${item.order_kd || ''}</td>
            <td title="${item.ten_chi_tiet || ''}">${item.ten_chi_tiet || ''}</td>
            <td>${item.file_gc || ''}</td>
            <td>${item.sll || ''}</td>
            <td>${item.ngay_gckt}</td>
            <td>${formatDate(item.thoi_han)}</td>
            <td>${item.tinh_chat || ''}</td>
            <td>${item.tt || ''}</td>
            <td class="xac-nhan-cu-col">${item.xac_nhan_cu || ''}</td>
            <td class="xac-nhan-moi-col"></td>
            <td>${item.amj_xn || ''}</td>
            <td class="${pkyClass}">${item.trang_thai || ''}</td>
            <td class="${sxClass}">${item.loi_ton || ''}</td>
            <td class="${xlClass}">${item.loi_ton1 || ''}</td>
            <td class="${tapClass}">${item.ton_tap || ''}</td>
            <td class="${viaClass}">${item.ton_via || ''}</td>
            <td class="${ruaClass}">${item.ton_rua || ''}</td>
            <td class="${ktraClass}">${item.ton_kiem_tra || ''}</td>
            <td class="${goiClass}">${item.ton_goi || ''}</td>
            <td class="${daGoiClass}">${item.da_goi || ''}</td>
            <td title="${item['Thông tin'] || ''}">${item['Thông tin'] || ''}</td>
        `;

           // Thêm ô có thể chỉnh sửa vào cột "Xác nhận mới"
           const xacNhanMoiCell = row.querySelector('.xac-nhan-moi-col');
           xacNhanMoiCell.appendChild(editableXacNhanMoi);

           return row;
       }

       // Pagination
       function updatePagination() {
           const totalPages = Math.ceil(filteredData.length / pageSize);
           const pagination = document.getElementById('pagination');

           if (totalPages <= 1) {
               pagination.innerHTML = '';
               return;
           }

           let html = '';

           html += `<button ${currentPage === 0 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
     <i class="fas fa-chevron-left"></i>
 </button>`;

           const startPage = Math.max(0, currentPage - 2);
           const endPage = Math.min(totalPages - 1, currentPage + 2);

           if (startPage > 0) {
               html += `<button onclick="goToPage(0)">1</button>`;
               if (startPage > 1) {
                   html += '<span>...</span>';
               }
           }

           for (let i = startPage; i <= endPage; i++) {
               html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
         ${i + 1}
     </button>`;
           }

           if (endPage < totalPages - 1) {
               if (endPage < totalPages - 2) {
                   html += '<span>...</span>';
               }
               html += `<button onclick="goToPage(${totalPages - 1})">${totalPages}</button>`;
           }

           html += `<button ${currentPage >= totalPages - 1 ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
     <i class="fas fa-chevron-right"></i>
 </button>`;

           pagination.innerHTML = html;
       }

       function updatePaginationInfo(start, end, total) {
           document.getElementById('paginationInfo').textContent =
               `Hiển thị ${start} - ${end} của ${total} kết quả`;
       }

       function goToPage(page) {
           const totalPages = Math.ceil(filteredData.length / pageSize);
           if (page < 0 || page >= totalPages) return;
           currentPage = page;
           renderCurrentPage();
           updatePagination();
       }

       function changePageSize(newSize) {
           pageSize = parseInt(newSize);
           currentPage = 0;
           renderCurrentPage();
           updatePagination();
       }

       // Selection handling
       function handleRowSelection(checkbox, rowId) {
           const row = checkbox.closest('tr');

           if (checkbox.checked) {
               selectedRows.set(rowId, true);
               row.classList.add('selected');
           } else {
               selectedRows.delete(rowId);
               row.classList.remove('selected');
           }

           updateStats();
           updateSelectAllCheckbox();
       }

       function updateSelectAllCheckbox() {
           const checkbox = document.getElementById('selectAllCheckbox');
           const currentPageIds = getCurrentPageRowIds();
           const selectedInCurrentPage = currentPageIds.filter(id => selectedRows.has(id)).length;

           if (selectedInCurrentPage === 0) {
               checkbox.indeterminate = false;
               checkbox.checked = false;
           } else if (selectedInCurrentPage === currentPageIds.length) {
               checkbox.indeterminate = false;
               checkbox.checked = true;
           } else {
               checkbox.indeterminate = true;
           }
       }

       function getCurrentPageRowIds() {
           return Array.from(document.querySelectorAll('#table-body tr[data-row-id]'))
               .map(row => row.getAttribute('data-row-id'));
       }

       function selectAllCurrentPage() {
           const currentPageIds = getCurrentPageRowIds();
           currentPageIds.forEach(id => selectedRows.set(id, true));

           document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
               checkbox.checked = true;
               checkbox.closest('tr').classList.add('selected');
           });

           updateStats();
           updateSelectAllCheckbox();
       }

       function selectAllFiltered() {
           filteredData.forEach(item => selectedRows.set(item._id, true));

           document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
               checkbox.checked = true;
               checkbox.closest('tr').classList.add('selected');
           });

           updateStats();
           updateSelectAllCheckbox();
       }

       function clearAllSelection() {
           selectedRows.clear();

           document.querySelectorAll('.row-checkbox').forEach(checkbox => {
               checkbox.checked = false;
           });
           document.querySelectorAll('tr.selected').forEach(row => {
               row.classList.remove('selected');
           });

           updateStats();
           updateSelectAllCheckbox();
       }

       // Excel Export functionality
       async function generateExcelExport() {
           const selectedItems = filteredData.filter(item => selectedRows.has(item._id));

           if (selectedItems.length === 0) {
               alert('Vui lòng chọn ít nhất một dòng để xuất Excel');
               return;
           }

           try {
               // Hiển thị loading
               const exportBtn = document.getElementById('exportExcelBtn');
               const originalText = exportBtn.innerHTML;
               exportBtn.innerHTML = '<div class="loading"></div> <span class="hidden sm:inline">Đang xuất...</span><span class="sm:hidden">Xuất...</span>';
               exportBtn.disabled = true;

               const workbook = new ExcelJS.Workbook();

               // Tạo Sheet 1: XN AMJ (dữ liệu thực)
               const worksheet1 = workbook.addWorksheet('XN AMJ');
               await createExcelWorksheetWithFormat(worksheet1, selectedItems);

               // Tạo Sheet 2: XN AMJ (2) (chỉ có tiêu đề)
               const worksheet2 = workbook.addWorksheet('XN AMJ (2)');
               await createExcelWorksheet2EmptyWithFormat(worksheet2);

               // Tạo tên file với ngày hiện tại
               const today = new Date();
               const dateStr = `${today.getDate()}_${today.getMonth() + 1}_${today.getFullYear()}`;
               const filename = `Xac_nhan_ke_hoach_danh_bong_${dateStr}.xlsx`;

               // Xuất file
               const buffer = await workbook.xlsx.writeBuffer();
               const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

               // Tạo link download
               const url = window.URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = filename;
               a.click();
               window.URL.revokeObjectURL(url);

               // Khôi phục nút
               exportBtn.innerHTML = originalText;
               exportBtn.disabled = false;

           } catch (error) {
               console.error('Lỗi xuất Excel:', error);
               alert('Có lỗi xảy ra khi xuất Excel. Vui lòng thử lại.');

               // Khôi phục nút
               const exportBtn = document.getElementById('exportExcelBtn');
               exportBtn.innerHTML = originalText;
               exportBtn.disabled = false;
           }
       }

       // Tạo worksheet 2 chỉ có tiêu đề (không có dữ liệu)
       async function createExcelWorksheet2EmptyWithFormat(worksheet) {
           // Thiết lập trang in A4 ngang
           worksheet.pageSetup = {
               paperSize: 9, // A4
               orientation: 'landscape', // Ngang
               fitToPage: true,
               fitToWidth: 1,
               fitToHeight: 0,
               margins: {
                   left: 0.25,
                   right: 0.25,
                   top: 0.75,
                   bottom: 0.75,
                   header: 0.3,
                   footer: 0.3
               },
               printArea: 'A1:X1000',
               scale: 100
           };

           // Thiết lập độ rộng cột giống sheet 1
           worksheet.columns = [
               { width: 5 },    // A - STT
               { width: 11 },   // B - Order KD
               { width: 10 },   // C - Order lệnh phôi
               { width: 15 },   // D - Order vật liệu
               { width: 18 },   // E - Tên chi tiết
               { width: 8 },    // F - File GC
               { width: 10 },   // G - PKY
               { width: 8 },    // H - Số lượng
               { width: 12 },   // I - Ngày GC KT
               { width: 12 },   // J - Thời hạn mới của KH
               { width: 15 },   // K - Tính chất
               { width: 8 },    // L - TT ưu tiên
               { width: 12 },   // M - Xác nhận cũ
               { width: 12 },   // N - Xác nhận mới
               { width: 12 },   // O - AMJ xác nhận
               { width: 12 },   // P - Trạng thái
               { width: 8 },    // Q - SX
               { width: 8 },    // R - XL
               { width: 8 },    // S - TAP
               { width: 8 },    // T - VIA
               { width: 8 },    // U - Rửa
               { width: 8 },    // V - Ktra
               { width: 8 },    // W - Gói
               { width: 8 },    // X - Đã gói
               { width: 15 }    // Y - Thông tin
           ];

           // Header (dòng 1) - giống sheet 1
           const headerRow = worksheet.addRow([
               'STT', 'Order KD', 'Order lệnh phôi', 'Order vật liệu', 'Tên chi tiết',
               'File GC', 'PKY', 'Số lượng', 'Ngày GC KT', 'Thời hạn mới của KH',
               'Tính chất', 'TT ưu tiên', 'Xác nhận cũ', 'Xác nhận mới', 'AMJ xác nhận', 'Trạng thái', 'SX',
               'XL', 'TAP', 'VIA', 'Rửa', 'Ktra', 'Gói', 'Đã gói', 'Thông tin'
           ]);

           // Định dạng cho header giống sheet 1
           const headerBorderStyle = {
               top: { style: 'thin', color: { argb: '000000' } },
               bottom: { style: 'thin', color: { argb: '000000' } },
               left: { style: 'thin', color: { argb: '000000' } },
               right: { style: 'thin', color: { argb: '000000' } }
           };

           const headerStyle = {
               font: { name: 'Times New Roman', size: 10, bold: true },
               alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
               border: headerBorderStyle,
               fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'b4c6e7' } }
           };

           // Áp dụng style cho header
           headerRow.eachCell((cell, colNumber) => {
               cell.style = { ...headerStyle };

               // Màu nền đặc biệt cho cột "Xác nhận cũ" và "Xác nhận mới"
               if (colNumber === 13) { // Xác nhận cũ
                   cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEB3B' } };
               } else if (colNumber === 14) { // Xác nhận mới
                   cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFA726' } };
               }
           });
           headerRow.height = 38;

           // Thêm một số dòng trống có border để người dùng có thể nhập dữ liệu
           for (let i = 0; i < 50; i++) {
               const emptyRow = worksheet.addRow([
                   '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''
               ]);

               emptyRow.eachCell((cell) => {
                   cell.style = {
                       border: {
                           top: { style: 'thin', color: { argb: '000000' } },
                           bottom: { style: 'thin', color: { argb: '000000' } },
                           left: { style: 'thin', color: { argb: '000000' } },
                           right: { style: 'thin', color: { argb: '000000' } }
                       }
                   };
               });
               emptyRow.height = 18;
           }

           // Freeze panes để cố định header khi scroll
           worksheet.views = [
               { state: 'frozen', ySplit: 1 }
           ];
       }

       // Tạo worksheet với định dạng chi tiết theo mẫu - BÌNH THƯỜNG KHÔNG CÓ MÀU
       async function createExcelWorksheetWithFormat(worksheet, selectedItems) {
           // Thiết lập trang in A4 ngang
           worksheet.pageSetup = {
               paperSize: 9, // A4
               orientation: 'landscape', // Ngang
               fitToPage: true,
               fitToWidth: 1,
               fitToHeight: 0,
               margins: {
                   left: 0.25,
                   right: 0.25,
                   top: 0.75,
                   bottom: 0.75,
                   header: 0.3,
                   footer: 0.3
               },
               printArea: 'A1:Y1000',
               scale: 100
           };

           // Thiết lập độ rộng cột theo mẫu
           worksheet.columns = [
               { width: 5 },    // A - STT
               { width: 11 },   // B - Order KD
               { width: 10 },   // C - Order lệnh phôi
               { width: 15 },   // D - Order vật liệu
               { width: 18 },   // E - Tên chi tiết
               { width: 8 },    // F - File GC
               { width: 10 },   // G - PKY
               { width: 8 },    // H - Số lượng
               { width: 12 },   // I - Ngày GC KT
               { width: 12 },   // J - Thời hạn mới của KH
               { width: 15 },   // K - Tính chất
               { width: 8 },    // L - TT ưu tiên
               { width: 12 },   // M - Xác nhận cũ
               { width: 12 },   // N - Xác nhận mới
               { width: 12 },   // O - AMJ xác nhận
               { width: 12 },   // P - Trạng thái
               { width: 8 },    // Q - SX
               { width: 8 },    // R - XL
               { width: 8 },    // S - TAP
               { width: 8 },    // T - VIA
               { width: 8 },    // U - Rửa
               { width: 8 },    // V - Ktra
               { width: 8 },    // W - Gói
               { width: 8 },    // X - Đã gói
               { width: 15 }    // Y - Thông tin
           ];

           // Header (dòng 1)
           const headerRow = worksheet.addRow([
               'STT', 'Order KD', 'Order lệnh phôi', 'Order vật liệu', 'Tên chi tiết',
               'File GC', 'PKY', 'Số lượng', 'Ngày GC KT', 'Thời hạn mới của KH',
               'Tính chất', 'TT ưu tiên', 'Xác nhận cũ', 'Xác nhận mới', 'AMJ xác nhận', 'Trạng thái', 'SX',
               'XL', 'TAP', 'VIA', 'Rửa', 'Ktra', 'Gói', 'Đã gói', 'Thông tin'
           ]);

           // Định dạng cho header
           const headerBorderStyle = {
               top: { style: 'thin', color: { argb: '000000' } },
               bottom: { style: 'thin', color: { argb: '000000' } },
               left: { style: 'thin', color: { argb: '000000' } },
               right: { style: 'thin', color: { argb: '000000' } }
           };

           const headerStyle = {
               font: { name: 'Times New Roman', size: 10, bold: true },
               alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
               border: headerBorderStyle,
               fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'b4c6e7' } }
           };

           // Áp dụng style cho header
           headerRow.eachCell((cell, colNumber) => {
               cell.style = { ...headerStyle };

               // Màu nền đặc biệt cho cột "Xác nhận cũ" và "Xác nhận mới"
               if (colNumber === 13) { // Xác nhận cũ
                   cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEB3B' } };
               } else if (colNumber === 14) { // Xác nhận mới
                   cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFA726' } };
               }
           });
           headerRow.height = 38;

           // Thêm dữ liệu
           selectedItems.forEach((item, index) => {
               const rowData = [
                   index + 1, // STT
                   item.order_kd || '',
                   item.order_phoi || '',
                   item.order_vat_lieu || '',
                   item.ten_chi_tiet || '',
                   item.file_gc || '',
                   item.pky || '',
                   item.sll || '',
                   item.ngay_gckt,
                   formatDate(item.thoi_han),
                   item.tinh_chat || '',
                   item.tt || '',
                   item.xac_nhan_cu || '',
                   item.xac_nhan_moi || '',
                   item.amj_xn || '',
                   item.trang_thai || '',
                   item.loi_ton || '',
                   item.loi_ton1 || '',
                   item.ton_tap || '',
                   item.ton_via || '',
                   item.ton_rua || '',
                   item.ton_kiem_tra || '',
                   item.ton_goi || '',
                   item.da_goi || '',
                   item['Thông tin'] || ''
               ];

               const dataRow = worksheet.addRow(rowData);

               // Định dạng cho dòng dữ liệu - BÌNH THƯỜNG KHÔNG CÓ MÀU ĐẶC BIỆT
               dataRow.eachCell((cell, colNumber) => {
                   let cellBorder = {
                       top: { style: 'thin', color: { argb: '000000' } },
                       left: { style: 'thin', color: { argb: '000000' } },
                       right: { style: 'thin', color: { argb: '000000' } },
                       bottom: { style: 'thin', color: { argb: '000000' } }
                   };

                   let numFmt = undefined;
                   let cellValue = cell.value;

                   // Định dạng số cho các cột cụ thể: Order KD, Số lượng, SX, XL, TAP, VIA, Rửa, Ktra, Gói, Đã gói
                   const columnsToFormat = [2, 8, 17, 18, 19, 20, 21, 22, 23, 24];

                   if (columnsToFormat.includes(colNumber)) {
                       if (cellValue && !isNaN(cellValue) && cellValue !== '') {
                           // Chuyển về số
                           cell.value = parseInt(cellValue, 10);

                           // Định dạng đặc biệt cho Order KD (cột 2) - giữ số 0 đầu
                           if (colNumber === 2) {
                               numFmt = '0000000000'; // 10 chữ số với số 0 đầu
                           } else {
                               numFmt = '0'; // Định dạng số thông thường
                           }
                       } else if (cellValue === '' || cellValue === null || cellValue === undefined) {
                           // Để trống cho các giá trị rỗng
                           cell.value = '';
                           numFmt = '@'; // Text format
                       } else {
                           // Giữ nguyên giá trị text
                           numFmt = '@'; // Text format
                       }
                   }

                   // Định dạng BÌNH THƯỜNG - không có màu đặc biệt cho các cột số lượng
                   cell.style = {
                       font: {
                           name: 'Times New Roman',
                           size: 9,
                           bold: false,
                           color: { argb: '000000' } // Màu đen bình thường
                       },
                       alignment: { horizontal: 'center', vertical: 'middle', wrapText: true },
                       border: cellBorder
                   };

                   // CHỈ GIỮ màu nền cho cột "Xác nhận cũ" và "Xác nhận mới"
                   if (colNumber === 13) { // Xác nhận cũ
                       cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEB3B' } };
                   } else if (colNumber === 14) { // Xác nhận mới
                       cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFA726' } };
                   }

                   // Áp dụng định dạng số
                   if (numFmt) {
                       cell.numFmt = numFmt;
                   }
               });

               dataRow.height = 18;
           });

           // Freeze panes để cố định header khi scroll
           worksheet.views = [
               { state: 'frozen', ySplit: 1 }
           ];
       }

       // Event listeners
       document.addEventListener('DOMContentLoaded', function () {
           // Khởi tạo custom dropdowns
           thoiHanDropdown = new CustomDropdown('thoiHanDropdown', 'thoiHanContent', 'thoihan');
           xacNhanCuDropdown = new CustomDropdown('xacNhanCuDropdown', 'xacNhanCuContent', 'xacnhancu');
           xacNhanMoiDropdown = new CustomDropdown('xacNhanMoiDropdown', 'xacNhanMoiContent', 'xacnhanmoi');
           xacNhanXuatDropdown = new CustomDropdown('xacNhanXuatDropdown', 'xacNhanXuatContent', 'xacnhanxuat');
           
           // Đóng dropdown khi click bên ngoài
           document.addEventListener('click', () => {
               document.querySelectorAll('.dropdown-content.show').forEach(content => {
                   content.classList.remove('show');
               });
               document.querySelectorAll('.dropdown-header.active').forEach(header => {
                   header.classList.remove('active');
               });
           });

           // Initialize mobile optimizations
           optimizeForMobile();

           // Handle window resize
           window.addEventListener('resize', debounce(optimizeForMobile, 250));

           // Search and filters
           document.getElementById('searchInput').addEventListener('input', applyFilters);

           // Page size
           document.getElementById('pageSizeSelect').addEventListener('change', function () {
               changePageSize(this.value);
           });

           // Header controls
           document.getElementById('selectAllCheckbox').addEventListener('change', function () {
               if (this.checked) {
                   selectAllCurrentPage();
               } else {
                   const currentPageIds = getCurrentPageRowIds();
                   currentPageIds.forEach(id => selectedRows.delete(id));

                   document.querySelectorAll('#table-body .row-checkbox').forEach(checkbox => {
                       checkbox.checked = false;
                       checkbox.closest('tr').classList.remove('selected');
                   });

                   updateStats();
                   updateSelectAllCheckbox();
               }
           });

           document.getElementById('selectAllBtn').addEventListener('click', selectAllCurrentPage);
           document.getElementById('selectAllFilteredBtn').addEventListener('click', selectAllFiltered);
           document.getElementById('clearSelectionBtn').addEventListener('click', clearAllSelection);
           document.getElementById('exportExcelBtn').addEventListener('click', generateExcelExport);
       });

       // Table events with delegation
       document.getElementById('table-body').addEventListener('click', function (e) {
           const row = e.target.closest('tr');
           if (!row || !row.hasAttribute('data-row-id')) return;

           const rowId = row.getAttribute('data-row-id');

           // Không xử lý click nếu đang click vào ô có thể chỉnh sửa
           if (e.target.closest('.editable-cell') || e.target.closest('.editable-input')) {
               return;
           }

           if (e.target.type !== 'checkbox') {
               const checkbox = row.querySelector('.row-checkbox');
               if (checkbox) {
                   checkbox.checked = !checkbox.checked;
                   handleRowSelection(checkbox, rowId);
               }
           }
       });

       document.getElementById('table-body').addEventListener('change', function (e) {
           if (e.target.classList.contains('row-checkbox')) {
               const row = e.target.closest('tr');
               const rowId = row.getAttribute('data-row-id');
               handleRowSelection(e.target, rowId);
           }
       });

       // Disable context menu and dev tools
       document.addEventListener('contextmenu', function (e) {
           e.preventDefault();
       }, false);

       document.onkeydown = function (e) {
           if (e.keyCode == 123) {
               return false;
           }
           if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
               return false;
           }
           if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
               return false;
           }
           if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
               return false;
           }
       };

       // Touch events for mobile
       let touchStartY = 0;
       let touchEndY = 0;

       document.addEventListener('touchstart', function (e) {
           touchStartY = e.changedTouches[0].screenY;
       });

       document.addEventListener('touchend', function (e) {
           touchEndY = e.changedTouches[0].screenY;
           handleSwipe();
       });

       function handleSwipe() {
           const swipeThreshold = 50;
           const diff = touchStartY - touchEndY;
       }

       // Initialize
       setCurrentDate();
       fetchData();
   </script>
</body>

</html>
