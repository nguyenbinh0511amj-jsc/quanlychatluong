<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xu·∫•t d·ªØ li·ªáu AppSheet ra Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 50px;
            font-size: 2.8em;
            font-weight: 300;
        }
        
        .info-card {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .button-group {
            text-align: center;
            margin: 50px 0;
        }
        
        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            margin: 0 15px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,123,255,0.3);
            min-width: 200px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            margin-top: 30px;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .data-preview {
            margin-top: 30px;
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: #f8f9fa;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-preview th, .data-preview td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-preview th {
            background: #007bff;
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
        }
        
        .search-container {
            margin: 30px 0;
            text-align: center;
        }
        
        .search-box {
            width: 100%;
            max-width: 500px;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .search-box:focus {
            border-color: #007bff;
            box-shadow: 0 4px 20px rgba(0,123,255,0.2);
        }
        
        .search-info {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .highlight {
            background-color: #fff3cd;
            color: #856404;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        /* Pagination and row selection styles */
        .pagination-controls {
            margin: 20px 0;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
        }
        
        .rows-per-page {
            padding: 5px 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .pagination-btn {
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .pagination-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Xu·∫•t D·ªØ Li·ªáu D·ª•ng C·ª•</h1>
        
        <div class="button-group">
            <button onclick="fetchAndExportData()" id="exportBtn">
                üì• L·∫•y d·ªØ li·ªáu v√† xu·∫•t Excel
            </button>
            <button onclick="clearStatus()" id="clearBtn">
                üßπ X√≥a k·∫øt qu·∫£
            </button>
        </div>
        
        <div class="search-container" id="searchContainer" style="display: none;">
            <input type="text" 
                   class="search-box" 
                   id="searchInput" 
                   placeholder="üîç T√¨m ki·∫øm trong t·∫•t c·∫£ c√°c c·ªôt..." 
                   oninput="searchData()">
            <div class="search-info" id="searchInfo"></div>
        </div>
        
        <div id="status"></div>
        <div id="dataPreview"></div>
    </div>

    <script>
        // C·∫•u h√¨nh AppSheet API
        const APP_ID = 'bd6e1158-d412-4790-88fe-d8e2a46206cb';
        const ACCESS_KEY = 'V2-6wqzK-qw3K3-bMSkd-ikr4H-pz5SG-02Xzy-IumRs-6oMzl';
        const TABLE_NAME = 'dung_cu';
        
        // Danh s√°ch c√°c tr∆∞·ªùng c·∫ßn l·∫•y t·ª´ API (ƒë·∫ßy ƒë·ªß)
        const API_FIELDS = [
            'id', 'ten_dung_cu', 'chung_loai', 'dung_cu_dien_tu_co', 'so_series',
            'ngay_nhan_dung_cu', 'tinh_trang_dung_cu', 'ghi_chu', 'noi_quan_ly',
            'vi_tri', 'ngay_kiem_ke', 'trang_thai', 'sl_ok', 'sl_ng', 'update',
            'Code', 'ho_va_ten', 'hinh_anh_kiem_ke', 'ngay_huy', 'xac_nhan_dung_cu_loi',
            'Duy·ªát', 'id_lich_su_muon_tra'
        ];

        // Danh s√°ch c√°c tr∆∞·ªùng hi·ªÉn th·ªã tr√™n web v√† xu·∫•t Excel
        const DISPLAY_FIELDS = [
            'ten_dung_cu', 'chung_loai', 'dung_cu_dien_tu_co', 'so_series',
            'ngay_nhan_dung_cu', 'tinh_trang_dung_cu', 'ghi_chu', 'noi_quan_ly',
            'vi_tri'
        ];

        // T√™n hi·ªÉn th·ªã ti·∫øng Vi·ªát cho c√°c c·ªôt
        const DISPLAY_HEADERS = [
            'T√™n D·ª•ng C·ª•', 'Ch·ªßng Lo·∫°i', 'D·ª•ng C·ª• ƒêi·ªán T·ª≠', 'S·ªë Series',
            'Ng√†y Nh·∫≠n D·ª•ng C·ª•', 'T√¨nh Tr·∫°ng D·ª•ng C·ª•', 'Ghi Ch√∫', 'N∆°i Qu·∫£n L√Ω',
            'V·ªã Tr√≠'
        ];

        let currentData = null;
        let filteredData = null;
        let rowsPerPage = 10;
        let currentPage = 1;

        async function fetchAndExportData() {
            const statusDiv = document.getElementById('status');
            const exportBtn = document.getElementById('exportBtn');
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i loading
            statusDiv.innerHTML = '<div class="status loading">üîÑ ƒêang k·∫øt n·ªëi v·ªõi AppSheet API...</div>';
            exportBtn.disabled = true;

            try {
                // G·ªçi AppSheet API
                const response = await fetch(`https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/${TABLE_NAME}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': ACCESS_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "Action": "Find",
                        "Properties": {},
                        "Rows": []
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data || !Array.isArray(data)) {
                    throw new Error('D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá');
                }

                currentData = data;
                filteredData = data;
                
                // Hi·ªÉn th·ªã th√¥ng b√°o ng·∫Øn g·ªçn
                statusDiv.innerHTML = `<div class="status success">‚úÖ ƒê√£ t·∫£i ${data.length} b·∫£n ghi t·ª´ AppSheet</div>`;
                
                // Hi·ªÉn th·ªã search box
                document.getElementById('searchContainer').style.display = 'block';
                
                // Hi·ªÉn th·ªã preview d·ªØ li·ªáu
                showDataPreview(data);
                
                // T·ª± ƒë·ªông xu·∫•t Excel sau 800ms
                setTimeout(() => {
                    exportToExcel(data);
                    // X√≥a th√¥ng b√°o sau khi xu·∫•t xong
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 1500);
                }, 800);

            } catch (error) {
                console.error('L·ªói:', error);
                statusDiv.innerHTML = `<div class="status error">‚ùå L·ªói: ${error.message}</div>`;
            } finally {
                exportBtn.disabled = false;
            }
        }

        function showDataPreview(data) {
            const previewDiv = document.getElementById('dataPreview');
            
            if (data.length === 0) {
                previewDiv.innerHTML = '<div class="no-results">‚ùå Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</div>';
                return;
            }

            // Hi·ªÉn th·ªã ng√†y gi·ªù hi·ªán t·∫°i
            const currentDateTime = new Date('2025-07-28T12:49:00+07:00');
            const dateTimeStr = currentDateTime.toLocaleString('vi-VN', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: false 
            }).replace(', ', ' ');
            let tableHtml = `<p style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">C·∫≠p nh·∫≠t l√∫c: ${dateTimeStr}</p>`;

            // Th√™m ƒëi·ªÅu khi·ªÉn s·ªë d√≤ng v√† ph√¢n trang
            tableHtml += `
                <div class="pagination-controls">
                    <select class="rows-per-page" onchange="changeRowsPerPage(this.value)">
                        <option value="5" ${rowsPerPage === 5 ? 'selected' : ''}>5 d√≤ng</option>
                        <option value="10" ${rowsPerPage === 10 ? 'selected' : ''}>10 d√≤ng</option>
                        <option value="20" ${rowsPerPage === 20 ? 'selected' : ''}>20 d√≤ng</option>
                        <option value="50" ${rowsPerPage === 50 ? 'selected' : ''}>50 d√≤ng</option>
                    </select>
                    <button class="pagination-btn" onclick="previousPage()" ${currentPage === 1 ? 'disabled' : ''}>Tr∆∞·ªõc</button>
                    <span>Trang ${currentPage} / ${Math.ceil(data.length / rowsPerPage)}</span>
                    <button class="pagination-btn" onclick="nextPage()" ${currentPage === Math.ceil(data.length / rowsPerPage) ? 'disabled' : ''}>Ti·∫øp</button>
                </div>
            `;

            // T√≠nh to√°n d·ªØ li·ªáu hi·ªÉn th·ªã
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, data.length);
            const previewData = data.slice(startIndex, endIndex);
            
            tableHtml += '<div class="data-preview"><table><thead><tr>';
            DISPLAY_HEADERS.forEach(header => {
                tableHtml += `<th>${header}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                tableHtml += '<tr>';
                DISPLAY_FIELDS.forEach(field => {
                    const value = row[field] || '';
                    // Format ng√†y th√°ng cho c√°c c·ªôt ng√†y
                    let displayValue = String(value);
                    if (field.includes('ngay') && value) {
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                displayValue = date.toLocaleDateString('vi-VN');
                            }
                        } catch (e) {
                            // Gi·ªØ nguy√™n gi√° tr·ªã n·∫øu kh√¥ng parse ƒë∆∞·ª£c
                        }
                    }
                    // Conditional text color for T√¨nh Tr·∫°ng D·ª•ng C·ª•
                    let textStyle = '';
                    if (field === 'tinh_trang_dung_cu') {
                        if (displayValue.toLowerCase().includes('b√¨nh th∆∞·ªùng')) textStyle = 'color: green;';
                        else if (displayValue.toLowerCase().includes('ng - b√°o l·ªói')) textStyle = 'color: red;';
                    }
                    // Remove background class for T√¨nh Tr·∫°ng D·ª•ng C·ª• column
                    let statusClass = '';
                    if (field !== 'tinh_trang_dung_cu') {
                        if (field === 'tinh_trang_dung_cu' && displayValue.toLowerCase().includes('b√¨nh th∆∞·ªùng')) statusClass = 'status-good';
                        else if (field === 'tinh_trang_dung_cu' && displayValue.toLowerCase().includes('ng - b√°o l·ªói')) statusClass = 'status-bad';
                        else if (field === 'tinh_trang_dung_cu') statusClass = 'status-unknown';
                    }
                    tableHtml += `<td class="${statusClass}" style="${textStyle}">${displayValue.substring(0, 30)}${displayValue.length > 30 ? '...' : ''}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table></div>';
            tableHtml += `<p style="text-align: center; margin-top: 15px; color: #666; font-size: 16px;">Hi·ªÉn th·ªã ${previewData.length} / ${data.length} b·∫£n ghi (t·ª´ ${startIndex + 1} ƒë·∫øn ${endIndex})</p>`;
            
            previewDiv.innerHTML = tableHtml;
        }

        function changeRowsPerPage(value) {
            rowsPerPage = parseInt(value);
            currentPage = 1; // Reset to first page when changing rows per page
            if (filteredData) showDataPreview(filteredData);
            else if (currentData) showDataPreview(currentData);
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                if (filteredData) showDataPreview(filteredData);
                else if (currentData) showDataPreview(currentData);
            }
        }

        function nextPage() {
            const totalPages = Math.ceil((filteredData || currentData).length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                if (filteredData) showDataPreview(filteredData);
                else if (currentData) showDataPreview(currentData);
            }
        }

        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const searchInfo = document.getElementById('searchInfo');
            
            if (!currentData) {
                return;
            }
            
            if (searchTerm === '') {
                // Kh√¥ng c√≥ t·ª´ kh√≥a t√¨m ki·∫øm, hi·ªÉn th·ªã t·∫•t c·∫£
                filteredData = currentData;
                searchInfo.innerHTML = '';
            } else {
                // T√¨m ki·∫øm trong c√°c tr∆∞·ªùng hi·ªÉn th·ªã
                filteredData = currentData.filter(row => {
                    return DISPLAY_FIELDS.some(field => {
                        const value = String(row[field] || '').toLowerCase();
                        return value.includes(searchTerm);
                    });
                });
                
                // Hi·ªÉn th·ªã th√¥ng tin t√¨m ki·∫øm
                searchInfo.innerHTML = `T√¨m th·∫•y <strong>${filteredData.length}</strong> k·∫øt qu·∫£ cho "<strong>${searchTerm}</strong>"`;
            }
            
            currentPage = 1; // Reset to first page after search
            showDataPreview(filteredData);
        }

        function exportToExcel(data) {
            try {
                // T·∫°o workbook m·ªõi
                const wb = XLSX.utils.book_new();
                
                // T·∫°o header v·ªõi t√™n ti·∫øng Vi·ªát
                const headers = [
                    'T√™n D·ª•ng C·ª•', 'Ch·ªßng Lo·∫°i', 'D·ª•ng C·ª• ƒêi·ªán T·ª≠', 'S·ªë Series',
                    'Ng√†y Nh·∫≠n D·ª•ng C·ª•', 'T√¨nh Tr·∫°ng D·ª•ng C·ª•', 'Ghi Ch√∫', 'N∆°i Qu·∫£n L√Ω',
                    'V·ªã Tr√≠'
                ];
                
                // Chu·∫©n b·ªã d·ªØ li·ªáu cho worksheet
                const wsData = [];
                
                // D√≤ng 1: Ti√™u ƒë·ªÅ ch√≠nh (merge to√†n b·ªô)
                const mainTitle = ['DANH S√ÅCH QU·∫¢N L√ù D·ª§NG C·ª§ THI·∫æT B·ªä'];
                for (let i = 1; i < headers.length + 1; i++) {
                    mainTitle.push('');
                }
                wsData.push(mainTitle);
                
                // D√≤ng 2: Tr·ªëng ƒë·ªÉ t·∫°o kho·∫£ng c√°ch
                const emptyRow1 = new Array(headers.length + 1).fill('');
                wsData.push(emptyRow1);
                
                // D√≤ng 3: Th√¥ng tin c√¥ng ty/ƒë∆°n v·ªã
                const companyInfo = ['ƒê∆°n v·ªã: _______________________'];
                for (let i = 1; i < headers.length + 1; i++) {
                    companyInfo.push('');
                }
                wsData.push(companyInfo);
                
                // D√≤ng 4: Th√¥ng tin ng√†y th√°ng (c·∫≠p nh·∫≠t theo th·ªùi gian hi·ªán t·∫°i)
                const currentDateTime = new Date('2025-07-28T12:49:00+07:00');
                const dateTimeStr = currentDateTime.toLocaleString('vi-VN', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    hour12: false 
                }).replace(', ', ' ');
                const dateInfo = [`Ng√†y xu·∫•t b√°o c√°o: ${dateTimeStr}`];
                for (let i = 1; i < 4; i++) {
                    dateInfo.push('');
                }
                dateInfo.push(`T·ªïng s·ªë thi·∫øt b·ªã: ${data.length} (chi·∫øc)`);
                for (let i = 5; i < headers.length + 1; i++) {
                    dateInfo.push('');
                }
                wsData.push(dateInfo);
                
                // D√≤ng 5: Tr·ªëng
                const emptyRow2 = new Array(headers.length + 1).fill('');
                wsData.push(emptyRow2);
                
                // D√≤ng 6: Header v·ªõi STT
                const headerWithSTT = ['STT', ...headers];
                wsData.push(headerWithSTT);
                
                // Th√™m d·ªØ li·ªáu v·ªõi STT
                data.forEach((row, index) => {
                    const rowData = [index + 1]; // STT b·∫Øt ƒë·∫ßu t·ª´ 1
                    DISPLAY_FIELDS.forEach(field => {
                        let value = row[field] || '';
                        // Format ng√†y th√°ng theo ƒë·ªãnh d·∫°ng Vi·ªát Nam
                        if (field.includes('ngay') && value) {
                            try {
                                const date = new Date(value);
                                if (!isNaN(date.getTime())) {
                                    value = date.toLocaleDateString('vi-VN');
                                }
                            } catch (e) {
                                // Gi·ªØ nguy√™n gi√° tr·ªã n·∫øu kh√¥ng parse ƒë∆∞·ª£c
                            }
                        }
                        // Format s·ªë l∆∞·ª£ng
                        if ((field.includes('sl_') || field.includes('so_')) && value && !isNaN(value)) {
                            value = Number(value).toLocaleString('vi-VN');
                        }
                        rowData.push(value);
                    });
                    wsData.push(rowData);
                });
                
                // Th√™m d√≤ng t·ªïng k·∫øt ·ªü cu·ªëi
                const emptyRow3 = new Array(headerWithSTT.length).fill('');
                wsData.push(emptyRow3);
                
                const summaryRow = ['', 'T·ªîNG C·ªòNG:', '', '', '', '', '', '', '', `${data.length} thi·∫øt b·ªã`];
                wsData.push(summaryRow);
                
                // Th√™m ch·ªØ k√Ω
                const emptyRow4 = new Array(headerWithSTT.length).fill('');
                wsData.push(emptyRow4);
                wsData.push(emptyRow4);
                
                const signatureRow1 = ['', '', '', '', '', '', '', 'Ng∆∞·ªùi l·∫≠p bi·ªÉu', '', 'X√°c nh·∫≠n c·ªßa TBP'];
                wsData.push(signatureRow1);
                
                const emptyRow5 = new Array(headerWithSTT.length).fill('');
                wsData.push(emptyRow5);
                wsData.push(emptyRow5);
                wsData.push(emptyRow5);
                
                const signatureRow2 = ['', '', '', '', '', '', '', '(K√Ω ghi r√µ h·ªç t√™n)', '', '(K√Ω ghi r√µ h·ªç t√™n)'];
                wsData.push(signatureRow2);
                
                // T·∫°o worksheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // ƒê·ªãnh d·∫°ng ƒë·ªô r·ªông c·ªôt
                const colWidths = [
                    { wch: 6 },   // STT
                    { wch: 30 },  // T√™n D·ª•ng C·ª•
                    { wch: 18 },  // Ch·ªßng Lo·∫°i
                    { wch: 15 },  // D·ª•ng C·ª• ƒêi·ªán T·ª≠
                    { wch: 18 },  // S·ªë Series
                    { wch: 18 },  // Ng√†y Nh·∫≠n
                    { wch: 20 },  // T√¨nh Tr·∫°ng
                    { wch: 35 },  // Ghi Ch√∫
                    { wch: 20 },  // N∆°i Qu·∫£n L√Ω
                    { wch: 15 }   // V·ªã Tr√≠
                ];
                ws['!cols'] = colWidths;
                
                // ƒê·ªãnh d·∫°ng merge cells
                ws['!merges'] = [
                    // Merge ti√™u ƒë·ªÅ ch√≠nh (d√≤ng 1)
                    { s: { r: 0, c: 0 }, e: { r: 0, c: headerWithSTT.length - 1 } },
                    // Merge th√¥ng tin c√¥ng ty (d√≤ng 3)
                    { s: { r: 2, c: 0 }, e: { r: 2, c: 6 } },
                    // Merge ng√†y xu·∫•t (d√≤ng 4)
                    { s: { r: 3, c: 0 }, e: { r: 3, c: 3 } },
                    { s: { r: 3, c: 4 }, e: { r: 3, c: headerWithSTT.length - 1 } },
                    // Merge t·ªïng c·ªông
                    { s: { r: wsData.length - 8, c: 1 }, e: { r: wsData.length - 8, c: 8 } },
                    // Merge ch·ªØ k√Ω
                    { s: { r: wsData.length - 4, c: 7 }, e: { r: wsData.length - 4, c: 8 } },
                    { s: { r: wsData.length - 4, c: 9 }, e: { r: wsData.length - 4, c: 10 } },
                    { s: { r: wsData.length - 1, c: 7 }, e: { r: wsData.length - 1, c: 8 } },
                    { s: { r: wsData.length - 1, c: 9 }, e: { r: wsData.length - 1, c: 10 } }
                ];
                
                // √Åp d·ª•ng styles chi ti·∫øt
                const headerRowIndex = 5; // D√≤ng header th·ª±c t·∫ø (0-indexed)
                const dataStartRow = 6;
                const dataEndRow = dataStartRow + data.length - 1;
                const summaryRowIndex = wsData.length - 8;
                const totalColumns = headerWithSTT.length;
                const totalRows = wsData.length;

                // Border style definitions
                const mediumBorder = {
                    top: { style: "medium", color: { rgb: "000000" } },
                    bottom: { style: "medium", color: { rgb: "000000" } },
                    left: { style: "medium", color: { rgb: "000000" } },
                    right: { style: "medium", color: { rgb: "000000" } }
                };
                const thinBorder = {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                };

                // Apply borders and styles to all cells
                for (let row = 0; row < totalRows; row++) {
                    for (let col = 0; col < totalColumns; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!ws[cellAddress]) {
                            ws[cellAddress] = { t: 's', v: '' }; // Ensure empty cells exist for styling
                        }

                        // Initialize cell style
                        ws[cellAddress].s = ws[cellAddress].s || {};

                        // Apply outer medium borders for the entire table
                        let borderStyle = thinBorder;
                        if (row === 0 || row === totalRows - 1 || col === 0 || col === totalColumns - 1) {
                            borderStyle = mediumBorder;
                        }

                        // Apply styles based on row
                        if (row === 0) {
                            // Title row
                            ws[cellAddress].s = {
                                font: { bold: true, size: 18, color: { rgb: "FFFFFF" }, name: "Times New Roman" },
                                fill: { fgColor: { rgb: "1F4E79" } },
                                alignment: { horizontal: "center", vertical: "center" },
                                border: borderStyle
                            };
                        } else if (row === 2 || row === 3) {
                            // Company info and date row
                            ws[cellAddress].s = {
                                font: { bold: true, size: 12, name: "Times New Roman" },
                                alignment: { horizontal: "left", vertical: "center" },
                                border: borderStyle
                            };
                        } else if (row === 4) {
                            // Empty row between date and header
                            ws[cellAddress].s = {
                                border: borderStyle
                            };
                        } else if (row === headerRowIndex) {
                            // Header row
                            ws[cellAddress].s = {
                                font: { bold: true, size: 12, color: { rgb: "FFFFFF" }, name: "Times New Roman" },
                                fill: { fgColor: { rgb: "4472C4" } },
                                alignment: { horizontal: "center", vertical: "center", wrapText: true },
                                border: borderStyle
                            };
                        } else if (row >= dataStartRow && row <= dataEndRow) {
                            // Data rows
                            const isEvenRow = (row - dataStartRow) % 2 === 0;
                            ws[cellAddress].s = {
                                font: { size: 11, name: "Times New Roman" },
                                fill: { fgColor: { rgb: isEvenRow ? "F8F9FA" : "FFFFFF" } },
                                alignment: { 
                                    horizontal: col === 0 ? "center" : (col === 1 || col === 7 ? "left" : "center"),
                                    vertical: "center",
                                    wrapText: col === 7 // Wrap text cho c·ªôt ghi ch√∫
                                },
                                border: borderStyle
                            };
                        } else if (row === summaryRowIndex) {
                            // Summary row
                            ws[cellAddress].s = {
                                font: { bold: true, size: 12, name: "Times New Roman" },
                                fill: { fgColor: { rgb: "D9E2F3" } },
                                alignment: { horizontal: "center", vertical: "center" },
                                border: borderStyle
                            };
                        } else if (row >= wsData.length - 4 && row <= wsData.length - 1) {
                            // Signature rows
                            ws[cellAddress].s = {
                                font: { 
                                    bold: true, 
                                    size: 11, 
                                    name: "Times New Roman", 
                                    italic: row === wsData.length - 1 
                                },
                                alignment: { horizontal: "center", vertical: "center" },
                                border: borderStyle
                            };
                        } else {
                            // Empty rows
                            ws[cellAddress].s = {
                                border: borderStyle
                            };
                        }
                    }
                }

                // Thi·∫øt l·∫≠p chi·ªÅu cao d√≤ng
                ws['!rows'] = [];
                ws['!rows'][0] = { hpx: 30 }; // Ti√™u ƒë·ªÅ ch√≠nh
                ws['!rows'][headerRowIndex] = { hpx: 40 }; // Header
                
                // Th√™m worksheet v√†o workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Danh S√°ch D·ª•ng C·ª•');
                
                // T·∫°o t√™n file ƒë·∫πp h∆°n
                const now = new Date('2025-07-28T12:49:00+07:00');
                const dateStr = now.toLocaleDateString('vi-VN').replace(/\//g, '-');
                const timeStr = now.toLocaleTimeString('vi-VN', {hour12: false}).replace(/:/g, '-');
                const filename = `BaoCao_DungCu_${dateStr}_${timeStr}.xlsx`;
                
                // Xu·∫•t file
                XLSX.writeFile(wb, filename);
                
                // Log ƒë·ªÉ debug
                console.log(`ƒê√£ xu·∫•t file: ${filename} v·ªõi ${data.length} b·∫£n ghi`);
                
            } catch (error) {
                console.error('L·ªói xu·∫•t Excel:', error);
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `<div class="status error">‚ùå L·ªói xu·∫•t Excel: ${error.message}</div>`;
            }
        }

        function clearStatus() {
            document.getElementById('status').innerHTML = '';
            document.getElementById('dataPreview').innerHTML = '';
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInfo').innerHTML = '';
            currentData = null;
            filteredData = null;
            rowsPerPage = 10;
            currentPage = 1;
        }

        // Th√™m th√¥ng tin h∆∞·ªõng d·∫´n khi trang ƒë∆∞·ª£c t·∫£i
        window.onload = function() {
            console.log('AppSheet to Excel Exporter ƒë√£ s·∫µn s√†ng!');
        };
    </script>
</body>
</html>
