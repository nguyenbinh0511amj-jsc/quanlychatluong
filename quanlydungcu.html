<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o qu·∫£n l√Ω d·ª•ng c·ª•</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 50px;
            font-size: 2.8em;
            font-weight: 300;
        }
        
        .info-card {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .button-group {
            text-align: center;
            margin: 50px 0;
        }
        
        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            margin: 0 15px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,123,255,0.3);
            min-width: 200px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            margin-top: 30px;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .data-preview {
            margin-top: 30px;
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: #f8f9fa;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-preview th, .data-preview td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-preview th {
            background: #007bff;
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
        }
        
        .search-container {
            margin: 30px 0;
            text-align: center;
        }
        
        .search-box {
            width: 100%;
            max-width: 500px;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .search-box:focus {
            border-color: #007bff;
            box-shadow: 0 4px 20px rgba(0,123,255,0.2);
        }
        
        .search-info {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .highlight {
            background-color: #fff3cd;
            color: #856404;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .pagination-controls {
            margin: 20px 0;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
        }
        
        .rows-per-page {
            padding: 5px 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .pagination-btn {
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .pagination-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Xu·∫•t D·ªØ Li·ªáu D·ª•ng C·ª•</h1>
        
        <div class="button-group">
            <button onclick="fetchAndExportData()" id="exportBtn">
                üì• L·∫•y d·ªØ li·ªáu v√† xu·∫•t Excel
            </button>
            <button onclick="clearStatus()" id="clearBtn">
                üßπ X√≥a k·∫øt qu·∫£
            </button>
        </div>
        
        <div class="search-container" id="searchContainer" style="display: none;">
            <input type="text" 
                   class="search-box" 
                   id="searchInput" 
                   placeholder="üîç T√¨m ki·∫øm trong t·∫•t c·∫£ c√°c c·ªôt..." 
                   oninput="searchData()">
            <div class="search-info" id="searchInfo"></div>
        </div>
        
        <div id="status"></div>
        <div id="dataPreview"></div>
    </div>

    <script>
        // C·∫•u h√¨nh AppSheet API
        const APP_ID = 'bd6e1158-d412-4790-88fe-d8e2a46206cb';
        const ACCESS_KEY = 'V2-6wqzK-qw3K3-bMSkd-ikr4H-pz5SG-02Xzy-IumRs-6oMzl';
        const TABLE_NAME = 'dung_cu';
        
        // Danh s√°ch c√°c tr∆∞·ªùng c·∫ßn l·∫•y t·ª´ API
        const API_FIELDS = [
            'id', 'ten_dung_cu', 'chung_loai', 'dung_cu_dien_tu_co', 'so_series',
            'ngay_nhan_dung_cu', 'tinh_trang_dung_cu', 'ghi_chu', 'noi_quan_ly',
            'vi_tri', 'ngay_kiem_ke', 'trang_thai', 'sl_ok', 'sl_ng', 'update',
            'Code', 'ho_va_ten', 'hinh_anh_kiem_ke', 'ngay_huy', 'xac_nhan_dung_cu_loi',
            'Duy·ªát', 'id_lich_su_muon_tra'
        ];

        // Danh s√°ch c√°c tr∆∞·ªùng hi·ªÉn th·ªã tr√™n web v√† xu·∫•t Excel
        const DISPLAY_FIELDS = [
            'ten_dung_cu', 'chung_loai', 'dung_cu_dien_tu_co', 'so_series',
            'ngay_nhan_dung_cu', 'tinh_trang_dung_cu', 'ghi_chu', 'noi_quan_ly',
            'vi_tri', 'sl_ok', 'sl_ng'
        ];

        // T√™n hi·ªÉn th·ªã ti·∫øng Vi·ªát cho c√°c c·ªôt
        const DISPLAY_HEADERS = [
            'T√™n D·ª•ng C·ª•', 'Ch·ªßng Lo·∫°i', 'D·ª•ng C·ª• ƒêi·ªán T·ª≠', 'S·ªë Series',
            'Ng√†y Nh·∫≠n D·ª•ng C·ª•', 'T√¨nh Tr·∫°ng D·ª•ng C·ª•', 'Ghi Ch√∫', 'N∆°i Qu·∫£n L√Ω',
            'V·ªã Tr√≠', 'S·ªë L∆∞·ª£ng OK', 'S·ªë L∆∞·ª£ng NG'
        ];

        let currentData = null;
        let filteredData = null;
        let rowsPerPage = 10;
        let currentPage = 1;

        // H√†m s·∫Øp x·∫øp d·ªØ li·ªáu theo t√™n d·ª•ng c·ª•
        function sortDataByTenDungCu(data) {
            return data.sort((a, b) => {
                const nameA = (a.ten_dung_cu || '').toLowerCase().trim();
                const nameB = (b.ten_dung_cu || '').toLowerCase().trim();
                return nameA.localeCompare(nameB, 'vi', { numeric: true });
            });
        }

        async function fetchAndExportData() {
            const statusDiv = document.getElementById('status');
            const exportBtn = document.getElementById('exportBtn');
            
            statusDiv.innerHTML = '<div class="status loading">üîÑ ƒêang k·∫øt n·ªëi v·ªõi AppSheet API...</div>';
            exportBtn.disabled = true;

            try {
                const response = await fetch(`https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/${TABLE_NAME}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': ACCESS_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "Action": "Find",
                        "Properties": {},
                        "Rows": []
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data || !Array.isArray(data)) {
                    throw new Error('D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá');
                }

                const sortedData = sortDataByTenDungCu(data);
                currentData = sortedData;
                filteredData = sortedData;
                
                statusDiv.innerHTML = `<div class="status success">‚úÖ ƒê√£ t·∫£i ${sortedData.length} b·∫£n ghi t·ª´ AppSheet (ƒë√£ s·∫Øp x·∫øp theo t√™n)</div>`;
                document.getElementById('searchContainer').style.display = 'block';
                showDataPreview(sortedData);
                
                setTimeout(() => {
                    exportToExcel(sortedData);
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 1500);
                }, 800);

            } catch (error) {
                console.error('L·ªói:', error);
                statusDiv.innerHTML = `<div class="status error">‚ùå L·ªói: ${error.message}</div>`;
            } finally {
                exportBtn.disabled = false;
            }
        }

        function showDataPreview(data) {
            const previewDiv = document.getElementById('dataPreview');
            
            if (data.length === 0) {
                previewDiv.innerHTML = '<div class="no-results">‚ùå Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</div>';
                return;
            }

            const currentDateTime = new Date();
            const dateTimeStr = currentDateTime.toLocaleString('vi-VN', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: false 
            }).replace(', ', ' ');
            let tableHtml = `<p style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">C·∫≠p nh·∫≠t l√∫c: ${dateTimeStr} (ƒë√£ s·∫Øp x·∫øp theo t√™n d·ª•ng c·ª•)</p>`;

            tableHtml += `
                <div class="pagination-controls">
                    <select class="rows-per-page" onchange="changeRowsPerPage(this.value)">
                        <option value="5" ${rowsPerPage === 5 ? 'selected' : ''}>5 d√≤ng</option>
                        <option value="10" ${rowsPerPage === 10 ? 'selected' : ''}>10 d√≤ng</option>
                        <option value="20" ${rowsPerPage === 20 ? 'selected' : ''}>20 d√≤ng</option>
                        <option value="50" ${rowsPerPage === 50 ? 'selected' : ''}>50 d√≤ng</option>
                    </select>
                    <button class="pagination-btn" onclick="previousPage()" ${currentPage === 1 ? 'disabled' : ''}>Tr∆∞·ªõc</button>
                    <span>Trang ${currentPage} / ${Math.ceil(data.length / rowsPerPage)}</span>
                    <button class="pagination-btn" onclick="nextPage()" ${currentPage === Math.ceil(data.length / rowsPerPage) ? 'disabled' : ''}>Ti·∫øp</button>
                </div>
            `;

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, data.length);
            const previewData = data.slice(startIndex, endIndex);
            
            tableHtml += '<div class="data-preview"><table><thead><tr>';
            DISPLAY_HEADERS.forEach(header => {
                tableHtml += `<th>${header}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                tableHtml += '<tr>';
                DISPLAY_FIELDS.forEach(field => {
                    const value = row[field] || '';
                    let displayValue = String(value);
                    if (field.includes('ngay') && value) {
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                displayValue = date.toLocaleDateString('vi-VN');
                            }
                        } catch (e) {}
                    }
                    if ((field === 'sl_ok' || field === 'sl_ng') && value && !isNaN(value)) {
                        displayValue = Number(value).toLocaleString('vi-VN');
                    }
                    let textStyle = '';
                    if (field === 'tinh_trang_dung_cu') {
                        if (displayValue.toLowerCase().includes('b√¨nh th∆∞·ªùng')) textStyle = 'color: green;';
                        else if (displayValue.toLowerCase().includes('ng - b√°o l·ªói')) textStyle = 'color: red;';
                    }
                    tableHtml += `<td style="${textStyle}">${displayValue.substring(0, 30)}${displayValue.length > 30 ? '...' : ''}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table></div>';
            tableHtml += `<p style="text-align: center; margin-top: 15px; color: #666; font-size: 16px;">Hi·ªÉn th·ªã ${previewData.length} / ${data.length} b·∫£n ghi (t·ª´ ${startIndex + 1} ƒë·∫øn ${endIndex})</p>`;
            
            previewDiv.innerHTML = tableHtml;
        }

        function changeRowsPerPage(value) {
            rowsPerPage = parseInt(value);
            currentPage = 1;
            if (filteredData) showDataPreview(filteredData);
            else if (currentData) showDataPreview(currentData);
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                if (filteredData) showDataPreview(filteredData);
                else if (currentData) showDataPreview(currentData);
            }
        }

        function nextPage() {
            const totalPages = Math.ceil((filteredData || currentData).length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                if (filteredData) showDataPreview(filteredData);
                else if (currentData) showDataPreview(currentData);
            }
        }

        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const searchInfo = document.getElementById('searchInfo');
            
            if (!currentData) return;
            
            if (searchTerm === '') {
                filteredData = currentData;
                searchInfo.innerHTML = '';
            } else {
                filteredData = currentData.filter(row => {
                    return DISPLAY_FIELDS.some(field => {
                        const value = String(row[field] || '').toLowerCase();
                        return value.includes(searchTerm);
                    });
                });
                filteredData = sortDataByTenDungCu(filteredData);
                searchInfo.innerHTML = `T√¨m th·∫•y <strong>${filteredData.length}</strong> k·∫øt qu·∫£ cho "<strong>${searchTerm}</strong>" (ƒë√£ s·∫Øp x·∫øp theo t√™n)`;
            }
            
            currentPage = 1;
            showDataPreview(filteredData);
        }

        function exportToExcel(data) {
            try {
                const wb = XLSX.utils.book_new();
                
                const headers = [
                    'T√™n D·ª•ng C·ª•', 'Ch·ªßng Lo·∫°i', 'D·ª•ng C·ª• ƒêi·ªán T·ª≠', 'S·ªë Series',
                    'Ng√†y Nh·∫≠n D·ª•ng C·ª•', 'T√¨nh Tr·∫°ng D·ª•ng C·ª•', 'Ghi Ch√∫', 'N∆°i Qu·∫£n L√Ω',
                    'V·ªã Tr√≠', 'S·ªë L∆∞·ª£ng OK', 'S·ªë L∆∞·ª£ng NG'
                ];
                
                // Worksheet "Danh S√°ch D·ª•ng C·ª•"
                const wsDataAll = [];
                const currentDateTime = new Date();
                const dateTimeStr = currentDateTime.toLocaleString('vi-VN', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    hour12: false 
                }).replace(', ', ' ');
                
                const mainTitleAll = ['DANH S√ÅCH QU·∫¢N L√ù D·ª§NG C·ª§ THI·∫æT B·ªä (S·∫Øp x·∫øp theo t√™n d·ª•ng c·ª•)'];
                for (let i = 1; i < headers.length + 1; i++) mainTitleAll.push('');
                wsDataAll.push(mainTitleAll);
                
                const emptyRow1All = new Array(headers.length + 1).fill('');
                wsDataAll.push(emptyRow1All);
                
                const companyInfoAll = ['ƒê∆°n v·ªã: _______________________'];
                for (let i = 1; i < headers.length + 1; i++) companyInfoAll.push('');
                wsDataAll.push(companyInfoAll);
                
                const dateInfoAll = [`Ng√†y xu·∫•t b√°o c√°o: ${dateTimeStr}`];
                for (let i = 1; i < 4; i++) dateInfoAll.push('');
                dateInfoAll.push(`T·ªïng s·ªë thi·∫øt b·ªã: ${data.length} (chi·∫øc)`);
                for (let i = 5; i < headers.length + 1; i++) dateInfoAll.push('');
                wsDataAll.push(dateInfoAll);
                
                const emptyRow2All = new Array(headers.length + 1).fill('');
                wsDataAll.push(emptyRow2All);
                
                const headerWithSTTAll = ['STT', ...headers];
                wsDataAll.push(headerWithSTTAll);
                
                data.forEach((row, index) => {
                    const rowData = [index + 1];
                    DISPLAY_FIELDS.forEach(field => {
                        let value = row[field] || '';
                        if (field.includes('ngay') && value) {
                            try {
                                const date = new Date(value);
                                if (!isNaN(date.getTime())) {
                                    value = date.toLocaleDateString('vi-VN');
                                }
                            } catch (e) {}
                        }
                        if ((field === 'sl_ok' || field === 'sl_ng') && value && !isNaN(value)) {
                            value = Number(value).toLocaleString('vi-VN');
                        }
                        rowData.push(value);
                    });
                    wsDataAll.push(rowData);
                });
                
                const emptyRow3All = new Array(headerWithSTTAll.length).fill('');
                wsDataAll.push(emptyRow3All);
                const summaryRowAll = ['', 'T·ªîNG C·ªòNG:', '', '', '', '', '', '', '', '', `${data.length} thi·∫øt b·ªã`];
                wsDataAll.push(summaryRowAll);
                
                const emptyRow4All = new Array(headerWithSTTAll.length).fill('');
                wsDataAll.push(emptyRow4All);
                wsDataAll.push(emptyRow4All);
                const signatureRow1All = ['', '', '', '', '', '', '', '', 'Ng∆∞·ªùi l·∫≠p bi·ªÉu', '', 'X√°c nh·∫≠n c·ªßa TBP'];
                wsDataAll.push(signatureRow1All);
                const emptyRow5All = new Array(headerWithSTTAll.length).fill('');
                wsDataAll.push(emptyRow5All);
                wsDataAll.push(emptyRow5All);
                wsDataAll.push(emptyRow5All);
                const signatureRow2All = ['', '', '', '', '', '', '', '', '(K√Ω v√† ghi r√µ h·ªç t√™n)', '', '(K√Ω v√† ghi r√µ h·ªç t√™n)'];
                wsDataAll.push(signatureRow2All);
                
                const wsAll = XLSX.utils.aoa_to_sheet(wsDataAll);
                const colWidthsAll = [
                    { wch: 6 }, { wch: 30 }, { wch: 18 }, { wch: 15 }, { wch: 18 },
                    { wch: 18 }, { wch: 20 }, { wch: 35 }, { wch: 20 }, { wch: 15 }, { wch: 15 }
                ];
                wsAll['!cols'] = colWidthsAll;
                wsAll['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: headerWithSTTAll.length - 1 } },
                    { s: { r: 2, c: 0 }, e: { r: 2, c: 6 } },
                    { s: { r: 3, c: 0 }, e: { r: 3, c: 3 } },
                    { s: { r: 3, c: 4 }, e: { r: 3, c: headerWithSTTAll.length - 1 } },
                    { s: { r: wsDataAll.length - 8, c: 1 }, e: { r: wsDataAll.length - 8, c: 9 } },
                    { s: { r: wsDataAll.length - 4, c: 8 }, e: { r: wsDataAll.length - 4, c: 9 } },
                    { s: { r: wsDataAll.length - 4, c: 10 }, e: { r: wsDataAll.length - 4, c: 11 } },
                    { s: { r: wsDataAll.length - 1, c: 8 }, e: { r: wsDataAll.length - 1, c: 9 } },
                    { s: { r: wsDataAll.length - 1, c: 10 }, e: { r: wsDataAll.length - 1, c: 11 } }
                ];
                const headerRowIndexAll = 5;
                const dataStartRowAll = 6;
                const dataEndRowAll = dataStartRowAll + data.length - 1;
                const summaryRowIndexAll = wsDataAll.length - 8;
                const totalColumnsAll = headerWithSTTAll.length;
                const totalRowsAll = wsDataAll.length;
                for (let row = 0; row < totalRowsAll; row++) {
                    for (let col = 0; col < totalColumnsAll; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!wsAll[cellAddress]) wsAll[cellAddress] = { t: 's', v: '' };
                        wsAll[cellAddress].s = wsAll[cellAddress].s || {};
                        let borderStyle = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
                        if (row === 0 || row === totalRowsAll - 1 || col === 0 || col === totalColumnsAll - 1) {
                            borderStyle = { top: { style: "medium" }, bottom: { style: "medium" }, left: { style: "medium" }, right: { style: "medium" } };
                        }
                        if (row === 0) {
                            wsAll[cellAddress].s = { font: { bold: true, size: 18, color: { rgb: "FFFFFF" }, name: "Times New Roman" }, fill: { fgColor: { rgb: "1F4E79" } }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
                        } else if (row === 2 || row === 3) {
                            wsAll[cellAddress].s = { font: { bold: true, size: 12, name: "Times New Roman" }, alignment: { horizontal: "left", vertical: "center" }, border: borderStyle };
                        } else if (row === 4) {
                            wsAll[cellAddress].s = { border: borderStyle };
                        } else if (row === headerRowIndexAll) {
                            wsAll[cellAddress].s = { font: { bold: true, size: 12, color: { rgb: "FFFFFF" }, name: "Times New Roman" }, fill: { fgColor: { rgb: "4472C4" } }, alignment: { horizontal: "center", vertical: "center", wrapText: true }, border: borderStyle };
                        } else if (row >= dataStartRowAll && row <= dataEndRowAll) {
                            const isEvenRow = (row - dataStartRowAll) % 2 === 0;
                            wsAll[cellAddress].s = { font: { size: 11, name: "Times New Roman" }, fill: { fgColor: { rgb: isEvenRow ? "F8F9FA" : "FFFFFF" } }, alignment: { horizontal: col === 0 ? "center" : (col === 1 || col === 7 ? "left" : "center"), vertical: "center", wrapText: col === 7 }, border: borderStyle };
                        } else if (row === summaryRowIndexAll) {
                            wsAll[cellAddress].s = { font: { bold: true, size: 12, name: "Times New Roman" }, fill: { fgColor: { rgb: "D9E2F3" } }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
                        } else if (row >= wsDataAll.length - 4 && row <= wsDataAll.length - 1) {
                            wsAll[cellAddress].s = { font: { bold: true, size: 11, name: "Times New Roman", italic: row === wsDataAll.length - 1 }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
                        } else {
                            wsAll[cellAddress].s = { border: borderStyle };
                        }
                    }
                }
                wsAll['!rows'] = [];
                wsAll['!rows'][0] = { hpx: 30 };
                wsAll['!rows'][headerRowIndexAll] = { hpx: 40 };
                XLSX.utils.book_append_sheet(wb, wsAll, 'Danh S√°ch D·ª•ng C·ª•');

                // Worksheet "Danh S√°ch D·ª•ng C·ª• Hu·ª∑"
                const filteredDataCancelled = data.filter(row => String(row['tinh_trang_dung_cu'] || '').toLowerCase().includes('ng - b√°o l·ªói'));
                const sortedDataCancelled = sortDataByTenDungCu(filteredDataCancelled);
                const wsDataCancelled = [];
                
                const mainTitleCancelled = ['DANH S√ÅCH D·ª§NG C·ª§ HU·ª∂ (S·∫Øp x·∫øp theo t√™n d·ª•ng c·ª•)'];
                for (let i = 1; i < headers.length + 1; i++) mainTitleCancelled.push('');
                wsDataCancelled.push(mainTitleCancelled);
                
                const emptyRow1Cancelled = new Array(headers.length + 1).fill('');
                wsDataCancelled.push(emptyRow1Cancelled);
                
                const companyInfoCancelled = ['ƒê∆°n v·ªã: _______________________'];
                for (let i = 1; i < headers.length + 1; i++) companyInfoCancelled.push('');
                wsDataCancelled.push(companyInfoCancelled);
                
                const dateInfoCancelled = [`Ng√†y xu·∫•t b√°o c√°o: ${dateTimeStr}`];
                for (let i = 1; i < 4; i++) dateInfoCancelled.push('');
                dateInfoCancelled.push(`T·ªïng s·ªë thi·∫øt b·ªã l·ªói: ${sortedDataCancelled.length} (chi·∫øc)`);
                for (let i = 5; i < headers.length + 1; i++) dateInfoCancelled.push('');
                wsDataCancelled.push(dateInfoCancelled);
                
                const emptyRow2Cancelled = new Array(headers.length + 1).fill('');
                wsDataCancelled.push(emptyRow2Cancelled);
                
                const headerWithSTTCancelled = ['STT', ...headers];
                wsDataCancelled.push(headerWithSTTCancelled);
                
                sortedDataCancelled.forEach((row, index) => {
                    const rowData = [index + 1];
                    DISPLAY_FIELDS.forEach(field => {
                        let value = row[field] || '';
                        if (field.includes('ngay') && value) {
                            try {
                                const date = new Date(value);
                                if (!isNaN(date.getTime())) {
                                    value = date.toLocaleDateString('vi-VN');
                                }
                            } catch (e) {}
                        }
                        if ((field === 'sl_ok' || field === 'sl_ng') && value && !isNaN(value)) {
                            value = Number(value).toLocaleString('vi-VN');
                        }
                        rowData.push(value);
                    });
                    wsDataCancelled.push(rowData);
                });
                
                const emptyRow3Cancelled = new Array(headerWithSTTCancelled.length).fill('');
                wsDataCancelled.push(emptyRow3Cancelled);
                const summaryRowCancelled = ['', 'T·ªîNG C·ªòNG:', '', '', '', '', '', '', '', '', `${sortedDataCancelled.length} thi·∫øt b·ªã`];
                wsDataCancelled.push(summaryRowCancelled);
                
                const emptyRow4Cancelled = new Array(headerWithSTTCancelled.length).fill('');
                wsDataCancelled.push(emptyRow4Cancelled);
                wsDataCancelled.push(emptyRow4Cancelled);
                const signatureRow1Cancelled = ['', '', '', '', '', '', '', '', 'Ng∆∞·ªùi l·∫≠p bi·ªÉu', '', 'X√°c nh·∫≠n c·ªßa TBP'];
                wsDataCancelled.push(signatureRow1Cancelled);
                const emptyRow5Cancelled = new Array(headerWithSTTCancelled.length).fill('');
                wsDataCancelled.push(emptyRow5Cancelled);
                wsDataCancelled.push(emptyRow5Cancelled);
                wsDataCancelled.push(emptyRow5Cancelled);
                const signatureRow2Cancelled = ['', '', '', '', '', '', '', '', '(K√Ω v√† ghi r√µ h·ªç t√™n)', '', '(K√Ω v√† ghi r√µ h·ªç t√™n)'];
                wsDataCancelled.push(signatureRow2Cancelled);
                
                const wsCancelled = XLSX.utils.aoa_to_sheet(wsDataCancelled);
                const colWidthsCancelled = [
                    { wch: 6 }, { wch: 30 }, { wch: 18 }, { wch: 15 }, { wch: 18 },
                    { wch: 18 }, { wch: 20 }, { wch: 35 }, { wch: 20 }, { wch: 15 }, { wch: 15 }
                ];
                wsCancelled['!cols'] = colWidthsCancelled;
                wsCancelled['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: headerWithSTTCancelled.length - 1 } },
                    { s: { r: 2, c: 0 }, e: { r: 2, c: 6 } },
                    { s: { r: 3, c: 0 }, e: { r: 3, c: 3 } },
                    { s: { r: 3, c: 4 }, e: { r: 3, c: headerWithSTTCancelled.length - 1 } },
                    { s: { r: wsDataCancelled.length - 8, c: 1 }, e: { r: wsDataCancelled.length - 8, c: 9 } },
                    { s: { r: wsDataCancelled.length - 4, c: 8 }, e: { r: wsDataCancelled.length - 4, c: 9 } },
                    { s: { r: wsDataCancelled.length - 4, c: 10 }, e: { r: wsDataCancelled.length - 4, c: 11 } },
                    { s: { r: wsDataCancelled.length - 1, c: 8 }, e: { r: wsDataCancelled.length - 1, c: 9 } },
                    { s: { r: wsDataCancelled.length - 1, c: 10 }, e: { r: wsDataCancelled.length - 1, c: 11 } }
                ];
                const headerRowIndexCancelled = 5;
                const dataStartRowCancelled = 6;
                const dataEndRowCancelled = dataStartRowCancelled + sortedDataCancelled.length - 1;
                const summaryRowIndexCancelled = wsDataCancelled.length - 8;
                const totalColumnsCancelled = headerWithSTTCancelled.length;
                const totalRowsCancelled = wsDataCancelled.length;
                for (let row = 0; row < totalRowsCancelled; row++) {
                    for (let col = 0; col < totalColumnsCancelled; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!wsCancelled[cellAddress]) wsCancelled[cellAddress] = { t: 's', v: '' };
                        wsCancelled[cellAddress].s = wsCancelled[cellAddress].s || {};
                        let borderStyle = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
                        if (row === 0 || row === totalRowsCancelled - 1 || col === 0 || col === totalColumnsCancelled - 1) {
                            borderStyle = { top: { style: "medium" }, bottom: { style: "medium" }, left: { style: "medium" }, right: { style: "medium" } };
                        }
                        if (row === 0) {
                            wsCancelled[cellAddress].s = { font: { bold: true, size: 18, color: { rgb: "FFFFFF" }, name: "Times New Roman" }, fill: { fgColor: { rgb: "C44E52" } }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
                        } else if (row === 2 || row === 3) {
                            wsCancelled[cellAddress].s = { font: { bold: true, size: 12, name: "Times New Roman" }, alignment: { horizontal: "left", vertical: "center" }, border: borderStyle };
                        } else if (row === 4) {
                            wsCancelled[cellAddress].s = { border: borderStyle };
                        } else if (row === headerRowIndexCancelled) {
                            wsCancelled[cellAddress].s = { font: { bold: true, size: 12, color: { rgb: "FFFFFF" }, name: "Times New Roman" }, fill: { fgColor: { rgb: "4472C4" } }, alignment: { horizontal: "center", vertical: "center", wrapText: true }, border: borderStyle };
                        } else if (row >= dataStartRowCancelled && row <= dataEndRowCancelled) {
                            const isEvenRow = (row - dataStartRowCancelled) % 2 === 0;
                            wsCancelled[cellAddress].s = { font: { size: 11, name: "Times New Roman" }, fill: { fgColor: { rgb: isEvenRow ? "F8F9FA" : "FFFFFF" } }, alignment: { horizontal: col === 0 ? "center" : (col === 1 || col === 7 ? "left" : "center"), vertical: "center", wrapText: col === 7 }, border: borderStyle };
                        } else if (row === summaryRowIndexCancelled) {
                            wsCancelled[cellAddress].s = { font: { bold: true, size: 12, name: "Times New Roman" }, fill: { fgColor: { rgb: "D9E2F3" } }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
                        } else if (row >= wsDataCancelled.length - 4 && row <= wsDataCancelled.length - 1) {
                            wsCancelled[cellAddress].s = { font: { bold: true, size: 11, name: "Times New Roman", italic: row === wsDataCancelled.length - 1 }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
                        } else {
                            wsCancelled[cellAddress].s = { border: borderStyle };
                        }
                    }
                }
                wsCancelled['!rows'] = [];
                wsCancelled['!rows'][0] = { hpx: 30 };
                wsCancelled['!rows'][headerRowIndexCancelled] = { hpx: 40 };
                XLSX.utils.book_append_sheet(wb, wsCancelled, 'Danh S√°ch D·ª•ng C·ª• Hu·ª∑');

                // Worksheet "Danh S√°ch D·ª•ng C·ª• B√¨nh Th∆∞·ªùng"
                const filteredDataNormal = data.filter(row => !String(row['tinh_trang_dung_cu'] || '').toLowerCase().includes('ng - b√°o l·ªói'));
                const sortedDataNormal = sortDataByTenDungCu(filteredDataNormal);
                const wsDataNormal = [];
                
                const mainTitleNormal = ['DANH S√ÅCH D·ª§NG C·ª§ B√åNH TH∆Ø·ªúNG (S·∫Øp x·∫øp theo t√™n d·ª•ng c·ª•)'];
                for (let i = 1; i < headers.length + 1; i++) mainTitleNormal.push('');
                wsDataNormal.push(mainTitleNormal);
                
                const emptyRow1Normal = new Array(headers.length + 1).fill('');
                wsDataNormal.push(emptyRow1Normal);
                
                const companyInfoNormal = ['ƒê∆°n v·ªã: _______________________'];
                for (let i = 1; i < headers.length + 1; i++) companyInfoNormal.push('');
                wsDataNormal.push(companyInfoNormal);
                
                const dateInfoNormal = [`Ng√†y xu·∫•t b√°o c√°o: ${dateTimeStr}`];
                for (let i = 1; i < 4; i++) dateInfoNormal.push('');
                dateInfoNormal.push(`T·ªïng s·ªë thi·∫øt b·ªã b√¨nh th∆∞·ªùng: ${sortedDataNormal.length} (chi·∫øc)`);
                for (let i = 5; i < headers.length + 1; i++) dateInfoNormal.push('');
                wsDataNormal.push(dateInfoNormal);
                
                const emptyRow2Normal = new Array(headers.length + 1).fill('');
                wsDataNormal.push(emptyRow2Normal);
                
                const headerWithSTTNormal = ['STT', ...headers];
                wsDataNormal.push(headerWithSTTNormal);
                
                sortedDataNormal.forEach((row, index) => {
                    const rowData = [index + 1];
                    DISPLAY_FIELDS.forEach(field => {
                        let value = row[field] || '';
                        if (field.includes('ngay') && value) {
                            try {
                                const date = new Date(value);
                                if (!isNaN(date.getTime())) {
                                    value = date.toLocaleDateString('vi-VN');
                                }
                            } catch (e) {}
                        }
                        if ((field === 'sl_ok' || field === 'sl_ng') && value && !isNaN(value)) {
                            value = Number(value).toLocaleString('vi-VN');
                        }
                        rowData.push(value);
                    });
                    wsDataNormal.push(rowData);
                });
                
                const emptyRow3Normal = new Array(headerWithSTTNormal.length).fill('');
                wsDataNormal.push(emptyRow3Normal);
                const summaryRowNormal = ['', 'T·ªîNG C·ªòNG:', '', '', '', '', '', '', '', '', `${sortedDataNormal.length} thi·∫øt b·ªã`];
                wsDataNormal.push(summaryRowNormal);
                
                const emptyRow4Normal = new Array(headerWithSTTNormal.length).fill('');
                wsDataNormal.push(emptyRow4Normal);
                wsDataNormal.push(emptyRow4Normal);
                const signatureRow1Normal = ['', '', '', '', '', '', '', '', 'Ng∆∞·ªùi l·∫≠p bi·ªÉu', '', 'X√°c nh·∫≠n c·ªßa TBP'];
                wsDataNormal.push(signatureRow1Normal);
                const emptyRow5Normal = new Array(headerWithSTTNormal.length).fill('');
                wsDataNormal.push(emptyRow5Normal);
                wsDataNormal.push(emptyRow5Normal);
                wsDataNormal.push(emptyRow5Normal);
                const signatureRow2Normal = ['', '', '', '', '', '', '', '', '(K√Ω v√† ghi r√µ h·ªç t√™n)', '', '(K√Ω v√† ghi r√µ h·ªç t√™n)'];
                wsDataNormal.push(signatureRow2Normal);
                
                const wsNormal = XLSX.utils.aoa_to_sheet(wsDataNormal);
                const colWidthsNormal = [
                    { wch: 6 }, { wch: 30 }, { wch: 18 }, { wch: 15 }, { wch: 18 },
                    { wch: 18 }, { wch: 20 }, { wch: 35 }, { wch: 20 }, { wch: 15 }, { wch: 15 }
                ];
                wsNormal['!cols'] = colWidthsNormal;
                wsNormal['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: headerWithSTTNormal.length - 1 } },
                    { s: { r: 2, c: 0 }, e: { r: 2, c: 6 } },
                    { s: { r: 3, c: 0 }, e: { r: 3, c: 3 } },
                    { s: { r: 3, c: 4 }, e: { r: 3, c: headerWithSTTNormal.length - 1 } },
                    { s: { r: wsDataNormal.length - 8, c: 1 }, e: { r: wsDataNormal.length - 8, c: 9 } },
                    { s: { r: wsDataNormal.length - 4, c: 8 }, e: { r: wsDataNormal.length - 4, c: 9 } },
                    { s: { r: wsDataNormal.length - 4, c: 10 }, e: { r: wsDataNormal.length - 4, c: 11 } },
                    { s: { r: wsDataNormal.length - 1, c: 8 }, e: { r: wsDataNormal.length - 1, c: 9 } },
                    { s: { r: wsDataNormal.length - 1, c: 10 }, e: { r: wsDataNormal.length - 1, c: 11 } }
                ];
                const headerRowIndexNormal = 5;
                const dataStartRowNormal = 6;
                const dataEndRowNormal = dataStartRowNormal + sortedDataNormal.length - 1;
                const summaryRowIndexNormal = wsDataNormal.length - 8;
                const totalColumnsNormal = headerWithSTTNormal.length;
                const totalRowsNormal = wsDataNormal.length;
                for (let row = 0; row < totalRowsNormal; row++) {
                    for (let col = 0; col < totalColumnsNormal; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!wsNormal[cellAddress]) wsNormal[cellAddress] = { t: 's', v: '' };
                        wsNormal[cellAddress].s = wsNormal[cellAddress].s || {};
                        let borderStyle = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
                        if (row === 0 || row === totalRowsNormal - 1 || col == 0 || col === totalColumnsNormal - 1) {
                            borderStyle = { top: { style: "medium" }, bottom: { style: "medium" }, left: { style: "medium" }, right: { style: "medium" } };
                        }
                        if (row === 0) {
                            wsNormal[cellAddress].s = { font: { bold: true, size: 18, color: { rgb: "FFFFFF" }, name: "Times New Roman" }, fill: { fgColor: { rgb: "4CAF50" } }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
                        } else if (row === 2 || row === 3) {
                            wsNormal[cellAddress].s = { font: { bold: true, size: 12, name: "Times New Roman" }, alignment: { horizontal: "left", vertical: "center" }, border: borderStyle };
                        } else if (row === 4) {
                            wsNormal[cellAddress].s = { border: borderStyle };
                        } else if (row === headerRowIndexNormal) {
                            wsNormal[cellAddress].s = { font: { bold: true, size: 12, color: { rgb: "FFFFFF" }, name: "Times New Roman" }, fill: { fgColor: { rgb: "4472C4" } }, alignment: { horizontal: "center", vertical: "center", wrapText: true }, border: borderStyle };
                        } else if (row >= dataStartRowNormal && row <= dataEndRowNormal) {
                            const isEvenRow = (row - dataStartRowNormal) % 2 === 0;
                            wsNormal[cellAddress].s = { font: { size: 11, name: "Times New Roman" }, fill: { fgColor: { rgb: isEvenRow ? "F8F9FA" : "FFFFFF" } }, alignment: { horizontal: col === 0 ? "center" : (col === 1 || col === 7 ? "left" : "center"), vertical: "center", wrapText: col === 7 }, border: borderStyle };
                        } else if (row === summaryRowIndexNormal) {
                            wsNormal[cellAddress].s = { font: { bold: true, size: 12, name: "Times New Roman" }, fill: { fgColor: { rgb: "D9E2F3" } }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
                        } else if (row >= wsDataNormal.length - 4 && row <= wsDataNormal.length - 1) {
                            wsNormal[cellAddress].s = { font: { bold: true, size: 11, name: "Times New Roman", italic: row === wsDataNormal.length - 1 }, alignment: { horizontal: "center", vertical: "center" }, border: borderStyle };
                        } else {
                            wsNormal[cellAddress].s = { border: borderStyle };
                        }
                    }
                }
                wsNormal['!rows'] = [];
                wsNormal['!rows'][0] = { hpx: 30 };
                wsNormal['!rows'][headerRowIndexNormal] = { hpx: 40 };
                XLSX.utils.book_append_sheet(wb, wsNormal, 'Danh S√°ch D·ª•ng C·ª• B√¨nh Th∆∞·ªùng');

                const now = new Date();
                const dateStr = now.toLocaleDateString('vi-VN').replace(/\//g, '-');
                const timeStr = now.toLocaleTimeString('vi-VN', {hour12: false}).replace(/:/g, '-');
                const filename = `BaoCao_DungCu_${dateStr}_${timeStr}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                console.log(`ƒê√£ xu·∫•t file: ${filename} v·ªõi ${data.length} b·∫£n ghi (bao g·ªìm ${sortedDataCancelled.length} b·∫£n ghi l·ªói v√† ${sortedDataNormal.length} b·∫£n ghi b√¨nh th∆∞·ªùng) - T·∫•t c·∫£ ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp theo t√™n d·ª•ng c·ª•`);
                
            } catch (error) {
                console.error('L·ªói xu·∫•t Excel:', error);
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `<div class="status error">‚ùå L·ªói xu·∫•t Excel: ${error.message}</div>`;
            }
        }

        function clearStatus() {
            document.getElementById('status').innerHTML = '';
            document.getElementById('dataPreview').innerHTML = '';
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInfo').innerHTML = '';
            currentData = null;
            filteredData = null;
            rowsPerPage = 10;
            currentPage = 1;
        }

        window.onload = function() {
            console.log('AppSheet to Excel Exporter ƒë√£ s·∫µn s√†ng! (C√≥ t√≠nh nƒÉng s·∫Øp x·∫øp theo t√™n d·ª•ng c·ª• v√† b·ªï sung c·ªôt S·ªë L∆∞·ª£ng OK, S·ªë L∆∞·ª£ng NG)');
        };
    </script>
</body>
</html>
