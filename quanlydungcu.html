<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xu·∫•t d·ªØ li·ªáu AppSheet ra Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 50px;
            font-size: 2.8em;
            font-weight: 300;
        }
        
        .info-card {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .button-group {
            text-align: center;
            margin: 50px 0;
        }
        
        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            margin: 0 15px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,123,255,0.3);
            min-width: 200px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            margin-top: 30px;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .data-preview {
            margin-top: 30px;
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: #f8f9fa;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-preview th, .data-preview td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-preview th {
            background: #007bff;
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
        }
        
        .field-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .field-item {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Xu·∫•t D·ªØ Li·ªáu D·ª•ng C·ª•</h1>
        

        
        <div class="button-group">
            <button onclick="fetchAndExportData()" id="exportBtn">
                üì• L·∫•y d·ªØ li·ªáu v√† xu·∫•t Excel
            </button>
            <button onclick="clearStatus()" id="clearBtn">
                üßπ X√≥a k·∫øt qu·∫£
            </button>
        </div>
        
        <div id="status"></div>
        <div id="dataPreview"></div>
    </div>

    <script>
        // C·∫•u h√¨nh AppSheet API
        const APP_ID = 'bd6e1158-d412-4790-88fe-d8e2a46206cb';
        const ACCESS_KEY = 'V2-6wqzK-qw3K3-bMSkd-ikr4H-pz5SG-02Xzy-IumRs-6oMzl';
        const TABLE_NAME = 'dung_cu';
        
        // Danh s√°ch c√°c tr∆∞·ªùng c·∫ßn xu·∫•t
        const FIELDS = [
            'id', 'ten_dung_cu', 'chung_loai', 'dung_cu_dien_tu_co', 'so_series',
            'ngay_nhan_dung_cu', 'tinh_trang_dung_cu', 'ghi_chu', 'noi_quan_ly',
            'vi_tri', 'ngay_kiem_ke', 'trang_thai', 'sl_ok', 'sl_ng', 'update',
            'Code', 'ho_va_ten', 'hinh_anh_kiem_ke', 'ngay_huy', 'xac_nhan_dung_cu_loi',
            'Duy·ªát', 'id_lich_su_muon_tra'
        ];

        let currentData = null;

        async function fetchAndExportData() {
            const statusDiv = document.getElementById('status');
            const exportBtn = document.getElementById('exportBtn');
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i loading
            statusDiv.innerHTML = '<div class="status loading">üîÑ ƒêang k·∫øt n·ªëi v·ªõi AppSheet API...</div>';
            exportBtn.disabled = true;

            try {
                // G·ªçi AppSheet API
                const response = await fetch(`https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/${TABLE_NAME}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': ACCESS_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "Action": "Find",
                        "Properties": {},
                        "Rows": []
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data || !Array.isArray(data)) {
                    throw new Error('D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá');
                }

                currentData = data;
                
                // Ch·ªâ hi·ªÉn th·ªã th√¥ng b√°o ng·∫Øn g·ªçn
                statusDiv.innerHTML = `<div class="status success">‚úÖ ƒê√£ t·∫£i ${data.length} b·∫£n ghi t·ª´ AppSheet</div>`;
                
                // Hi·ªÉn th·ªã preview d·ªØ li·ªáu
                showDataPreview(data);
                
                // T·ª± ƒë·ªông xu·∫•t Excel sau 800ms
                setTimeout(() => {
                    exportToExcel(data);
                    // X√≥a th√¥ng b√°o sau khi xu·∫•t xong
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 1500);
                }, 800);

            } catch (error) {
                console.error('L·ªói:', error);
                statusDiv.innerHTML = `<div class="status error">‚ùå L·ªói: ${error.message}</div>`;
            } finally {
                exportBtn.disabled = false;
            }
        }

        function showDataPreview(data) {
            const previewDiv = document.getElementById('dataPreview');
            
            if (data.length === 0) {
                previewDiv.innerHTML = '<div class="status">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</div>';
                return;
            }

            // T·∫°o b·∫£ng preview (hi·ªÉn th·ªã t·ªëi ƒëa 10 d√≤ng ƒë·∫ßu)
            const previewData = data.slice(0, 10);
            
            let tableHtml = '<div class="data-preview"><table><thead><tr>';
            FIELDS.forEach(field => {
                tableHtml += `<th>${field}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                tableHtml += '<tr>';
                FIELDS.forEach(field => {
                    const value = row[field] || '';
                    tableHtml += `<td>${String(value).substring(0, 30)}${String(value).length > 30 ? '...' : ''}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table></div>';
            tableHtml += `<p style="text-align: center; margin-top: 15px; color: #666; font-size: 16px;">Hi·ªÉn th·ªã ${previewData.length} / ${data.length} b·∫£n ghi ƒë·∫ßu ti√™n</p>`;
            
            previewDiv.innerHTML = tableHtml;
        }

        function exportToExcel(data) {
            try {
                // T·∫°o workbook m·ªõi
                const wb = XLSX.utils.book_new();
                
                // T·∫°o header v·ªõi t√™n ti·∫øng Vi·ªát ƒë·∫πp h∆°n
                const headers = [
                    'ID', 'T√™n D·ª•ng C·ª•', 'Ch·ªßng Lo·∫°i', 'D·ª•ng C·ª• ƒêi·ªán T·ª≠', 'S·ªë Series',
                    'Ng√†y Nh·∫≠n D·ª•ng C·ª•', 'T√¨nh Tr·∫°ng D·ª•ng C·ª•', 'Ghi Ch√∫', 'N∆°i Qu·∫£n L√Ω',
                    'V·ªã Tr√≠', 'Ng√†y Ki·ªÉm K√™', 'Tr·∫°ng Th√°i', 'SL OK', 'SL NG', 'C·∫≠p Nh·∫≠t',
                    'M√£ Code', 'H·ªç V√† T√™n', 'H√¨nh ·∫¢nh Ki·ªÉm K√™', 'Ng√†y H·ªßy', 'X√°c Nh·∫≠n D·ª•ng C·ª• L·ªói',
                    'Duy·ªát', 'ID L·ªãch S·ª≠ M∆∞·ª£n Tr·∫£'
                ];
                
                // Chu·∫©n b·ªã d·ªØ li·ªáu cho worksheet
                const wsData = [];
                
                // Th√™m ti√™u ƒë·ªÅ ch√≠nh
                const mainTitle = ['DANH S√ÅCH D·ª§NG C·ª§'];
                const emptyRow = [''];
                const dateInfo = [`Ng√†y xu·∫•t: ${new Date().toLocaleString('vi-VN')}`];
                const totalInfo = [`T·ªïng s·ªë b·∫£n ghi: ${data.length}`];
                
                wsData.push(mainTitle);
                wsData.push(emptyRow);
                wsData.push(dateInfo);
                wsData.push(totalInfo);
                wsData.push(emptyRow);
                wsData.push(headers);
                
                // Th√™m d·ªØ li·ªáu
                data.forEach(row => {
                    const rowData = FIELDS.map(field => {
                        let value = row[field] || '';
                        // Format ng√†y th√°ng n·∫øu c√≥
                        if (field.includes('ngay') && value) {
                            try {
                                const date = new Date(value);
                                if (!isNaN(date.getTime())) {
                                    value = date.toLocaleDateString('vi-VN');
                                }
                            } catch (e) {
                                // Gi·ªØ nguy√™n gi√° tr·ªã n·∫øu kh√¥ng parse ƒë∆∞·ª£c
                            }
                        }
                        return value;
                    });
                    wsData.push(rowData);
                });
                
                // T·∫°o worksheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // ƒê·ªãnh d·∫°ng ƒë·ªô r·ªông c·ªôt theo n·ªôi dung
                const colWidths = [
                    { wch: 8 },   // ID
                    { wch: 25 },  // T√™n D·ª•ng C·ª•
                    { wch: 15 },  // Ch·ªßng Lo·∫°i
                    { wch: 12 },  // D·ª•ng C·ª• ƒêi·ªán T·ª≠
                    { wch: 15 },  // S·ªë Series
                    { wch: 18 },  // Ng√†y Nh·∫≠n
                    { wch: 20 },  // T√¨nh Tr·∫°ng
                    { wch: 30 },  // Ghi Ch√∫
                    { wch: 20 },  // N∆°i Qu·∫£n L√Ω
                    { wch: 15 },  // V·ªã Tr√≠
                    { wch: 15 },  // Ng√†y Ki·ªÉm K√™
                    { wch: 12 },  // Tr·∫°ng Th√°i
                    { wch: 8 },   // SL OK
                    { wch: 8 },   // SL NG
                    { wch: 18 },  // C·∫≠p Nh·∫≠t
                    { wch: 12 },  // M√£ Code
                    { wch: 20 },  // H·ªç V√† T√™n
                    { wch: 20 },  // H√¨nh ·∫¢nh
                    { wch: 15 },  // Ng√†y H·ªßy
                    { wch: 22 },  // X√°c Nh·∫≠n L·ªói
                    { wch: 10 },  // Duy·ªát
                    { wch: 20 }   // ID L·ªãch S·ª≠
                ];
                ws['!cols'] = colWidths;
                
                // ƒê·ªãnh d·∫°ng merge cells cho ti√™u ƒë·ªÅ ch√≠nh
                const range = XLSX.utils.decode_range(ws['!ref']);
                ws['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } }, // Merge ti√™u ƒë·ªÅ ch√≠nh
                    { s: { r: 2, c: 0 }, e: { r: 2, c: 3 } }, // Merge ng√†y xu·∫•t
                    { s: { r: 3, c: 0 }, e: { r: 3, c: 3 } }  // Merge t·ªïng s·ªë b·∫£n ghi
                ];
                
                // ƒê·ªãnh d·∫°ng style cho c√°c cell
                const headerRowIndex = 5; // D√≤ng header th·ª±c t·∫ø
                
                // Style cho ti√™u ƒë·ªÅ ch√≠nh
                if (ws['A1']) {
                    ws['A1'].s = {
                        font: { bold: true, size: 16, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "4472C4" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }
                
                // Style cho th√¥ng tin ng√†y v√† t·ªïng s·ªë
                if (ws['A3']) {
                    ws['A3'].s = {
                        font: { bold: true, italic: true, color: { rgb: "666666" } }
                    };
                }
                if (ws['A4']) {
                    ws['A4'].s = {
                        font: { bold: true, italic: true, color: { rgb: "666666" } }
                    };
                }
                
                // Style cho header
                for (let col = 0; col < headers.length; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: headerRowIndex, c: col });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "70AD47" } },
                            alignment: { horizontal: "center", vertical: "center" },
                            border: {
                                top: { style: "thin" },
                                bottom: { style: "thin" },
                                left: { style: "thin" },
                                right: { style: "thin" }
                            }
                        };
                    }
                }
                
                // Style cho d·ªØ li·ªáu (zebra striping)
                for (let row = headerRowIndex + 1; row < wsData.length; row++) {
                    const isEvenRow = (row - headerRowIndex) % 2 === 0;
                    for (let col = 0; col < headers.length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (ws[cellAddress]) {
                            ws[cellAddress].s = {
                                fill: { fgColor: { rgb: isEvenRow ? "F2F2F2" : "FFFFFF" } },
                                border: {
                                    top: { style: "thin", color: { rgb: "D0D0D0" } },
                                    bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                    left: { style: "thin", color: { rgb: "D0D0D0" } },
                                    right: { style: "thin", color: { rgb: "D0D0D0" } }
                                },
                                alignment: { vertical: "center" }
                            };
                        }
                    }
                }
                
                // Th√™m worksheet v√†o workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Danh S√°ch D·ª•ng C·ª•');
                
                // T·∫°o t√™n file v·ªõi timestamp ƒë·∫πp h∆°n
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10);
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
                const filename = `DanhSach_DungCu_${dateStr}_${timeStr}.xlsx`;
                
                // Xu·∫•t file
                XLSX.writeFile(wb, filename);
                
                // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o chi ti·∫øt, ch·ªâ log ƒë·ªÉ debug
                console.log(`ƒê√£ xu·∫•t file: ${filename} v·ªõi ${data.length} b·∫£n ghi`);
                
            } catch (error) {
                console.error('L·ªói xu·∫•t Excel:', error);
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `<div class="status error">‚ùå L·ªói xu·∫•t Excel: ${error.message}</div>`;
            }
        }

        function clearStatus() {
            document.getElementById('status').innerHTML = '';
            document.getElementById('dataPreview').innerHTML = '';
            currentData = null;
        }

        // Th√™m th√¥ng tin h∆∞·ªõng d·∫´n khi trang ƒë∆∞·ª£c t·∫£i
        window.onload = function() {
            console.log('AppSheet to Excel Exporter ƒë√£ s·∫µn s√†ng!');
        };
    </script>
</body>
</html>
